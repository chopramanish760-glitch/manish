<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Pulse ‚Äì Campus Events</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%237c3aed;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%233b82f6;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='50' cy='50' r='45' fill='url(%23grad)'/%3E%3Ctext x='50' y='60' font-family='Arial, sans-serif' font-size='40' font-weight='bold' text-anchor='middle' fill='white'%3EP%3C/text%3E%3C/svg%3E">
<link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%237c3aed;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%233b82f6;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='50' cy='50' r='45' fill='url(%23grad)'/%3E%3Ctext x='50' y='60' font-family='Arial, sans-serif' font-size='40' font-weight='bold' text-anchor='middle' fill='white'%3EP%3C/text%3E%3C/svg%3E">
<style>
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  :root {
    color-scheme: dark; --bg: #121212; --surface: #1a1a1a; --border: #333333;
    --text-primary: #f5f5f5; --text-secondary: #a1a1aa;
    --primary-gradient: linear-gradient(90deg, #8A2BE2, #4F46E5);
    --primary-accent: #7c3aed; --green-accent: #10b981; --red-accent: #ef4444;
    --nav-bg: #1e293b; --nav-active: #2563eb;
  }
  * { box-sizing: border-box; }
  body { margin: 0; background: var(--bg); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; color: var(--text-primary); display: flex; align-items: center; justify-content: center; min-height: 100vh; }
  .phone { width: 380px; height: 760px; background: #000; border-radius: 20px; border: 1px solid #222; overflow: hidden; display: flex; flex-direction: column; position: relative; }
  header { height: 56px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; flex-shrink: 0; z-index: 10; background: #000; }
  header .brand { font-weight: bold; font-size: 1.2rem; display: flex; align-items: center; gap: 8px; }
  header .brand::before { content: ''; display: block; width: 12px; height: 12px; border-radius: 50%; background: var(--primary-accent); }
  #userInfo span { font-weight: bold; }
  #userInfo button { background: none; border: none; color: var(--red-accent); font-weight: bold; cursor: pointer; padding: 4px 8px; margin-left: 8px; border-radius: 6px; }
  #userInfo button:hover { background: rgba(239, 68, 68, 0.2); }
  .tabs { position: sticky; bottom: 0; left: 0; right: 0; height: 64px; display: flex; flex-shrink: 0; background-color: #0f172a; padding: 8px; gap: 8px; border-top: 1px solid var(--border); z-index: 15; }
  .tab { flex: 1; display: flex; justify-content: center; align-items: center; cursor: pointer; color: var(--text-secondary); font-weight: 700; letter-spacing: 0.4px; border-radius: 12px; transition: background-color 0.2s ease, color 0.2s ease, transform 0.08s ease; border: 1px solid transparent; }
  .tab:hover { color: var(--text-primary); background: rgba(37, 99, 235, 0.08); }
  .tab:active { transform: translateY(1px); }
  .tab.active { background: rgba(37, 99, 235, 0.18); color: #e5e7eb; border-color: #2563eb; box-shadow: inset 0 0 0 1px rgba(37, 99, 235, 0.25); }
  .content { flex: 1; overflow-y: auto; padding: 24px; display: none; }
  .content h2 { font-size: 1.5rem; margin-top: 0; margin-bottom: 16px; border-bottom: 1px solid var(--border); padding-bottom: 8px;}
  .content h3, .content h4 { font-size: 1.2rem; }
  .content p.muted { color: var(--text-secondary); margin-top: 0; margin-bottom: 40px; }
  #screen-auth, #screen-login { display: flex; flex-direction: column; justify-content: center; text-align: center; }
  .password-wrapper { position: relative; display: flex; align-items: center; }
  .password-wrapper input { padding-right: 45px; }
  .password-toggle { position: absolute; right: 15px; cursor: pointer; user-select: none; color: var(--text-secondary); width: 24px; height: 24px; }
  .password-toggle .eye-open-path { display: block; } .password-toggle .eye-closed-path { display: none; }
  input, select { width: 100%; background: var(--surface); color: var(--text-primary); border: 1px solid var(--border); border-radius: 12px; padding: 14px 16px; margin-bottom: 16px; font-size: 1rem; }
  input::placeholder { color: var(--text-secondary); }
  input:focus, select:focus { outline: none; border-color: var(--primary-accent); }
  input::-ms-reveal { display: none; }
  .btn { border: none; padding: 14px 20px; border-radius: 999px; font-size: 1rem; font-weight: bold; color: var(--text-primary); cursor: pointer; display: block; width: 100%; margin: 8px 0; text-align: center; background: var(--surface); border: 1px solid var(--border); }
  .btn.primary { background: var(--primary-gradient); border: none; }
  .btn.muted { background: none; border: none; color: var(--text-secondary); font-weight: normal; }
  .btn:disabled { opacity: 0.7; cursor: not-allowed; }
  .card { position: relative; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 12px; cursor: pointer; overflow: hidden; }
  .card-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
  .category-badge { position: absolute; top: 12px; right: 40px; background: var(--primary-accent); color: white; padding: 3px 8px; border-radius: 99px; font-size: 0.7rem; font-weight: bold; }
  .info-dot { position:absolute; top:10px; right:12px; width:22px; height:22px; border-radius:50%; border:1px solid var(--border); background:#111; color:#e5e7eb; display:flex; align-items:center; justify-content:center; font-weight:700; cursor:pointer; }
  .modal { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.85); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 10px; }
  .modal-content { background: #1f1f1f; border-radius: 12px; padding: 20px; max-height: 85vh; overflow: auto; width: 90vw; max-width: 520px; }
  .modal-content img, .modal-content video { max-width: 100%; height: auto; border-radius: 8px; }
  .media-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap:10px; }
  .media-item img, .media-item video { width:100%; height:120px; object-fit:cover; display:block; border-radius:8px; }
  @media (max-width: 420px) {
    .modal-content { width: 94vw; padding: 16px; }
    .media-grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); }
  }
  .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); display: none; align-items: center; justify-content: center; z-index: 20; }
  .modal-content { background: #1f1f1f; border-radius: 12px; padding: 20px; max-height: 80%; overflow: auto; width: 90%; }
  .close { float: right; cursor: pointer; color: var(--text-secondary); }
  .profile-details { display: flex; flex-direction: column; gap: 15px; }
  .detail-item { background: var(--surface); padding: 10px 15px; border-radius: 8px; }
  .detail-item label { display: block; font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 4px; }
  .id-card { background: #fff; color: #333; border-radius: 15px; padding: 20px; text-align: center; }
  .id-card-header { border-bottom: 2px solid var(--primary-accent); padding-bottom: 10px; margin-bottom: 15px; }
  .id-card-header h3 { margin: 0; color: #000; }
  .id-card-avatar { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--primary-accent); margin: 0 auto 15px auto; object-fit: cover; background: #eee; }
  .id-card-details p { margin: 5px 0; font-size: 0.9rem; }
  .notification-ticker { position: absolute; top: 56px; left: 0; width: 100%; background: var(--primary-gradient); color: white; padding: 8px 0; font-size: 0.9rem; white-space: nowrap; overflow: hidden; cursor: pointer; z-index: 5; display: none; }
  .notification-ticker p { margin: 0; display: inline-block; padding-left: 100%; animation: scroll-left 15s linear infinite; }
  @keyframes scroll-left { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
  .media-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
  .media-item { position: relative; }
  .media-item img, .media-item video { width: 100%; height: 120px; object-fit: cover; border-radius: 8px; cursor: pointer; }
  .media-item .play-overlay { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; }
  .media-item .play-icon { width: 36px; height: 36px; border-radius: 50%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; border: 2px solid rgba(255,255,255,0.8); }
  .delete-media-btn { position: absolute; top: 4px; right: 4px; background: rgba(0,0,0,0.6); color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; border: 1px solid white; z-index: 5; }
  .event-media-section, .event-list-section { margin-bottom: 24px; }
  .sub-nav { display: flex; gap: 24px; margin-bottom: 24px; border-bottom: none; flex-wrap: wrap; row-gap: 10px; }
  .sub-nav-btn { background: none; border: 1px solid var(--border); color: var(--text-secondary); padding: 8px 16px; font-size: 1rem; cursor: pointer; border-radius: 10px; }
  .sub-nav-btn.active { color: var(--text-primary); border-color: var(--primary-accent); box-shadow: 0 0 0 1px rgba(124,58,237,0.25) inset; font-weight: bold; }
  .section-wrapper { border: 1px solid var(--border); border-radius: 12px; padding: 12px; margin-bottom: 28px; }
  .section-title { margin: 0 0 12px 0; font-weight: bold; color: var(--text-secondary); letter-spacing: .3px; }
  .highlight-border { border-color: var(--primary-accent) !important; box-shadow: 0 0 0 1px rgba(124,58,237,0.25) inset; }
  .kv { display: grid; grid-template-columns: 80px 1fr; gap: 6px 10px; margin: 8px 0; }
  .kv b { color: #93c5fd; }
  .kv .value { color: #e5e7eb; font-weight: 700; }
  .organizer-kv b { color: #fbbf24; }
  .organizer-kv .value { color: #fef3c7; }
  /* Modals are constrained to the .phone container (which is position:relative) */
  #lightbox-modal, #map-modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 100; }
  #lightbox-content { max-width: 95%; max-height: 95%; }
  #lightbox-content img, #lightbox-content video { width: 100%; height: auto; max-height: 80vh; margin-top: 10vh; }
  .lightbox-back-arrow, .map-back-arrow { 
    position: absolute; 
    top: 20px; 
    left: 20px; 
    color: white; 
    font-size: 2.5rem; 
    cursor: pointer; 
    text-decoration: none; 
    z-index: 120; 
    background: rgba(0,0,0,0.6); 
    border-radius: 8px; 
    padding: 8px 12px;
    text-shadow: 0 0 4px black;
  }
  .checkbox-row { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; }
  .checkbox-input { width: auto; margin: 0; vertical-align: middle; accent-color: var(--primary-accent); }
  .checkbox-label { color: var(--text-secondary); font-size: 0.95rem; margin: 0; line-height: 1; display: inline-flex; align-items: center; }
  .chat-composer { display: flex; align-items: center; gap: 8px; background: #0f172a; border: 1px solid var(--border); border-radius: 14px; padding: 8px 10px; }
  .chat-input { flex: 1; background: transparent; border: none; color: var(--text-primary); outline: none; font-size: 1rem; }
  .chat-attach, .chat-send { background: transparent; border: none; color: var(--text-secondary); cursor: pointer; padding: 6px; border-radius: 8px; }
  .chat-attach:hover, .chat-send:hover { background: rgba(255,255,255,0.06); color: var(--text-primary); }
  #map-container { position: relative; width: 100%; height: 100%; overflow: hidden; display: flex; align-items: center; justify-content: center; background: var(--bg); }
  #map-container iframe { width: 100%; height: 100%; border: none; }
  .map-footer { position: absolute; bottom: 0; left: 0; width: 100%; padding: 20px; z-index: 10; }
  .loader-container { display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
  @property --p{ syntax: '<number>'; inherits: true; initial-value: 0; }
  .loader-circle { width: 100px; height: 100px; --p:0; position: relative; display: flex; align-items: center; justify-content: center; animation: load 2s forwards; }
  .loader-circle::before { content: ''; position: absolute; inset: 0; border-radius: 50%; background: conic-gradient(var(--primary-accent) calc(var(--p) * 1%), #0000 0); -webkit-mask: radial-gradient(farthest-side, #0000 calc(100% - 10px), #000 0); mask: radial-gradient(farthest-side, #0000 calc(100% - 10px), #000 0); }
  #loader-percentage { font-size: 1.5rem; font-weight: bold; }
  @keyframes load { from { --p: 0; } to { --p: 100; } }
  /* Leaflet map styling */
  #leaflet-map { width: 100%; height: 100%; z-index: 1; }
  .leaflet-container { background: #1a1a1a; }
</style>
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<!-- Leaflet Routing Machine CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
</head>
<body>
<div class="phone">
  <header><div class="brand">Pulse</div><div id="userInfo"></div></header>
  <div id="notificationTicker" class="notification-ticker" onclick="showTab('notifications')"><p id="notificationTickerText"></p></div>
  <div id="screen-auth" class="content" style="display:block;">
    <h2 style="font-size: 2rem;">Welcome to Pulse</h2><p class="muted">Please login or signup to continue</p>
    <button class="btn primary" onclick="showLogin()">Login</button><button class="btn" onclick="showSignup()">Signup</button>
  </div>
  <div id="screen-login" class="content"></div><div id="screen-signup" class="content"></div>
  <div id="screen-home" class="content"></div><div id="screen-tickets" class="content"></div>
  <div id="screen-media" class="content"></div><div id="screen-notifications" class="content"></div>
  <div id="screen-profile" class="content"></div><div id="screen-organizer" class="content"></div>
  <div class="tabs" id="tabs" style="display:none"></div>
  <div id="modal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal()">‚úñ</span><div id="modal-body"></div></div></div>
  <div id="lightbox-modal" onclick="closeLightbox()"><a class="lightbox-back-arrow" onclick="closeLightbox(event)">‚Üê</a><div id="lightbox-content"></div></div>
  <div id="map-modal"><a class="map-back-arrow" onclick="closeMap()">‚Üê</a><div id="map-container"></div></div>
</div>

<script>
// Configure API base - supports multiple methods
// Method 1: URL parameter (?api=https://backend.com)
// Method 2: localStorage (persists across sessions)
// Method 3: Environment detection (if deployed with backend on same domain)
// Method 4: Default fallback to Render backend
(function(){ 
  try{ 
    const qs=new URLSearchParams(location.search); 
    const api=qs.get('api'); 
    if(api){ 
      localStorage.setItem('API_BASE', api); 
      return;
    }
  }catch(_){}
})();

// Get API base URL
let API_BASE;
if(localStorage.getItem('API_BASE')){
  API_BASE = localStorage.getItem('API_BASE');
} else {
  // Auto-detect: If on Netlify, use Render backend; otherwise try same domain
  const hostname = window.location.hostname;
  if(hostname.includes('netlify.app') || hostname.includes('netlify')){
    // Frontend on Netlify ‚Üí Backend on Render
    API_BASE = "https://manish-5dlg.onrender.com";
  } else if(hostname.includes('github.io') || hostname.includes('vercel')){
    // Frontend on GitHub Pages/Vercel ‚Üí Backend on Render
    API_BASE = "https://manish-5dlg.onrender.com";
  } else {
    // Same domain or localhost - try same origin first, fallback to Render
    if(window.location.protocol === 'file:' || hostname === 'localhost' || hostname === '127.0.0.1'){
      API_BASE = "https://manish-5dlg.onrender.com";
    } else {
      // Same domain deployment - use relative or same origin
      API_BASE = window.location.origin;
    }
  }
}

const API = API_BASE.replace(/\/$/, '') + "/api";
let currentUser = null; let userTickets = []; let notificationInterval = null; let eventStateInterval = null; let countdownInterval = null; let __modalIntervals = {}; let __eventSource = null; let keepAliveInterval = null;


let welcomeBannerUntil = 0;
let lastUpcomingCount = -1;
let currentHomeView = 'upcoming'; let currentMediaView = 'upcoming';

// Persistent login functions
function saveUserSession(user) {
    localStorage.setItem('pulse_user', JSON.stringify(user));
}

function loadUserSession() {
    const savedUser = localStorage.getItem('pulse_user');
    if (savedUser) {
        try {
            return JSON.parse(savedUser);
        } catch (error) {
            console.error('Error parsing saved user:', error);
            localStorage.removeItem('pulse_user');
            return null;
        }
    }
    return null;
}

function clearUserSession() {
    localStorage.removeItem('pulse_user');
}

// Keep-alive function to prevent backend from sleeping
async function keepBackendAlive() {
    try {
        // Use keepalive endpoint which logs the ping
        const response = await fetch(`${API_BASE}/keepalive`);
        if (response.ok) {
            const data = await response.json();
            console.log('‚úÖ Backend keep-alive ping successful:', data.timestamp);
        } else {
            // Fallback to healthz if keepalive fails
            const healthResponse = await fetch(`${API_BASE}/healthz`);
            if (healthResponse.ok) {
                console.log('‚úÖ Backend health check successful (fallback)');
            } else {
                console.warn('‚ö†Ô∏è Backend keep-alive ping failed');
            }
        }
    } catch (error) {
        console.warn('‚ö†Ô∏è Backend keep-alive error:', error.message);
    }
}

// Start keep-alive polling (every 2 minutes to keep backend active)
function startKeepAlive() {
    keepBackendAlive(); // Initial ping
    keepAliveInterval = setInterval(keepBackendAlive, 120000); // Every 2 minutes
    console.log('üîÑ Keep-alive polling started');
}

// Stop keep-alive polling
function stopKeepAlive() {
    if (keepAliveInterval) {
        clearInterval(keepAliveInterval);
        keepAliveInterval = null;
        console.log('‚èπÔ∏è Keep-alive polling stopped');
    }
}

// Auto-login on page load
function checkSavedLogin() {
    const savedUser = loadUserSession();
    if (savedUser) {
        currentUser = savedUser;
        renderTabs();
        render();
        showTab("home");
        renderTickets(true);
        pollNotifications();
        notificationInterval = setInterval(pollNotifications, 5000);
        eventStateInterval = setInterval(checkEventStates, 30000);
        // Start event start notifications checker
        setInterval(checkEventStartNotifications, 60000); // Check every minute
        // Show welcome back banner
        showWelcomeBanner(`üëã Welcome back, ${savedUser.name}!`);
    } else {
        showTab("auth");
    }
}

// ---------- Navigation & Core UI ----------
function showTab(tab) {
    document.querySelectorAll(".content").forEach(c => c.style.display = "none");
    const tabsContainer = document.getElementById("tabs");
    if (["home", "tickets", "media", "organizer", "notifications", "profile", "admin"].includes(tab)) {
        tabsContainer.style.display = "flex";
        tabsContainer.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        const tabName = tab === 'notifications' ? 'üîî' : tab;
        const activeTab = Array.from(tabsContainer.querySelectorAll('.tab')).find(t => t.getAttribute('data-tab') === tabName);
        if (activeTab) activeTab.classList.add('active');
    } else { tabsContainer.style.display = "none"; }
    // Ensure admin screen exists under the same container as other screens
    if (tab === 'admin' && !document.getElementById('screen-admin')) {
        try{
            const parent = document.querySelector('.phone') || document.body;
            const root = document.createElement('div'); root.id='screen-admin'; root.className='content'; parent.insertBefore(root, document.getElementById('tabs'));
        }catch{}
    }
    const screen = document.getElementById("screen-" + tab);
    if (screen) {
        if (tab === 'login' || tab === 'auth') {
            screen.style.display = 'flex';
            document.getElementById('notificationTicker').style.display = 'none';
        } else { screen.style.display = 'block'; }
    }
    if (tab === 'notifications') { document.getElementById('notificationTicker').style.display = 'none'; } else { pollNotifications(); }
    if (tab === "home") { 
        // Clear events cache to force fresh data
        window.__eventsCache = null;
        renderTickets(true); // Refresh userTickets array
        renderEvents(); 
    }
    if (tab === "tickets") renderTickets(); 
    if (tab === "media") renderMedia();
    if (tab === "notifications") renderNotifications(); if (tab === "organizer") renderOrganizer(); if (tab === "profile") renderProfile(); if (tab === 'admin') renderAdmin();
    render();
}

function showOrganizerPending() {
    alert("Your organizer request is pending approval. You'll be notified when it's reviewed.");
}

function renderTabs() {
    const tabs = document.getElementById("tabs");
    if (!tabs) return;
    const isAdmin = !!window.__isAdmin;
    if (isAdmin) {
        tabs.innerHTML = `
        <div class="tab" data-tab="admin" onclick="showTab('admin')">Admin</div>`;
        return;
    }
    tabs.innerHTML = `
    <div class="tab" data-tab="home" onclick="showTab('home')">Home</div>
    <div class="tab" data-tab="tickets" onclick="showTab('tickets')">Tickets</div>
    <div class="tab" data-tab="media" onclick="showTab('media')">Media</div>
    <div class="tab" data-tab="üîî" onclick="showTab('notifications')">üîî</div>
    ${(currentUser && currentUser.role === "ORGANIZER") ? `<div class="tab" data-tab="organizer" onclick="showTab('organizer')">Org</div>` : (currentUser && currentUser.organizerStatus === 'PENDING') ? `<div class="tab" data-tab="organizer" onclick="showOrganizerPending()" style="opacity: 0.6; cursor: not-allowed;">Org</div>` : ""}
    <div class="tab" data-tab="profile" onclick="showTab('profile')">You</div>`;
}
function render() {
    const userInfo = document.getElementById("userInfo");
    if (currentUser) {
        const name = currentUser.name.charAt(0).toUpperCase() + currentUser.name.slice(1);
        const role = currentUser.role === 'ORGANIZER' ? 'O' : 'S';
        userInfo.innerHTML = `<span>${name} (${role})</span> <button onclick="logout()">Logout</button>`;
    } else {
        userInfo.innerHTML = "";
    }
}
function logout() { 
    currentUser = null; 
    clearUserSession(); // Clear saved session
    clearInterval(notificationInterval); 
    clearInterval(eventStateInterval); 
    clearInterval(countdownInterval);
    stopKeepAlive(); // Stop keep-alive when logged out
    notificationInterval = null; 
    eventStateInterval = null; 
    countdownInterval = null; 
    userTickets = []; 
    document.getElementById("notificationTicker").style.display = "none"; 
    showTab("auth"); 
    renderTabs(); 
    render();
    // Restart keep-alive for non-logged-in state
    startKeepAlive();
}
function closeModal() { document.getElementById("modal").style.display = "none"; try{ Object.values(__modalIntervals).forEach(id=>{ try{ clearInterval(id); }catch{} }); __modalIntervals = {}; }catch{} }
function startModalPoll(key, fn, ms){ try{ if(__modalIntervals[key]){ clearInterval(__modalIntervals[key]); } __modalIntervals[key] = setInterval(()=>{ try{ fn(); }catch{} }, ms||3000); }catch{} }

// ---------- Chat (Student & Organizer) ----------
function openEventChat(eventId, title, organizerReg){
    const body = document.getElementById('modal-body');
    body.innerHTML = `
        <div class="chat-container" style="height:75%; display:flex; flex-direction:column; overflow:hidden">
          <h3 style="margin-top:0">üí¨ Chat ‚Äì ${capitalizeWords(title)}</h3>
          <div id="chatThread" style="flex:1; overflow-y:auto; overflow-x:hidden; background: #111; padding:10px; border-radius:8px; border:1px solid var(--border); margin-bottom:10px"></div>
          <div class="chat-composer">
              <input id="chatInput" class="chat-input" placeholder="Message" onkeydown="if(event.key==='Enter'){sendChatMessage(${eventId}, '${organizerReg}')}" />
              <input type="file" id="chatFile" accept="image/*,video/*" style="display:none" onchange="sendChatMedia(${eventId}, '${organizerReg}')">
              <button class="chat-attach" title="Attach" onclick="document.getElementById('chatFile').click()">üìé</button>
              <button class="chat-send" title="Send" onclick="sendChatMessage(${eventId}, '${organizerReg}')">‚û§</button>
          </div>
          <div id="chatMsg" class="muted" style="margin:6px 0;"></div>
          <div style="display:flex; justify-content:flex-end;"><button class="btn" style="width:auto" onclick="closeModal()">Back</button></div>
        </div>
    `;
    document.getElementById('modal').style.display = 'flex';
    loadChatThread(eventId, currentUser.regNumber, organizerReg);
    startModalPoll(`chat-${eventId}-${currentUser.regNumber}-${organizerReg}`, ()=>loadChatThread(eventId, currentUser.regNumber, organizerReg), 3000);
}

async function openVolunteerConfirm(eventId){
    const modal = document.getElementById('modal');
    const body = document.getElementById('modal-body');
    let titleSafe = 'this event';
    let role = 'Volunteer';
    let hasPending = true;
    try{
        let e = (window.__eventsCache||[]).find(x=> x.id === eventId);
        if(!e){ const res = await fetch(API + '/events'); if(res.ok){ const data = await res.json(); e = (data.events||[]).find(x=> x.id === eventId); } }
        if(e){ titleSafe = String(e.title||'this event'); const req = Array.isArray(e.volunteerRequests) ? e.volunteerRequests.find(r=> r.regNumber === currentUser.regNumber && r.status === 'pending') : null; if(req){ role = req.role || role; } else { hasPending = false; } }
    }catch(_){}
    body.innerHTML = `
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;"><a class="map-back-arrow" onclick="closeModal()">‚Üê</a><h3 style="margin:0;">Volunteer</h3></div>
        ${hasPending ? `<p>The organizer wants you to volunteer for '${escapeHtml(titleSafe)}' as <b>${escapeHtml(role)}</b>.</p>` : `<p class=\"muted\">No pending volunteer request for this event.</p>`}
        ${hasPending ? `<div style=\"display:flex; gap:10px; margin-top:10px;\"><button class=\"btn primary\" onclick=\"respondVolunteer(${eventId}, 'accept')\">Accept</button><button class=\"btn\" onclick=\"respondVolunteer(${eventId}, 'reject')\">Reject</button></div>` : ''}
        <div id="volConfirmMsg" class="muted" style="margin-top:8px;"></div>
    `;
    modal.style.display = 'flex';
}
async function respondVolunteer(eventId, decision){
    const msg = document.getElementById('volConfirmMsg');
    msg.textContent = 'Processing...';
    try{
        const res = await fetch(API + '/volunteers/respond', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ eventId, regNumber: currentUser.regNumber, decision }) });
        const data = await res.json();
        if(res.ok && data.ok){
            msg.textContent = decision==='accept' ? '‚úÖ Accepted' : '‚úÖ Rejected';
            // Refresh events to update button visibility and volunteer state instantly
            setTimeout(()=>{ closeModal(); renderEvents(); }, 400);
        } else {
            msg.textContent = '‚ùå ' + (data.error || 'Failed');
        }
    }catch(err){ msg.textContent = '‚ùå Network error'; }
}

async function loadChatThread(eventId, regA, regB){
    try{
        const res = await fetch(`${API}/messages/thread?eventId=${eventId}&regA=${regA}&regB=${regB}`);
        const data = await res.json();
        const thread = document.getElementById('chatThread');
        if(!res.ok || !data.ok){ thread.innerHTML = '<p class="muted">No messages.</p>'; return; }
        if(!data.messages || data.messages.length===0){ thread.innerHTML = '<p class="muted">No messages.</p>'; return; }
        const isOrganizer = currentUser && currentUser.role === 'ORGANIZER';
        thread.innerHTML = data.messages.map(m => {
            const mine = m.fromReg === currentUser.regNumber;
            const canDelete = mine || isOrganizer;
            const deleteBtn = canDelete ? `<button onclick="deleteChatMessage(${m.id})" style="background:none; border:none; color:#ef4444; cursor:pointer; font-size:12px; margin-left:5px;" title="Delete">üóëÔ∏è</button>` : '';
            
            if(m.type==='media'){
                // Handle Cloudinary URLs (full HTTPS URLs) and legacy relative paths
                let mediaUrl = m.url;
                if (m.url && !m.url.startsWith('http://') && !m.url.startsWith('https://')) {
                    // Legacy relative path - add API_BASE prefix
                    mediaUrl = m.url.startsWith('/') ? `${API_BASE}${m.url}` : `${API_BASE}/${m.url}`;
                }
                // Use the URL directly for lightbox (showLightbox handles all formats)
                const lightboxUrl = m.url; // Pass original URL, lightbox function handles it
                
                if(m.mediaType==='photo'){
                    return `<div style="text-align:${mine?'right':'left'}; margin:6px 0; position:relative;">
                        <div style="display:inline-block; padding:8px 12px; border-radius:10px; background:${mine?'#2563eb':'#374151'}; color:white; cursor:pointer;" onclick="showLightbox('${lightboxUrl}','photo')">
                            üì∑ Image
                        </div>
                        <div class="muted" style="font-size:0.75rem;">${new Date(m.time).toLocaleTimeString()} ${deleteBtn}</div>
                    </div>`;
                } else {
                    return `<div style="text-align:${mine?'right':'left'}; margin:6px 0; position:relative;">
                        <div style="display:inline-block; padding:8px 12px; border-radius:10px; background:${mine?'#2563eb':'#374151'}; color:white; cursor:pointer;" onclick="showLightbox('${lightboxUrl}','video')">
                            üé• Video
                        </div>
                        <div class="muted" style="font-size:0.75rem;">${new Date(m.time).toLocaleTimeString()} ${deleteBtn}</div>
                    </div>`;
                }
            }
            return `<div style="text-align:${mine?'right':'left'}; margin:6px 0;">
                <span style="display:inline-block; padding:8px 10px; border-radius:10px; background:${mine?'#2563eb':'#374151'}; color:white; max-width:80%; word-break:break-word;">${m.text}</span>
                <div class="muted" style="font-size:0.75rem;">${new Date(m.time).toLocaleTimeString()} ${deleteBtn}</div>
            </div>`;
        }).join('');
        thread.scrollTop = thread.scrollHeight;
    }catch(err){
        document.getElementById('chatThread').innerHTML = '<p class="muted">No messages.</p>';
    }
}

async function sendChatMessage(eventId, organizerReg){
    const input = document.getElementById('chatInput');
    const msgBar = document.getElementById('chatMsg');
    const text = (input.value||'').trim();
    if(!text){ msgBar.textContent = 'Type a message'; return; }
    // Optimistic append
    const thread = document.getElementById('chatThread');
    thread.innerHTML += `<div style="text-align:right; margin:6px 0;"><span style="display:inline-block; padding:8px 10px; border-radius:10px; background:#2563eb; color:white; max-width:80%;">${text}</span><div class="muted" style="font-size:0.75rem;">sending‚Ä¶</div></div>`;
    thread.scrollTop = thread.scrollHeight;
    input.value = '';
    try{
        const res = await fetch(API + '/messages', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ eventId, fromReg: currentUser.regNumber, toReg: organizerReg, text }) });
        const data = await res.json();
        if(res.ok && data.ok){
            msgBar.textContent = '‚úÖ Message sent';
            setTimeout(()=> msgBar.textContent = '', 1200);
            loadChatThread(eventId, currentUser.regNumber, organizerReg);
        }else{
            msgBar.textContent = '‚ùå ' + (data.error || 'Failed to send');
        }
    }catch(err){ msgBar.textContent = '‚ùå Network error'; }
}

async function deleteChatMessage(messageId){
    if(!confirm('Are you sure you want to delete this message permanently? This action cannot be undone.')){
        return;
    }
    
    try{
        const res = await fetch(`${API}/messages/${messageId}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ regNumber: currentUser.regNumber })
        });
        const data = await res.json();
        
        if(res.ok && data.ok){
            // Refresh the chat thread
            const eventId = document.querySelector('.chat-container h3')?.textContent?.match(/Chat ‚Äì (.+)/)?.[1];
            if(eventId){
                const organizerReg = document.querySelector('.chat-container')?.getAttribute('data-organizer');
                if(organizerReg){
                    loadChatThread(eventId, currentUser.regNumber, organizerReg);
                }
            }
        } else {
            alert('Failed to delete message: ' + (data.error || 'Unknown error'));
        }
    } catch(err){
        alert('Network error while deleting message');
    }
}

async function sendChatMedia(eventId, organizerReg){
    const fileInput = document.getElementById('chatFile');
    const msgBar = document.getElementById('chatMsg');
    if(!fileInput.files || fileInput.files.length===0){ msgBar.textContent = 'Select an image or video (max 10MB)'; return; }
    const file = fileInput.files[0];
    if(file.size > 10*1024*1024){ msgBar.textContent = '‚ùå File too large (max 10MB)'; return; }
    const thread = document.getElementById('chatThread');
    // Optimistic preview
    if(file.type.startsWith('image/')){
        thread.innerHTML += `<div style="text-align:right; margin:6px 0;">
            <div style="display:inline-block; padding:8px 12px; border-radius:10px; background:#2563eb; color:white;">
                üì∑ Image
            </div>
            <div class="muted" style="font-size:0.75rem;">uploading‚Ä¶</div>
        </div>`;
    } else if(file.type.startsWith('video/')){
        thread.innerHTML += `<div style="text-align:right; margin:6px 0;">
            <div style="display:inline-block; padding:8px 12px; border-radius:10px; background:#2563eb; color:white;">
                üé• Video
            </div>
            <div class="muted" style="font-size:0.75rem;">uploading‚Ä¶</div>
        </div>`;
    }
    thread.scrollTop = thread.scrollHeight;
    try{
        const form = new FormData();
        form.append('file', file);
        form.append('eventId', String(eventId));
        form.append('fromReg', currentUser.regNumber);
        form.append('toReg', organizerReg);
        const res = await fetch(API + '/messages/media', { method: 'POST', body: form });
        const data = await res.json();
        if(res.ok && data.ok){ msgBar.textContent = '‚úÖ Media sent'; setTimeout(()=> msgBar.textContent='', 1200); loadChatThread(eventId, currentUser.regNumber, organizerReg); }
        else { msgBar.textContent = '‚ùå ' + (data.error || 'Failed to send media'); }
    }catch(err){ msgBar.textContent = '‚ùå Network error'; }
}

// ---------- Home & Media Pages ----------
let currentSearchQuery = '';
let currentDateFilter = 'all';
let currentSortOrder = 'upcoming';

function setHomeView(view) { currentHomeView = view; renderEvents(); }
function setMediaView(view) { currentMediaView = view; renderMedia(); }

function toggleEventSearch() {
    const searchSection = document.getElementById('search-filter-section');
    if (searchSection.style.display === 'none') {
        searchSection.style.display = 'block';
    } else {
        searchSection.style.display = 'none';
    }
}

function applyEventFilters() {
    const searchQuery = document.getElementById('eventSearch').value.toLowerCase();
    const dateFilter = document.getElementById('dateFilter').value;
    const sortOrder = document.getElementById('sortOrder').value;
    
    currentSearchQuery = searchQuery;
    currentDateFilter = dateFilter;
    currentSortOrder = sortOrder;
    
    renderEvents();
}

function clearEventSearch() {
    currentSearchQuery = '';
    const input = document.getElementById('eventSearch');
    if (input) input.value = '';
    const section = document.getElementById('search-filter-section');
    if (section) section.style.display = 'none';
    renderEvents();
}

async function renderEvents() {
    if (countdownInterval) clearInterval(countdownInterval);
    
    // Get events data - cache temporarily disabled
    const res = await fetch(API + "/events"); 
    const eventsData = await res.json();
    window.__eventsCache = (eventsData && eventsData.events) || [];
    
    if (!eventsData.ok || !eventsData.events || eventsData.events.length === 0) { 
        console.log("‚ùå No events found:", eventsData);
        const c = document.getElementById("screen-home");
        c.innerHTML = `<p class="muted">üìå No events found.</p>`; 
        return; 
    }
    
    console.log("‚úÖ Events loaded:", eventsData.events.length, "events");
    
    const c = document.getElementById("screen-home");
    c.innerHTML = `
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <button class="btn" onclick="toggleEventSearch()">üîç Search</button>
            <button class="btn" onclick="refreshEvents()">üîÑ Refresh</button>
            ${currentSearchQuery ? `<button class="btn" onclick="clearEventSearch()">‚¨Ö Back</button>` : ''}
        </div>
        <div id="search-filter-section" class="search-filter-section" style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 15px; display: none;">
            <h3 style="margin: 0 0 10px 0; color: var(--text-primary);">Search</h3>
            <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                <input id="eventSearch" type="text" placeholder="Search by title, venue, or category..." 
                       style="flex: 1; min-width: 200px; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg-primary); color: var(--text-primary);"
                       value="${currentSearchQuery}">
                <select id="dateFilter" 
                        style="padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg-primary); color: var(--text-primary);">
                    <option value="all" ${currentDateFilter === 'all' ? 'selected' : ''}>All Events</option>
                    <option value="today" ${currentDateFilter === 'today' ? 'selected' : ''}>Today</option>
                    <option value="week" ${currentDateFilter === 'week' ? 'selected' : ''}>This Week</option>
                </select>
                <select id="sortOrder" 
                        style="padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg-primary); color: var(--text-primary);">
                    <option value="upcoming" ${currentSortOrder === 'upcoming' ? 'selected' : ''}>Upcoming First</option>
                    <option value="past" ${currentSortOrder === 'past' ? 'selected' : ''}>Past First</option>
                </select>
                <button class="btn" onclick="applyEventFilters()">üîç Search</button>
                <button class="btn" onclick="clearEventSearch()">‚¨Ö Back</button>
            </div>
        </div>
        <div class="sub-nav">
            <button class="sub-nav-btn ${currentHomeView === 'upcoming' ? 'active' : ''}" onclick="setHomeView('upcoming')">Upcoming & Live</button>
            <button class="sub-nav-btn ${currentHomeView === 'past' ? 'active' : ''}" onclick="setHomeView('past')">Past</button>
        </div>
        <div id="home-content"></div>`;
    
    const homeContent = document.getElementById('home-content');
    const currentDate = new Date();
    
    // Apply search and date filters
    let filteredEvents = eventsData.events.filter(e => {
        const titleLc = String(e.title || '').toLowerCase();
        const venueLc = String(e.venue || '').toLowerCase();
        const categoryLc = String(e.category || '').toLowerCase();
        const matchesSearch = !currentSearchQuery || 
            titleLc.includes(currentSearchQuery) ||
            venueLc.includes(currentSearchQuery) ||
            categoryLc.includes(currentSearchQuery);
        
        if (!matchesSearch) return false;
        
        const eventDate = new Date(e.date);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        if (currentDateFilter === 'today') {
            const todayStr = today.toISOString().split('T')[0];
            const eventDateStr = eventDate.toISOString().split('T')[0];
            return eventDateStr === todayStr;
        } else if (currentDateFilter === 'week') {
            const weekEnd = new Date(today);
            weekEnd.setDate(today.getDate() + 7);
            return eventDate >= today && eventDate <= weekEnd;
        }
        return true; // 'all'
    });
    
    const upcomingEvents = filteredEvents.filter(e => new Date(parseEventDateTime(e.date, e.time).getTime() + (e.duration || 0) * 60000) >= currentDate);
    const pastEvents = filteredEvents.filter(e => new Date(parseEventDateTime(e.date, e.time).getTime() + (e.duration || 0) * 60000) < currentDate);
    
    console.log("üîç DEBUG - Filtered events:", filteredEvents.length);
    console.log("üîç DEBUG - Upcoming events:", upcomingEvents.length);
    console.log("üîç DEBUG - Past events:", pastEvents.length);
    console.log("üîç DEBUG - Current date:", currentDate);
    console.log("üîç DEBUG - Current home view:", currentHomeView);
    console.log("üîç DEBUG - All events:", filteredEvents);
    
    // Apply sorting
    if (currentSortOrder === 'upcoming') {
        upcomingEvents.sort((a,b) => parseEventDateTime(a.date, a.time) - parseEventDateTime(b.date, b.time));
        pastEvents.sort((a,b) => parseEventDateTime(b.date, b.time) - parseEventDateTime(a.date, a.time));
    } else {
        pastEvents.sort((a,b) => parseEventDateTime(b.date, b.time) - parseEventDateTime(a.date, a.time));
        upcomingEvents.sort((a,b) => parseEventDateTime(a.date, a.time) - parseEventDateTime(b.date, b.time));
    }
    const sectionEl = document.createElement('div');
    sectionEl.className = 'section-wrapper ' + (currentHomeView === 'past' ? 'highlight-border' : '');
    const sectionTitle = document.createElement('h4');
    sectionTitle.className = 'section-title';
    const resultCount = currentHomeView === 'past' ? pastEvents.length : upcomingEvents.length;
    sectionTitle.textContent = currentHomeView === 'past' ? `Past Events (${resultCount})` : `Upcoming & Live Events (${resultCount})`;
    sectionEl.appendChild(sectionTitle);
    homeContent.appendChild(sectionEl);

    if (currentHomeView === 'upcoming') {
        if (upcomingEvents.length === 0) { sectionEl.innerHTML += `<p class="muted">No upcoming or live events right now.</p>`; }
        else {
            upcomingEvents.forEach(e => {
                const bookedByMe = currentUser && Array.isArray(e.bookings) && e.bookings.some(b => b.regNumber === currentUser.regNumber);
                const isOnWaitlist = currentUser && Array.isArray(e.waitlist) && e.waitlist.some(w => w.regNumber === currentUser.regNumber);
                // Only consider it "booked" if user has a confirmed booking, not if they're on waitlist
                const isBooked = bookedByMe || (currentUser && userTickets.some(t => t.eventId === e.id && !t.waiting));
                const isFull = e.taken >= e.capacity;
                const isVolunteer = currentUser && Array.isArray(e.volunteers) && e.volunteers.some(v => v.regNumber === currentUser.regNumber);
                const isCreator = currentUser && e.creatorRegNumber === currentUser.regNumber;
                const div = document.createElement("div"); div.className = "card";
                const startTime = parseEventDateTime(e.date, e.time);
                const isEventLive = new Date() >= startTime;
                const statusElementId = `countdown-${e.id}`;
                div.innerHTML = `
                    <div class="category-badge">${e.category}</div>
                    <b style="font-size:1.05rem;color:#93c5fd;">${capitalizeWords(e.title)}</b>
                    <div class="kv">
                        <b>Venue:</b> <span class="value">${capitalizeWords(e.venue)}</span>
                        <b>Date:</b> <span class="value">${e.date}</span>
                        <b>Time:</b> <span class="value">${e.time}</span>
                        <b>Seats:</b> <span class="value">${e.taken}/${e.capacity}</span>
                        <b>Availability:</b> <span class="value" style="color:${isFull ? '#ef4444' : '#10b981'}">${isFull ? 'Venue Full' : 'Available'}</span>
                        <b>Status:</b> <span class="value" id="${statusElementId}" data-start-time="${startTime.toISOString()}"></span>
                    </div>`;
                const chatButton = (isBooked || isVolunteer || isOnWaitlist) ? `<button class="btn" onclick="openEventChat(${e.id}, '${e.title}', '${e.creatorRegNumber}')">üí¨ Chat</button>` : '';
                const volunteerObj = isVolunteer ? (e.volunteers.find(v => v.regNumber === currentUser.regNumber) || {}) : null;
                const volunteerCardBtn = isVolunteer
                    ? `<button class="btn" onclick="openVolunteerIdCard(${e.id})">ü™™ Show Volunteer ID Card</button><button class="btn" onclick="leaveVolunteer(${e.id})">üö™ Cancel Volunteer</button>`
                    : '';
                const bookButton = isVolunteer
                    ? `<button class="btn" disabled style="border-color: var(--green-accent); color: var(--green-accent);">‚úì Volunteer</button>`
                    : isCreator
                        ? `<button class="btn" disabled>Your Event</button>`
                        : isOnWaitlist
                            ? (isEventLive 
                                ? `<button class="btn" disabled style="border-color: var(--orange-accent); color: var(--orange-accent); opacity: 0.5;">Event Live - Cannot Leave</button>`
                                : `<button class="btn" style="border-color: var(--orange-accent); color: var(--orange-accent);" onclick="leaveWaitlist(${e.id})">Leave Waitlist</button>`)
                            : isBooked
                                ? `<button class="btn" disabled style="background: var(--green-accent); border-color: var(--green-accent);">‚úì Booked</button>`
                        : isFull
                            ? (isEventLive
                                ? `<button class="btn" disabled style="border-color: var(--red-accent); color: var(--red-accent); opacity: 0.5;">Event Live - Venue Full</button>`
                                : `<div style="display:flex; gap:8px; width:100%">
                                   <button class="btn" disabled style="border-color: var(--red-accent); color: var(--red-accent); flex:1;">Venue Full</button>
                                   <button class="btn" style="flex:1;" onclick="joinWaitlist(${e.id})">Join Waitlist</button>
                                   </div>`)
                            : (isEventLive
                                ? `<button class="btn" disabled style="opacity: 0.5;">Event Live - Cannot Book</button>`
                                : `<button class="btn primary" onclick="bookTicket(${e.id})">Book Ticket</button>`);
                const mapButton = `<button class="btn" onclick="showMapModal('${e.venue}')">üìç View on Map</button>`;
                const qrButton = `<button class="btn" onclick="openQrModal(${e.id})">üî≥ Show QR</button>`;
                // Show confirmation CTA only if organiser requested this user for a role and it's pending
                const hasPendingVolunteerInvite = Array.isArray(e.volunteerRequests) && e.volunteerRequests.some(r => r.regNumber === currentUser.regNumber && r.status === 'pending');
                const confirmVolunteerBtn = (!isVolunteer && !isCreator && hasPendingVolunteerInvite) ? `<button class="btn primary" onclick="openVolunteerConfirm(${e.id})">Confirm Volunteer</button>` : '';
                // Render confirm button only once here
                div.innerHTML += `<div class="card-buttons">${volunteerCardBtn}${bookButton}${mapButton}${qrButton}${confirmVolunteerBtn}</div>`;
                if (chatButton) {
                    const btnRow = document.createElement('div');
                    btnRow.className = 'card-buttons';
                    btnRow.innerHTML = `${chatButton}`;
                    div.appendChild(btnRow);
                }
                sectionEl.appendChild(div);
            });
            startCountdownTimers();
        }
    } else {
        if (pastEvents.length === 0) { sectionEl.innerHTML += `<p class=\"muted\">No past events yet.</p>`; }
        else {
            pastEvents.forEach(e => {
                const div = document.createElement("div"); div.className = "card"; div.style.cursor = 'default';
                div.innerHTML = `
                    <div class="category-badge">${e.category}</div>
                    <b style="font-size:1.05rem;color:#93c5fd;">${capitalizeWords(e.title)}</b>
                    <div class="kv">
                        <b>Venue:</b> <span class="value">${capitalizeWords(e.venue)}</span>
                        <b>Date:</b> <span class="value">${e.date}</span>
                        <b>Time:</b> <span class="value">${e.time}</span>
                        <b>Seats:</b> <span class="value">${e.taken}/${e.capacity}</span>
                    </div>`;
                sectionEl.appendChild(div);
            });
        }
    }
}
async function renderMedia() {
    const res = await fetch(API + "/events"); const data = await res.json();
    const c = document.getElementById("screen-media");
    c.innerHTML = `<h2>Event Media Gallery</h2><div class="sub-nav"><button class="sub-nav-btn ${currentMediaView === 'upcoming' ? 'active' : ''}" onclick="setMediaView('upcoming')">Upcoming & Live</button><button class="sub-nav-btn ${currentMediaView === 'past' ? 'active' : ''}" onclick="setMediaView('past')">Past</button></div><div id="media-content"></div>`;
    const mediaContent = document.getElementById('media-content');
    if (!data.ok) { mediaContent.innerHTML = `<p class="muted">Could not load media.</p>`; return; }
    const eventsWithMedia = data.events.filter(e => e.media && e.media.length > 0);
    if (eventsWithMedia.length === 0) { mediaContent.innerHTML = `<p class="muted">üñºÔ∏è No media has been uploaded for any event yet.</p>`; return; }
    const mediaDate = new Date();
    const upcomingMediaEvents = eventsWithMedia.filter(e => new Date(parseEventDateTime(e.date, e.time).getTime() + (e.duration || 0) * 60000) >= mediaDate).sort((a,b) => parseEventDateTime(a.date, a.time) - parseEventDateTime(b.date, b.time));
    const pastMediaEvents = eventsWithMedia.filter(e => new Date(parseEventDateTime(e.date, e.time).getTime() + (e.duration || 0) * 60000) < mediaDate).sort((a,b) => parseEventDateTime(b.date, b.time) - parseEventDateTime(a.date, a.time));
    const renderMediaSection = (events) => {
        if (events.length === 0) return `<p class="muted">No media in this section.</p>`;
        let sectionHtml = '';
        events.forEach(event => {
            sectionHtml += `<div class="event-media-section"><h4>${event.title} - ${event.date}</h4><div class="media-grid">`;
            event.media.forEach(m => {
                // Handle Cloudinary URLs (full HTTPS URLs), legacy GridFS, and relative paths
                let mediaUrl = m.url;
                if (m.url && (m.url.startsWith('http://') || m.url.startsWith('https://'))) {
                    // Cloudinary URL - use directly
                    mediaUrl = m.url;
                } else if (m._id) {
                    // Legacy GridFS
                    mediaUrl = `${API_BASE}/api/media/file/${m._id}`;
                } else if (m.url) {
                    // Relative path
                    mediaUrl = m.url.startsWith('/') ? `${API_BASE}${m.url}` : `${API_BASE}/${m.url}`;
                }
                if (m.type === "photo") sectionHtml += `<div class=\"media-item\"><img src=\"${mediaUrl}\" onclick=\"showLightbox('${m.url || m._id}', 'photo')\"></div>`;
                if (m.type === "video") {
                    // Add Cloudinary video optimization parameters for faster loading
                    let optimizedVideoUrl = mediaUrl;
                    if (mediaUrl && mediaUrl.includes('cloudinary.com') && !mediaUrl.includes('/q_')) {
                        // Add video optimization parameters for faster streaming
                        optimizedVideoUrl = mediaUrl.replace(/\.(mp4|webm|ogg)/, '/q_auto,f_auto,vc_auto,ac_auto,fl_progressive.$1');
                    }
                    sectionHtml += `<div class=\"media-item\" onclick=\"showLightbox('${m.url || m._id}', 'video')\"><video src=\"${optimizedVideoUrl}\" preload=\"metadata\" playsinline webkit-playsinline controls style=\"width:100%; height:100%; object-fit:cover;\"></video><div class=\"play-overlay\"><div class=\"play-icon\">‚ñ∂</div></div></div>`;
                }
            });
            sectionHtml += `</div></div>`;
        });
        return sectionHtml;
    };
    mediaContent.innerHTML = currentMediaView === 'upcoming' ? renderMediaSection(upcomingMediaEvents) : renderMediaSection(pastMediaEvents);
}

// ---------- Auth ----------
function showAuth() { showTab('auth'); }
// Persist ?api= param to localStorage for subsequent loads
try{
    (function(){
        const p = new URLSearchParams(location.search);
        const api = p.get('api');
        if(api){ localStorage.setItem('API_BASE', api); }
    })();
}catch{}

// If opened via QR link, show a minimal standalone QR landing flow
try{
    (function(){
        const p = new URLSearchParams(location.search);
        const qr = p.get('qr_e');
        if(qr){ setTimeout(()=>renderQrLanding(Number(qr)), 0); }
    })();
}catch{}
function showLogin() {
    const s = document.getElementById("screen-login");
    const hasQr = (()=>{ try{ return new URLSearchParams(location.search).has('qr_e'); }catch{ return false; } })();
    s.innerHTML = `
    <div>
        <h2 style="font-size: 2rem;">Login</h2>
        <input id="loginReg" placeholder="Registration Number">
        <div class="password-wrapper">
             <input id="loginPass" type="password" placeholder="Password">
             <span class="password-toggle" onclick="togglePasswordVisibility('loginPass')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path class="eye-open-path" d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle class="eye-open-path" cx="12" cy="12" r="3"></circle>
                    <path class="eye-closed-path" d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line class="eye-closed-path" x1="1" y1="1" x2="23" y2="23"></line>
                </svg>
             </span>
        </div>
        <div class="checkbox-row">
            <input type="checkbox" id="rememberMe" checked class="checkbox-input">
            <label for="rememberMe" class="checkbox-label">Keep me logged in</label>
        </div>
        <button class="btn primary" onclick="doLogin()">Login</button>
        ${hasQr ? `<button class="btn" onclick="doQrVerifyIfPresent()">Verify QR</button>` : ''}
        <button class="btn" onclick="showSignup()">Sign Up</button>
        <button class="btn" onclick="showAdminLogin()">Admin Login</button>
        <button class="btn muted" onclick="showForgotPassword()">Forgot Password?</button>
        <div id="loginMsg" class="muted"></div>
    </div>`;
    showTab('login');
}

// --------- QR Standalone Landing (no full app UI) ---------
async function renderQrLanding(eventId){
    try{
        const modal = document.getElementById('modal');
        const body = document.getElementById('modal-body');
        body.innerHTML = `
          <h3>Verify to Book</h3>
          <div class="muted">Enter your Registration Number and Password to continue.</div>
          <input id="qrReg" placeholder="Registration Number" style="margin-top:10px;">
          <div class="password-wrapper" style="margin-top:8px;">
            <input id="qrPass" type="password" placeholder="Password">
            <span class="password-toggle" onclick="togglePasswordVisibility('qrPass')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path class="eye-open-path" d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle class="eye-open-path" cx="12" cy="12" r="3"></circle>
                <path class="eye-closed-path" d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line class="eye-closed-path" x1="1" y1="1" x2="23" y2="23"></line>
              </svg>
            </span>
          </div>
          <div style="display:flex; gap:8px; margin-top:12px;">
            <button class="btn primary" onclick="qrVerifyAndShow(${eventId})" style="flex:1;">Verify</button>
          </div>
          <div id="qrMsg" class="muted" style="margin-top:8px;"></div>
        `;
        modal.style.display = 'flex';
    }catch{}
}

async function qrVerifyAndShow(eventId){
    const regNumber = document.getElementById('qrReg').value;
    const password = document.getElementById('qrPass').value;
    const msg = document.getElementById('qrMsg');
    msg.textContent = '‚è≥ Verifying...';
    try{
        const res = await fetch(API+"/login", { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ regNumber, password }) });
        const data = await res.json();
        if(!(res.ok && data.ok)){ msg.textContent = '‚ùå Invalid credentials'; return; }
        const evRes = await fetch(API+"/events");
        const evData = await evRes.json();
        const ev = (evData.events||[]).find(e=>e.id===Number(eventId));
        if(!ev){ msg.textContent = '‚ùå Event not found.'; return; }
        const body = document.getElementById('modal-body');
        const isOrganizer = ev.creatorRegNumber && data.user && (ev.creatorRegNumber === data.user.regNumber);
        const isVolunteer = Array.isArray(ev.volunteers) && ev.volunteers.some(v=>v.regNumber===data.user.regNumber);
        if(isOrganizer){
            body.innerHTML = `
              <h3>${capitalizeWords(ev.title)} <span class="muted" style="font-size:0.9rem">‚Ä¢ Your Event</span></h3>
              <div class="kv">
                <b>Date:</b> <span class="value">${ev.date}</span>
                <b>Time:</b> <span class="value">${ev.time}</span>
                <b>Venue:</b> <span class="value">${capitalizeWords(ev.venue)}</span>
                <b>Seats:</b> <span class="value">${ev.taken}/${ev.capacity}</span>
              </div>
              <div class="muted" style="margin-top:10px;">Organizers cannot book tickets for their own events.</div>
            `;
        } else if (isVolunteer){
            const myVol = (ev.volunteers||[]).find(v=>v.regNumber===data.user.regNumber) || {};
            body.innerHTML = `
              <h3>${capitalizeWords(ev.title)} <span class="muted" style="font-size:0.9rem">‚Ä¢ Volunteer</span></h3>
              <div class="kv">
                <b>Date:</b> <span class="value">${ev.date}</span>
                <b>Time:</b> <span class="value">${ev.time}</span>
                <b>Venue:</b> <span class="value">${capitalizeWords(ev.venue)}</span>
                <b>Role:</b> <span class="value">${capitalizeWords(myVol.role||'Volunteer')}</span>
              </div>
              <div class="muted" style="margin-top:10px;">Volunteers cannot book tickets for this event.</div>
            `;
        } else {
            const already = Array.isArray(ev.bookings) && ev.bookings.find(b=>b.regNumber===regNumber);
            if(already){
                body.innerHTML = `
                  <h3>${capitalizeWords(ev.title)}</h3>
                  <div class="kv">
                    <b>Date:</b> <span class="value">${ev.date}</span>
                    <b>Time:</b> <span class="value">${ev.time}</span>
                    <b>Venue:</b> <span class="value">${capitalizeWords(ev.venue)}</span>
                    <b>Seat:</b> <span class="value">${already.seat}</span>
                  </div>
                  <div class="muted" style="margin-top:10px;">You already have a ticket for this event.</div>
                  <div style="display:flex; gap:8px; margin-top:12px;">
                    <button class="btn" onclick="showQrTicketDetail(${ev.id}, '${regNumber}')" style="flex:1;">View Ticket</button>
                  </div>
                `;
            } else {
                body.innerHTML = `
                  <h3>${capitalizeWords(ev.title)}</h3>
                  <div class="kv">
                    <b>Date:</b> <span class="value">${ev.date}</span>
                    <b>Time:</b> <span class="value">${ev.time}</span>
                    <b>Venue:</b> <span class="value">${capitalizeWords(ev.venue)}</span>
                    <b>Seats:</b> <span class="value">${ev.taken}/${ev.capacity}</span>
                  </div>
                  <div style="display:flex; gap:8px; margin-top:12px;">
                    <button class="btn primary" onclick="bookTicketViaQrAs(${ev.id}, '${regNumber}')" style="flex:1;">Book Ticket</button>
                  </div>
                `;
            }
        }
    }catch(err){ msg.textContent = '‚ùå Network error'; }
}

async function showQrTicketDetail(eventId, regNumber){
    try{
        const res = await fetch(API+"/tickets/"+regNumber);
        const data = await res.json();
        if(!(res.ok && data.ok)) return;
        const t = (data.tickets||[]).find(x=>x.eventId===Number(eventId) && !x.waiting);
        if(t){ showTicketDetail(t); }
    }catch{}
}

async function bookTicketViaQrAs(eventId, regNumber){
    try{
        const res = await fetch(API+"/tickets",{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ eventId, regNumber, via:'qr' })});
        const data = await res.json();
        if(res.ok && data.ok){
            const body = document.getElementById('modal-body');
            const bookedAt = new Date(data.booking.bookedAt).toLocaleString();
            body.innerHTML = `<h3>üéüÔ∏è Booked</h3><div class="muted">Ticket booked using QR code at ${bookedAt}.</div>
            <div style="display:flex; gap:8px; margin-top:12px;"><button class="btn" onclick="showQrTicketDetail(${eventId}, '${regNumber}')" style="flex:1;">View Ticket</button></div>`;
        } else {
            alert('‚ùå '+(data.error||'Booking failed'));
        }
    }catch{ alert('Network error'); }
}
// If a qr_e param is present, this verifies and shows minimal UI only after login
async function doQrVerifyIfPresent(){
    const params = new URLSearchParams(location.search);
    const e = params.get('qr_e');
    if(!e){
        const msg = document.getElementById('loginMsg');
        if(msg) msg.textContent = '‚ÑπÔ∏è No QR to verify.';
        return;
    }
    if(!currentUser){
        const msg = document.getElementById('loginMsg');
        if(msg) msg.textContent = 'Please login first, then tap Verify QR again.';
        return;
    }
    try {
        await handleQrFlowAfterLogin(Number(e));
    } catch {}
}

async function handleQrFlowAfterLogin(eventId){
    // Fetch fresh events and find the event
    const res = await fetch(API+"/events");
    const data = await res.json();
    if(!data.ok) return;
    const ev = (data.events||[]).find(x=>x.id===Number(eventId));
    const body = document.getElementById('modal-body');
    if(!ev){
        alert('QR invalid or event not found.');
        return;
    }
    // Minimal details + single book button
    body.innerHTML = `<h3>${capitalizeWords(ev.title)}</h3>
        <div class="kv">
           <b>Date:</b> <span class="value">${ev.date}</span>
           <b>Time:</b> <span class="value">${ev.time}</span>
           <b>Venue:</b> <span class="value">${capitalizeWords(ev.venue)}</span>
        </div>
        <div style="margin-top:10px; display:flex; gap:8px;">
           <button class="btn primary" onclick="bookTicketViaQr(${ev.id})">Book via QR</button>
        </div>`;
    document.getElementById('modal').style.display='flex';
}

function openQrModal(eventId){
    // Render a QR containing the landing link with qr_e param, preserving ?api if present
    const params = new URLSearchParams(location.search);
    const apiParam = params.get('api');
    params.set('qr_e', String(eventId));
    if (apiParam) params.set('api', apiParam);
    const qs = params.toString();
    const link = `${location.origin}${location.pathname}${qs ? ('?' + qs) : ''}`;
    const body = document.getElementById('modal-body');
    body.innerHTML = `<h3>Scan to Book</h3>
      <div id="qrCanvas" style="display:flex;justify-content:center;align-items:center;height:260px"></div>`;
    document.getElementById('modal').style.display='flex';
    // Lightweight inline QR generator (no external deps): use simple canvas squares
    try { generateQr(link, 'qrCanvas'); } catch {}
}

// Tiny QR generator (fallback pattern for short URLs). For reliability in production, replace with a QR library.
function generateQr(text, containerId){
    // Use a dynamic import of Google Chart API as an image fallback for simplicity
    const url = 'https://chart.googleapis.com/chart?cht=qr&chs=240x240&chl='+encodeURIComponent(text);
    const div = document.getElementById(containerId);
    if(!div) return;
    const fallback = 'https://api.qrserver.com/v1/create-qr-code/?size=240x240&data='+encodeURIComponent(text);
    div.innerHTML = `<img src="${url}" alt="QR Code" width="240" height="240" referrerpolicy="no-referrer" style="background:#fff;padding:8px;border-radius:6px;" onerror="this.onerror=null;this.src='${fallback}';">`;
}
function showSignup() {
    const s = document.getElementById("screen-signup");
    s.innerHTML = `
    <h2 style="font-size: 2rem;">Sign Up</h2>
    <input id="name" placeholder="Name"><input id="surname" placeholder="Surname"><input id="age" placeholder="Age" type="number"><select id="gender"><option>Male</option><option>Female</option><option>Other</option></select>
    <input id="email" placeholder="Email" type="email"><input id="phone" placeholder="Phone (10 digits)"><input id="regNumber" placeholder="Registration Number">
    <div class="password-wrapper">
        <input id="password" type="password" placeholder="Password">
        <span class="password-toggle" onclick="togglePasswordVisibility('password')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path class="eye-open-path" d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle class="eye-open-path" cx="12" cy="12" r="3"></circle>
                <path class="eye-closed-path" d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line class="eye-closed-path" x1="1" y1="1" x2="23" y2="23"></line>
            </svg>
        </span>
    </div>
    <select id="role"><option>STUDENT</option><option>ORGANIZER</option></select>
    <button class="btn primary" onclick="doSignup()">Sign Up</button>
    <button class="btn" onclick="showLogin()">Cancel</button>
    <div id="signupMsg" class="muted"></div>`;
    showTab('signup');
}
function showForgotPassword() {
    const s = document.getElementById("screen-login");
    s.innerHTML = `
    <div>
        <h2 style="font-size: 2rem;">Forgot Password</h2>
        <input id="resetReg" placeholder="Registration Number">
        <select id="resetRole"><option>STUDENT</option><option>ORGANIZER</option></select>
        <div class="password-wrapper">
            <input id="newPassword" type="password" placeholder="New Password">
            <span class="password-toggle" onclick="togglePasswordVisibility('newPassword')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path class="eye-open-path" d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle class="eye-open-path" cx="12" cy="12" r="3"></circle>
                    <path class="eye-closed-path" d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line class="eye-closed-path" x1="1" y1="1" x2="23" y2="23"></line>
                </svg>
            </span>
        </div>
        <div class="password-wrapper">
            <input id="confirmNewPassword" type="password" placeholder="Confirm New Password">
            <span class="password-toggle" onclick="togglePasswordVisibility('confirmNewPassword')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path class="eye-open-path" d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle class="eye-open-path" cx="12" cy="12" r="3"></circle>
                    <path class="eye-closed-path" d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line class="eye-closed-path" x1="1" y1="1" x2="23" y2="23"></line>
                </svg>
            </span>
        </div>
        <button class="btn primary" onclick="doResetPassword()">Reset Password</button>
        <button class="btn" onclick="showLogin()">Cancel</button>
        <div id="resetMsg" class="muted"></div>
    </div>`;
    showTab('login');
}
async function doLogin() {
    const regNumber = String(document.getElementById("loginReg").value||'').trim(); 
    const password = String(document.getElementById("loginPass").value||'');
    const msg = document.getElementById("loginMsg"); 
    msg.textContent = "‚è≥ Logging in...";
    
    console.log("üîç Login attempt:", { regNumber, API_BASE, API });
    
    try {
        const res = await fetch(API + "/login", { 
            method: "POST", 
            headers: { "Content-Type": "application/json" }, 
            body: JSON.stringify({ regNumber, password }) 
        });
            
            console.log("üì° Login response:", res.status, res.statusText);
            
        const data = await res.json();
            console.log("üìä Login data:", data);
            
        if (res.ok && data.ok) {
            msg.textContent = "‚úÖ Login successful! Redirecting...";
            setTimeout(async () => {
                currentUser = data.user;
                
                // Check if "Remember Me" is checked
                const rememberMe = document.getElementById("rememberMe");
                if (rememberMe && rememberMe.checked) {
                    saveUserSession(currentUser); // Save user session
                }
                
                await renderTickets(true); 
                // If arrived via QR (qr_e param), proceed to QR flow after login
                const params = new URLSearchParams(location.search);
                const qrEvent = params.get('qr_e');
                if (qrEvent) {
                    // Show event details and a single QR book button
                    try { await handleQrFlowAfterLogin(Number(qrEvent)); } catch {}
                }
                pollNotifications();
                notificationInterval = setInterval(pollNotifications, 5000);
                eventStateInterval = setInterval(checkEventStates, 30000);
                // Start event start notifications checker
                setInterval(checkEventStartNotifications, 60000); // Check every minute
                // Start live updates stream
                try { startLiveUpdates(); } catch (e) { console.warn('SSE unavailable', e); }
                renderTabs(); 
                showTab("home");
                
                // Welcome back banner
                showWelcomeBanner(`üëã Welcome back, ${data.user.name}!`);
            }, 1000);
        } else { 
            console.error("‚ùå Login failed:", data);
            msg.textContent = "‚ùå " + (data.error || "Login failed"); 
        }
    } catch (err) { 
        console.error("‚ùå Login network error:", err);
        msg.textContent = "‚ùå Network error - check console for details"; 
    }
}

// ---------- Live Updates via SSE ----------
function startLiveUpdates(){
    try{ if(__eventSource) { __eventSource.close(); __eventSource = null; } }catch{}
    if(!window.EventSource) return; // old browsers fallback to polling already in place
    const url = API + '/stream' + (currentUser && currentUser.regNumber ? ('?reg='+encodeURIComponent(currentUser.regNumber)) : '');
    const es = new EventSource(url);
    __eventSource = es;
    es.addEventListener('hello', ()=>{});
    es.addEventListener('ping', ()=>{});
    
    // Start live updates
    
    // Events or tickets changed -> refresh lightweight
    const refresh = async () => {
        try{
            const currentScreen = document.querySelector('.content[style*="block"]');
            if(currentScreen){
                const id = currentScreen.id.replace('screen-','');
                if(id==='home'){ await renderEvents(); }
                if(id==='tickets'){ await renderTickets(true); renderTickets(); }
                if(id==='organizer'){ await renderOrganizer(); }
            }
            // Also keep countdowns fresh
            try { startCountdownTimers && startCountdownTimers(); } catch {}
        }catch{}
    };
    es.addEventListener('events_changed', refresh);
    es.addEventListener('tickets_changed', (e)=>{
        try{
            const data = JSON.parse(e.data||'{}');
            if(currentUser && data && data.eventId){
                refresh();
            }
        }catch{ refresh(); }
    });
    es.addEventListener('media_changed', (e)=>{
        try{
            const data = JSON.parse(e.data||'{}');
            if(currentUser && data && data.eventId){
                refresh();
            }
        }catch{ refresh(); }
    });
    es.addEventListener('event_updated', (e)=>{
        try{
            const data = JSON.parse(e.data||'{}');
            if(currentUser && data && data.eventId){
                refresh();
            }
        }catch{ refresh(); }
    });
    es.addEventListener('ticket_cancelled', (e)=>{
        try{
            const data = JSON.parse(e.data||'{}');
            if(currentUser && data && data.eventId){
                refresh();
            }
        }catch{ refresh(); }
    });
    es.onerror = () => { try{ es.close(); }catch{}; __eventSource=null; setTimeout(()=>{ try{ startLiveUpdates(); }catch{} }, 5000); };
}
async function doSignup() {
    const user = { 
        name: capitalizeWords(document.getElementById("name").value), 
        surname: capitalizeWords(document.getElementById("surname").value), 
        age: document.getElementById("age").value, 
        gender: document.getElementById("gender").value, 
        email: String(document.getElementById("email").value||'').trim(), 
        phone: String(document.getElementById("phone").value||'').trim(), 
        regNumber: String(document.getElementById("regNumber").value||'').trim(), 
        password: document.getElementById("password").value, 
        role: document.getElementById("role").value 
    };
    const msg = document.getElementById("signupMsg"); 
    msg.textContent = "‚è≥ Signing up...";
    
    console.log("üîç Signup attempt:", { regNumber: user.regNumber, API_BASE, API });
    
    try {
        const res = await fetch(API + "/signup", { 
            method: "POST", 
            headers: { "Content-Type": "application/json" }, 
            body: JSON.stringify(user) 
        });
            
            console.log("üì° Signup response:", res.status, res.statusText);
            
        const data = await res.json();
            console.log("üìä Signup data:", data);
            
        if (res.ok && data.ok) {
            if(user.role==='ORGANIZER'){
                // Organizer requests are saved as STUDENT with organizerStatus=PENDING.
                // Show centered 2s toast then auto-login and land on Home with Org tab disabled.
                showCenterToast('‚úÖ Request sent to admin for verification');
                const pendingUser = data.user; // backend returns created user
                try{ currentUser = pendingUser; saveUserSession(currentUser); }catch{}
                renderTabs(); showTab('home');
                return;
            }
            msg.textContent = "‚úÖ Account created! Signing you in...";
            setTimeout(async () => {
                // Auto-login the newly created user
                try {
                    const loginRes = await fetch(API + "/login", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ regNumber: user.regNumber, password: user.password })
                    });
                    const loginData = await loginRes.json();
                    
                    if (loginRes.ok && loginData.ok) {
                        currentUser = loginData.user;
                        saveUserSession(currentUser); // Auto-save session for new users
                        await renderTickets(true);
                        pollNotifications();
                        notificationInterval = setInterval(pollNotifications, 5000);
                        eventStateInterval = setInterval(checkEventStates, 30000);
                        // Start event start notifications checker
                        setInterval(checkEventStartNotifications, 60000); // Check every minute
                        renderTabs();
                        showTab("home");
                        // Welcome banner for new signup
                        showWelcomeBanner(`üéâ Welcome, ${user.name}!`);
                    } else {
                        // Fallback to login screen if auto-login fails
                        showLogin();
                    }
                } catch (error) {
                    // Fallback to login screen if auto-login fails
                    showLogin();
                }
            }, 2000);
        } else { 
            console.error("‚ùå Signup failed:", data);
            msg.textContent = "‚ùå " + (data.error || "Signup failed"); 
        }
    } catch (err) { 
        console.error("‚ùå Signup network error:", err);
        msg.textContent = "‚ùå Network error - check console for details"; 
    }
}
async function doResetPassword() { const e = document.getElementById("resetReg").value, t = document.getElementById("resetRole").value, n = document.getElementById("newPassword").value, c = document.getElementById("confirmNewPassword").value, a = document.getElementById("resetMsg"); if(n!==c){ a.textContent = "‚ùå Passwords do not match"; return;} if (!/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{6,}$/.test(n)) return void (a.textContent = "‚ùå Password must contain uppercase, lowercase, number and be at least 6 characters long"); a.textContent = "‚è≥ Resetting password..."; try { const i = await fetch(API + "/reset-password", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ regNumber: e, role: t, newPassword: n }) }), o = await i.json(); i.ok && o.ok ? (a.textContent = "‚úÖ Password changed successfully! Redirecting...", setTimeout(showLogin, 1000)) : a.textContent = "‚ùå " + (o.error || "Password reset failed.") } catch { a.textContent = "‚ùå Network error" } }
function togglePasswordVisibility(e) { const t = document.getElementById(e), n = t.nextElementSibling, a = n.querySelectorAll(".eye-open-path"), i = n.querySelectorAll(".eye-closed-path"); "password" === t.type ? (t.type = "text", a.forEach(e => e.style.display = "none"), i.forEach(e => e.style.display = "block")) : (t.type = "password", a.forEach(e => e.style.display = "block"), i.forEach(e => e.style.display = "none")) }

// ---------- Tickets ----------
async function bookTicket(e){const t=await fetch(API+"/tickets",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({eventId:e,regNumber:currentUser.regNumber})}),n=await t.json();t.ok&&n.ok?(alert("üéüÔ∏è Ticket booked!"),await renderTickets(!0),renderEvents()):alert("‚ùå "+(n.error||"Booking failed"))}
async function bookTicketViaQr(eventId){
    const res = await fetch(API+"/tickets",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({eventId: eventId, regNumber: currentUser.regNumber, via: 'qr'})});
    const data = await res.json();
    if(res.ok && data.ok){
        alert("üéüÔ∏è Ticket booked via QR!");
        try{ if(window.__eventsCache){ const ev = window.__eventsCache.find(e=>e.id===eventId); if(ev){ ev.bookings = Array.isArray(ev.bookings)?ev.bookings:[]; ev.bookings.push({ regNumber: currentUser.regNumber, seat: data.booking && data.booking.seat ? data.booking.seat : (ev.bookings.length+1) }); ev.taken = (ev.taken||0)+1; } } }catch{}
        await renderTickets(true);
        renderEvents();
        // Show ticket immediately
        const t = (userTickets||[]).find(x=>x.eventId===eventId && !x.waiting);
        if(t) showTicketDetail(t);
    } else {
        alert("‚ùå "+(data.error||"Booking failed"));
    }
}
async function renderTickets(e=!1){
    const t=await fetch(API+"/events"),n=await t.json();
    const a=await fetch(API+"/tickets/"+currentUser.regNumber),i=await a.json();
    if(!i.ok||!n.ok)return void(userTickets=[]);
    userTickets=i.tickets||[];
    if(e)return;
    const o=document.getElementById("screen-tickets");
    o.innerHTML=`<button class="btn" onclick="refreshTickets()">üîÑ Refresh</button>`;
    if(0===userTickets.length){ o.innerHTML+=`<p class="muted">üéüÔ∏è No ticket booking history yet.</p>`; return; }
    
    // Sort tickets: upcoming booked, upcoming waiting, past booked, past waiting
    const ticketDate = new Date();
    const sortedTickets = userTickets.sort((a, b) => {
        const eventA = n.events.find(e => e.id === a.eventId);
        const eventB = n.events.find(e => e.id === b.eventId);
        if (!eventA || !eventB) return 0;
        
        const endTimeA = new Date(parseEventDateTime(eventA.date, eventA.time).getTime() + (eventA.duration || 0) * 60000);
        const endTimeB = new Date(parseEventDateTime(eventB.date, eventB.time).getTime() + (eventB.duration || 0) * 60000);
        
        const isUpcomingA = endTimeA >= ticketDate;
        const isUpcomingB = endTimeB >= ticketDate;
        
        // First sort by upcoming vs past
        if (isUpcomingA !== isUpcomingB) {
            return isUpcomingA ? -1 : 1; // upcoming first
        }
        
        // Within same time category, sort by booked vs waiting
        if (a.waiting !== b.waiting) {
            return a.waiting ? 1 : -1; // booked first
        }
        
        // Within same status, sort by date
        return parseEventDateTime(eventA.date, eventA.time) - parseEventDateTime(eventB.date, eventB.time);
    });
    
    sortedTickets.forEach(e=>{
        const t=document.createElement("div"); t.className="card";
        const a=n.events.find(t=>t.id===e.eventId);
        const isWaiting = !!e.waiting;
        let actionHtml = "";
        if(a){
            const evStart = parseEventDateTime(a.date,a.time);
            const isEventLive = new Date() >= evStart;
            
            if(!isWaiting && !isEventLive){
                actionHtml = `<button class="btn" style="border-color: var(--red-accent); color: var(--red-accent);" onclick="cancelTicket(${a.id}, '${a.title}')">Cancel Ticket</button>`;
            } else if(!isWaiting && isEventLive){
                actionHtml = `<button class="btn" disabled style="border-color: var(--red-accent); color: var(--red-accent); opacity: 0.5;">Event Live - Cannot Cancel</button>`;
            }
            
            if(isWaiting && !isEventLive){
                actionHtml = `<button class="btn" style="border-color: var(--red-accent); color: var(--red-accent);" onclick="cancelWait(${a.id})">Leave Waitlist</button>`;
            } else if(isWaiting && isEventLive){
                actionHtml = `<button class="btn" disabled style="border-color: var(--red-accent); color: var(--red-accent); opacity: 0.5;">Event Live - Cannot Leave</button>`;
            }
        }
        const badge = a ? a.category : "N/A";
        const idLine = isWaiting ? `Wait ID: ${e.ticketId} ‚Ä¢ Position: ${e.position}` : `Seat: ${e.seat}<br>ID: ${e.ticketId}`;
        const title = isWaiting ? `‚è≥ Waiting ‚Ä¢ ${e.eventTitle}` : e.eventTitle;
        t.innerHTML=`<div class="category-badge">${badge}</div><b>${title}</b><br>üìç ${e.venue}<br>üìÖ ${e.date} üïí ${e.time}<br>${idLine}${actionHtml}`;
        t.onclick=s=>{"BUTTON"!==s.target.tagName&&showTicketDetail(e)};
        o.appendChild(t)
    })
}

async function cancelWait(eventId){
    if(!confirm('Leave the waitlist for this event?')) return;
    const res = await fetch(API+"/waitlist", { method:"DELETE", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ eventId, regNumber: currentUser.regNumber })});
    const data = await res.json();
    if(res.ok && data.ok){ alert('Removed from waitlist.'); await renderTickets(true); renderTickets(); renderEvents(); setTimeout(renderEvents, 500); }
    else { alert('Error: '+(data.error||'Failed to leave waitlist.')); }
}

async function leaveWaitlist(eventId){
    if(!confirm('Leave the waitlist for this event?')) return;
    const res = await fetch(API+"/waitlist/leave", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ eventId, regNumber: currentUser.regNumber })});
    const data = await res.json();
        if(res.ok && data.ok){ 
            alert('Removed from waitlist.'); 
            await renderTickets(true); 
            renderTickets(); 
            // Clear events cache to force fresh data
            window.__eventsCache = null;
            renderEvents(); 
            setTimeout(renderEvents, 500); 
        }
    else { 
        alert('Error: ' + (data.error || 'Failed to leave waitlist.')); 
    }
}
async function cancelTicket(e,t){if(confirm(`Are you sure you want to cancel your ticket for "${t}"?`)){const t=await fetch(API+"/tickets",{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({eventId:e,regNumber:currentUser.regNumber})}),n=await t.json();t.ok&&n.ok?(alert("Ticket cancelled successfully."),await renderTickets(!0),renderTickets(),renderEvents()):alert("Error: "+(n.error||"Failed to cancel ticket."))}}

// ---------- Organizer Functions ----------
function createEventScreen() {
    const e = document.getElementById("screen-organizer"); const t = new Date().toISOString().split("T")[0];
    const categories = ["Education", "Soft Skills", "Sports", "Cultural", "Technology", "Science", "Music", "Art & Craft", "Gaming", "Hackathon", "Workshop", "Seminar", "Conference", "Fest", "Charity", "Water Activities", "Other"];
    let categoryOptions = categories.map(c => `<option>${c}</option>`).join('');
    const venues = ["LH-C", "LH-D", "LH-A", "LHB (MB)", "SJA", "MAIN BUILDING", "SEMINAR HALL A (MB)", "SEMINAR HALL B (MB)", "SEMINAR HALL C (MB)", "OPEN THEATER", "NEW SPORTS COMPLEX", "MAIN GROUND", "NITK BEACH", "CRF", "GYM"];
    let venueOptions = venues.map(v => `<option>${v}</option>`).join('');
    e.innerHTML = `<h2>Create Event</h2>
    <input id="evTitle" placeholder="Event Title">
    <select id="evCategory"><option value="" disabled selected>Select a Category</option>${categoryOptions}</select>
    <select id="evVenue"><option value="" disabled selected>Select a Venue</option>${venueOptions}</select>
    <input id="evDate" type="date" min="${t}" onchange="updateMinTime('evDate', 'evTime')"><input id="evTime" type="time">
    <input id="evCap" type="number" placeholder="Seat Capacity"><input id="evDuration" type="number" placeholder="Duration (in minutes)">
    <div class="card" style="margin-top:10px;">
        <div class="kv organizer-kv">
            <b>Resources:</b>
            <span class="value">Select equipment needed</span>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
            ${['Projector','Sound System','Microphone','Podium','LED Screen','Lighting Kit'].map(r => `
               <label style="display:flex; align-items:center; gap:6px; background: var(--bg-primary); padding:6px 10px; border:1px solid var(--border); border-radius:6px; cursor:pointer;">
                  <input type="checkbox" class="res-check" value="${r}">
                  <span>${r}</span>
               </label>
            `).join('')}
    </div>
    </div>
    <!-- Volunteer selection removed at creation. Organiser can invite later. -->
    <div style="display: flex; gap: 10px;">
        <button class="btn primary" onclick="doCreateEvent()" style="flex: 1;">Create Event</button>
        <button class="btn" onclick="renderOrganizer()" style="flex: 1;">Cancel</button>
    </div>
    <div id="evMsg" class="muted"></div>`;
    updateMinTime("evDate", "evTime");
}
function renderVolunteerInputs(){
    const container = document.getElementById('evVolunteerInputs');
    if(!container) return;
    const n = Math.max(0, Number(document.getElementById('evVolCount').value||0));
    let html = '';
    for(let i=1;i<=n;i++){
        html += `<div style="display:flex; flex-direction:column; gap:8px; margin-bottom:10px;">
                    <input id="evVolReg${i}" placeholder="Volunteer #${i} RegNumber">
                    <div style="display:flex; gap:8px; align-items:center;">
                        <button class="btn" onclick="verifyVolunteerReg('evVolReg${i}', 'evVolStatus${i}', 'evVolRoleRow${i}', currentUser.regNumber)">Verify</button>
                        <button class="btn" onclick="clearVolunteerEntry(${i})">Clear</button>
                        <span id="evVolStatus${i}" class="muted"></span>
                    </div>
                    <div id="evVolRoleRow${i}" style="display:none; gap:8px; align-items:center;">
                        <select id="evVolRole${i}" style="flex:1" onchange="syncVolunteerRoles()">
                            <option value="" disabled selected>Select Role</option>
                        </select>
                    </div>
                 </div>`;
    }
    container.innerHTML = html || `<span class="muted">No volunteers. Set count above to add.</span>`;
    populateVolunteerRoleOptions();
}
const VOL_ROLES = ["Registration Desk","Stage Management","Guest Reception","Crowd Control","Logistics","Media Support"];
function getSelectedRolesInCreate(){
    const count = Number(document.getElementById('evVolCount')?.value||0);
    const roles = [];
    for(let i=1;i<=count;i++){
        const val = document.getElementById(`evVolRole${i}`)?.value;
        if(val) roles.push(val);
    }
    return roles;
}
function populateVolunteerRoleOptions(){
    const count = Number(document.getElementById('evVolCount')?.value||0);
    const chosen = new Set(getSelectedRolesInCreate());
    for(let i=1;i<=count;i++){
        const sel = document.getElementById(`evVolRole${i}`);
        if(!sel) continue;
        const current = sel.value;
        sel.innerHTML = `<option value="" disabled ${current?"":"selected"}>Select Role</option>` + VOL_ROLES
            .filter(r => r === current || !chosen.has(r))
            .map(r => `<option ${r===current?"selected":""}>${r}</option>`)
            .join('');
    }
}
function syncVolunteerRoles(){ populateVolunteerRoleOptions(); }
async function verifyVolunteerReg(inputId, statusId, roleRowId, organizerReg){
    const inp = document.getElementById(inputId); const st = document.getElementById(statusId); const roleRow = roleRowId ? document.getElementById(roleRowId) : null;
    if(!inp || !st) return;
    const reg = String(inp.value||'').trim();
    // Prevent the organizer of this event from being verified as volunteer (but allow other organizers)
    if (organizerReg && reg === organizerReg) {
        st.textContent = 'Organizer cannot be a volunteer'; st.style.color = '#ef4444'; if(roleRow) roleRow.style.display = 'none'; return;
    }
    if(!reg){ st.textContent = 'Enter reg number'; st.style.color = '#fca5a5'; return; }
    st.textContent = 'Verifying...'; st.style.color = '';
    try{
        const r = await fetch(`${API}/users/${reg}`);
        const d = await r.json();
        if(r.ok && d.ok){ st.textContent = '‚úì Verified'; st.style.color = '#10b981'; if(roleRow) roleRow.style.display = 'flex'; }
        else { st.textContent = 'User not exists'; st.style.color = '#ef4444'; if(roleRow) roleRow.style.display = 'none'; }
    }catch{ st.textContent = 'Network error'; st.style.color = '#ef4444'; }
}
function clearVolunteerEntry(i){
    const reg = document.getElementById(`evVolReg${i}`);
    const st = document.getElementById(`evVolStatus${i}`);
    const roleRow = document.getElementById(`evVolRoleRow${i}`);
    const role = document.getElementById(`evVolRole${i}`);
    if(reg) reg.value = '';
    if(st){ st.textContent = ''; st.style.color = ''; }
    if(roleRow) roleRow.style.display = 'none';
    if(role) role.value = '';
    populateVolunteerRoleOptions();
}
async function doCreateEvent() {
    const e = {
        title: capitalizeWords(document.getElementById("evTitle").value), venue: document.getElementById("evVenue").value, date: document.getElementById("evDate").value, time: document.getElementById("evTime").value,
        capacity: document.getElementById("evCap").value, duration: document.getElementById("evDuration").value, category: document.getElementById("evCategory").value, creatorRegNumber: currentUser.regNumber,
        resources: Array.from(document.querySelectorAll('.res-check:checked')).map(cb => cb.value)
    };
    if (!e.title || !e.venue || !e.date || !e.time || !e.capacity || !e.duration || !e.category) return void alert("Please fill all event fields.");
    if (new Date(`${e.date}T${e.time}`) < new Date) return void alert("Event date and time must be in the future.");
    // Collect volunteers
    const countEl = document.getElementById('evVolCount');
    const vCount = countEl ? Number(countEl.value||0) : 0;
    const volunteers = [];
    for(let i=1;i<=vCount;i++){
        const reg = String(document.getElementById(`evVolReg${i}`)?.value||'').trim();
        if(!reg){ return void alert(`Please enter reg number for volunteer #${i}`); }
        const role = String(document.getElementById(`evVolRole${i}`)?.value||'').trim();
        if(!role){ return void alert(`Please select a role for volunteer #${i}`); }
        // verify exists
        try{
            const r = await fetch(`${API}/users/${reg}`);
            const d = await r.json();
            if(!(r.ok && d.ok)) return void alert(`Volunteer not found: ${reg}`);
            volunteers.push({ regNumber: reg, role });
        }catch{ return void alert(`Failed to verify volunteer: ${reg}`); }
    }
    if(volunteers.length>0){ e.volunteers = volunteers; }
    
    const modal = document.getElementById("modal");
    const modalBody = document.getElementById("modal-body");
    modalBody.innerHTML = `<div class="loader-container"><div class="loader-circle"></div><p id="loader-percentage">0%</p><p>Checking for slot...</p></div>`;
    modal.style.display = "flex";
    
    let progress = 0;
    const loaderPercentage = modalBody.querySelector("#loader-percentage");
    const interval = setInterval(() => {
        progress += 5;
        if(progress > 100) progress = 100;
        loaderPercentage.textContent = `${progress}%`;
        loaderCircle.style.setProperty('--p', progress);
        if (progress >= 100) clearInterval(interval);
    }, 100);

    setTimeout(async () => {
        const t = await fetch(API + "/events", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(e) });
        closeModal();
        if (t.ok) {
            alert("‚úÖ Event created!");
            // Event created successfully
            renderOrganizer();
            renderEvents();
        } else {
            const data = await t.json();
            alert("Error: " + (data.error || "Failed to create event."));
        }
    }, 2000);
}
async function editEvent(e) {
    const t = await fetch(API + "/events"), n = await t.json(), a = n.events.find(t => t.id === e);
    const i = new Date().toISOString().split("T")[0];
    const venues = ["LH-C", "LH-D", "LH-A", "LHB (MB)", "SJA", "MAIN BUILDING", "SEMINAR HALL A (MB)", "SEMINAR HALL B (MB)", "SEMINAR HALL C (MB)", "OPEN THEATER", "NEW SPORTS COMPLEX", "MAIN GROUND", "NITK BEACH", "CRF", "GYM"];
    let venueOptions = venues.map(v => `<option ${a.venue === v ? 'selected' : ''}>${v}</option>`).join('');
    const categories = ["Education", "Soft Skills", "Sports", "Cultural", "Technology", "Science", "Music", "Art & Craft", "Gaming", "Hackathon", "Workshop", "Seminar", "Conference", "Fest", "Charity", "Water Activities", "Other"];
    let categoryOptions = categories.map(c => `<option ${a.category === c ? 'selected' : ''}>${c}</option>`).join('');
    const o = document.getElementById("modal"), l = document.getElementById("modal-body");
    l.innerHTML = `<h3>Edit Event</h3>
        <input id="editTitle" value="${a.title}">
        <select id="editCategory">${categoryOptions}</select>
        <select id="editVenue">${venueOptions}</select>
        <input id="editDate" type="date" value="${a.date}" min="${i}" onchange="updateMinTime('editDate', 'editTime')">
        <input id="editTime" type="time" value="${a.time}">
        <input id="editCap" type="number" value="${a.capacity}">
        <input id="editDuration" type="number" value="${a.duration}">
        <div style="display: flex; gap: 10px;">
            <button class="btn primary" onclick="saveEventEdit(${e})" style="flex: 1;">Save</button>
            <button class="btn" onclick="closeModal()" style="flex: 1;">Cancel</button>
        </div>`,
    o.style.display = "flex", updateMinTime("editDate", "editTime");
}
async function saveEventEdit(e) {
    const t = {
        date: document.getElementById("editDate").value, time: document.getElementById("editTime").value, title: capitalizeWords(document.getElementById("editTitle").value),
        venue: document.getElementById("editVenue").value, capacity: document.getElementById("editCap").value,
        duration: document.getElementById("editDuration").value, category: document.getElementById("editCategory").value, regNumber: currentUser.regNumber
    };
    if (new Date(`${t.date}T${t.time}`) < new Date) return void alert("Event date and time must be in the future.");
    const n = await fetch(API + "/events/" + e, { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify(t) });
    n.ok ? (closeModal(), renderOrganizer(), renderEvents()) : alert("Error: " + ((await n.json()).error || "Failed to update event."));
}
async function renderOrganizer(){
    const res = await fetch(API + "/events");
    const data = await res.json();
    const c = document.getElementById("screen-organizer");
    
    c.innerHTML = `
        <h2>Organizer Dashboard</h2>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn primary" onclick="createEventScreen()" style="flex:1;">+ Create Event</button>
            <button class="btn" onclick="showCategoryStats()" style="flex:1;">üìä Event Categories Dashboard</button>
        </div>
    `;
    
    if (!data.ok) {
        console.log("‚ùå Organizer dashboard - Could not load events:", data);
        c.innerHTML += `<p class="muted">Could not load events.</p>`;
        return;
    }
    
    console.log("‚úÖ Organizer dashboard - Events loaded:", data.events.length, "events");
    console.log("üîç Current user:", currentUser);
    console.log("üîç All events:", data.events);
    
    if (!currentUser || !currentUser.regNumber) {
        console.log("‚ùå No current user found");
        c.innerHTML += `<p class="muted">Please log in to view your events.</p>`;
        return;
    }
    
    const myEvents = data.events.filter(e => e.creatorRegNumber === currentUser.regNumber);
    console.log("üéØ My events:", myEvents.length, "events");
    if (myEvents.length === 0) {
        c.innerHTML += `<p class="muted">You have not created any events yet.</p>`;
        return;
    }
    
    const organizerDate = new Date;
    const now = new Date;
    const upcomingAndLive = myEvents.filter(e => {
        const endTime = new Date(parseEventDateTime(e.date, e.time).getTime() + (e.duration || 0) * 60000);
        return endTime >= organizerDate;
    }).sort((a, b) => parseEventDateTime(a.date, a.time) - parseEventDateTime(b.date, b.time));
    
    const past = myEvents.filter(e => {
        const endTime = new Date(parseEventDateTime(e.date, e.time).getTime() + (e.duration || 0) * 60000);
        return endTime < organizerDate;
    }).sort((a, b) => parseEventDateTime(b.date, b.time) - parseEventDateTime(a.date, a.time));
    
    const renderSection = (title, events, highlight) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'section-wrapper' + (highlight ? ' highlight-border' : '');
        const h = document.createElement('h3');
        h.className = 'section-title';
        h.textContent = title;
        wrapper.appendChild(h);
        if (events.length === 0) {
            const p = document.createElement('p');
            p.className = 'muted';
            p.textContent = 'No events in this section.';
            wrapper.appendChild(p);
            c.appendChild(wrapper);
            return;
        }
        events.forEach(e => {
            const div = document.createElement("div");
            div.className = "card";
            // Info button (i) top-right
            const infoBtn = document.createElement('button');
            infoBtn.className = 'map-back-arrow';
            infoBtn.style.float = 'right';
            infoBtn.textContent = 'i';
            infoBtn.title = 'Event Details';
            infoBtn.onclick = () => openOrganizerEventInfo(e);
            div.appendChild(infoBtn);
            const startTime = parseEventDateTime(e.date, e.time);
            const endTime = new Date(startTime.getTime() + (e.duration || 0) * 60000);
            let status = "upcoming";
            if (now >= startTime && now < endTime) status = "live";
            else if (now >= endTime) status = "past";
            div.innerHTML = `
                <div class="category-badge">${e.category || 'General'}</div>
                <div class="info-dot" title="Event Info" onclick="openOrganizerEventInfoById(${e.id})">i</div>
                <b style="font-size:1.05rem;color:#fbbf24;">${capitalizeWords(e.title)}</b>
                <div class="kv organizer-kv">
                    <b>Venue:</b> <span class="value">${capitalizeWords(e.venue)}</span>
                    <b>Date:</b> <span class="value">${e.date}</span>
                    <b>Time:</b> <span class="value">${e.time}</span>
                    <b>Seats:</b> <span class="value">${e.taken}/${e.capacity}</span>
                </div>`;
            let buttons = `<button class="btn" onclick="showEventBookings(${e.id})">View Bookings</button><button class="btn" onclick='showEventIdCard(${JSON.stringify(e)})'>üí≥ View Event ID</button><button class="btn" onclick='openOrganizerMessages(${e.id})'>üí¨ Messages</button><button class="btn" onclick='openWaitlistModal(${e.id}, "${e.title.replace(/"/g,'&quot;')}")'>üïí Waitlist</button>`;
            buttons += `<button class="btn" onclick='openVolunteersModal(${e.id}, "${e.title.replace(/"/g,'&quot;')}")'>ü§ù Volunteers</button>`;
            if (status === "live") {
                buttons += `<button class="btn" onclick='showEventMediaModal(${JSON.stringify(e)})'>üñºÔ∏è Manage Media</button>`;
            } else if (status === "upcoming") {
                buttons += `<button class="btn" onclick='showEventMediaModal(${JSON.stringify(e)})'>üñºÔ∏è Manage Media</button><button class="btn" onclick="editEvent(${e.id})">‚úèÔ∏è Edit</button><button class="btn" onclick="deleteEvent(${e.id}, '${e.title}')">üóëÔ∏è Delete</button>`;
            } else if (status === "past") {
                // Allow managing media for past events too
                buttons += `<button class="btn" onclick='showEventMediaModal(${JSON.stringify(e)})'>üñºÔ∏è Manage Media</button>`;
            }
            div.innerHTML += `<div class="card-buttons">${buttons}</div>`;
            wrapper.appendChild(div);
        });
        c.appendChild(wrapper);
    };
    
    renderSection("Upcoming & Live Events", upcomingAndLive, false);
    renderSection("Past Events", past, true);
}
function openOrganizerEventInfo(e){
    const modal = document.getElementById('modal');
    const body = document.getElementById('modal-body');
    const creatorName = e.creatorName || 'Organizer';
    const resources = (e.resources && e.resources.length>0) ? e.resources.join(', ') : 'None';
    body.innerHTML = `
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
            <a class="map-back-arrow" onclick="closeModal()">‚Üê</a>
            <h3 style="margin:0;">Event Info</h3>
        </div>
        <div class="card">
            <div class="kv"><b>Event:</b> <span class="value">${capitalizeWords(e.title)}</span></div>
            <div class="kv"><b>Organizer:</b> <span class="value">${escapeHtml(creatorName)}</span></div>
            <div class="kv"><b>Date:</b> <span class="value">${e.date}</span></div>
            <div class="kv"><b>Time:</b> <span class="value">${e.time}</span></div>
            <div class="kv"><b>Resources:</b> <span class="value">${escapeHtml(resources)}</span></div>
        </div>
    `;
    modal.style.display='flex';
}
async function leaveVolunteer(eventId){
    if(!currentUser) return;
    if(!confirm('Cancel your volunteer role for this event?')) return;
    try{
        const res = await fetch(API + '/volunteers/leave', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ eventId, regNumber: currentUser.regNumber }) });
        const data = await res.json();
        if(res.ok && data.ok){
            alert('Volunteer role cancelled.');
            renderEvents();
        } else {
            alert('Error: ' + (data.error || 'Failed'));
        }
    }catch{ alert('Network error'); }
}

async function openOrganizerEventInfoById(eventId){
    try{
        let e = (window.__eventsCache||[]).find(x => x.id === eventId);
        if(!e){
            const res = await fetch(API + '/events');
            const data = await res.json();
            e = (data.events||[]).find(x => x.id === eventId);
        }
        if(e){ openOrganizerEventInfo(e); }
    }catch(_){ /* ignore */ }
}

// Organizer: Category stats
async function showCategoryStats(){
    const res = await fetch(API + "/events");
    const data = await res.json();
    const c = document.getElementById("screen-organizer");
    if (!data.ok) { alert("Failed to load events"); return; }
    const myEvents = (data.events||[]).filter(e => e.creatorRegNumber === currentUser.regNumber);
    const counts = {};
    myEvents.forEach(e => { const k = e.category || 'Other'; counts[k] = (counts[k]||0) + 1; });
    const entries = Object.entries(counts).sort((a,b)=> b[1]-a[1]);
    const summary = entries.map(([k,v]) => `${k}: ${v} event${v!==1?'s':''}`).join(', ');
    c.innerHTML = `
        <h2>Event Categories Dashboard</h2>
        <p class="muted">${summary || 'No events created yet.'}</p>
        <div class="card">
            ${entries.map(([k,v]) => `<div class="kv"><b>${k}</b> <span class="value">${v}</span></div>`).join('')}
        </div>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn" onclick="renderOrganizer()">Back</button>
        </div>
    `;
}

// Organizer: Waitlist dashboard per event
async function showWaitlistDashboard(){
    const res = await fetch(API + "/events");
    const data = await res.json();
    const c = document.getElementById("screen-organizer");
    if (!data.ok) { alert("Failed to load events"); return; }
    const myEvents = (data.events||[]).filter(e => e.creatorRegNumber === currentUser.regNumber);
    if (myEvents.length === 0) { c.innerHTML = `<h2>Waitlist System</h2><p class="muted">No events.</p><button class="btn" onclick="renderOrganizer()">Back</button>`; return; }
    c.innerHTML = `<h2>Waitlist System</h2>`;
    myEvents.forEach(e => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `<b>${capitalizeWords(e.title)}</b><div class="muted">${e.date} ${e.time} ‚Ä¢ ${capitalizeWords(e.venue)}</div><div id="wl-${e.id}" class="muted">Loading waitlist‚Ä¶</div>`;
        c.appendChild(card);
        loadWaitlistForEvent(e.id);
    });
    const backRow = document.createElement('div'); backRow.style.display='flex'; backRow.style.gap='10px'; backRow.style.marginTop='10px';
    backRow.innerHTML = `<button class="btn" onclick="renderOrganizer()">Back</button>`; c.appendChild(backRow);
}

async function loadWaitlistForEvent(eventId){
    try{
        const res = await fetch(`${API}/waitlist/${eventId}?organizerReg=${currentUser.regNumber}`);
        const data = await res.json();
        const el = document.getElementById(`wl-${eventId}`);
        if (!res.ok || !data.ok) { el.textContent = 'Failed to load waitlist.'; return; }
        if (!data.waitlist || data.waitlist.length === 0) { el.textContent = 'No users on waitlist.'; return; }
        el.innerHTML = data.waitlist.map((w,i)=> `<div class="kv"><b>#${i+1}</b> <span class="value waitlist-name" style="cursor: pointer; color: #93c5fd;" data-event-id="${eventId}" data-reg-number="${w.regNumber}" data-name="${w.name}">${w.name} (${w.regNumber})</span></div>`).join('');
        
        // Add click event listeners to all waitlist names
        el.querySelectorAll('.waitlist-name').forEach(span => {
            span.addEventListener('click', function() {
                const eventId = this.getAttribute('data-event-id');
                const regNumber = this.getAttribute('data-reg-number');
                const name = this.getAttribute('data-name');
                showWaitlistTicketDetails(eventId, regNumber, name);
            });
        });
    }catch(err){ const el = document.getElementById(`wl-${eventId}`); if(el) el.textContent = 'Failed to load waitlist.'; }
}

async function showWaitlistTicketDetails(eventId, regNumber, name){
    try {
        const res = await fetch(`${API}/waitlist/${eventId}?organizerReg=${currentUser.regNumber}`);
        const data = await res.json();
        if (!res.ok || !data.ok) { alert('Failed to load waitlist details'); return; }
        
        const waitlistEntry = data.waitlist.find(w => w.regNumber === regNumber);
        if (!waitlistEntry) { alert('Waitlist entry not found'); return; }
        
        const position = data.waitlist.findIndex(w => w.regNumber === regNumber) + 1;
        
        const modal = document.getElementById('modal');
        const body = document.getElementById('modal-body');
        body.innerHTML = `
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                <a class="map-back-arrow" onclick="closeModal()">‚Üê</a>
                <h3 style="margin:0;">üìã Waitlist Ticket Details</h3>
            </div>
            <div class="card">
                <div class="kv">
                    <b>Name:</b> <span class="value">${name}</span>
                </div>
                <div class="kv">
                    <b>Registration Number:</b> <span class="value">${regNumber}</span>
                </div>
                <div class="kv">
                    <b>Position in Queue:</b> <span class="value">#${position}</span>
                </div>
                <div class="kv">
                    <b>Joined Waitlist:</b> <span class="value">${new Date(waitlistEntry.time).toLocaleString()}</span>
                </div>
                <div class="kv">
                    <b>Waitlist ID:</b> <span class="value">${waitlistEntry.id}</span>
                </div>
                <div class="kv">
                    <b>Status:</b> <span class="value" style="color: #f59e0b;">‚è≥ Waiting</span>
                </div>
            </div>
            <div style="margin-top: 10px;">
                <button class="btn" onclick="closeModal()">Close</button>
            </div>
        `;
        modal.style.display = 'flex';
    } catch(err) {
        alert('Failed to load waitlist ticket details');
    }
}

function openWaitlistModal(eventId, title){
    const modal = document.getElementById('modal');
    const body = document.getElementById('modal-body');
    body.innerHTML = `
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
            <a class="map-back-arrow" onclick="closeModal()">‚Üê</a>
            <h3 style="margin:0;">Waitlist ‚Äì ${capitalizeWords(title)}</h3>
        </div>
        <div id="waitlist-modal-list" class="card" style="max-height:360px; overflow:auto"></div>
    `;
    modal.style.display = 'flex';
    loadWaitlistModalList(eventId);
}

async function loadWaitlistModalList(eventId){
    try{
        const res = await fetch(`${API}/waitlist/${eventId}?organizerReg=${currentUser.regNumber}`);
        const data = await res.json();
        const list = document.getElementById('waitlist-modal-list');
        if(!res.ok || !data.ok){ list.innerHTML = '<p class="muted">Failed to load waitlist.</p>'; return; }
        if(!data.waitlist || data.waitlist.length===0){ list.innerHTML = '<p class="muted">No users on waitlist.</p>'; return; }
        list.innerHTML = data.waitlist.map((w,i)=> `<div class="kv"><b>#${i+1}</b> <span class="value">${w.name} (${w.regNumber})</span></div>`).join('');
    }catch(err){ const list = document.getElementById('waitlist-modal-list'); if(list) list.innerHTML = '<p class="muted">Failed to load waitlist.</p>'; }
}

// Organizer: Volunteers modal
function openVolunteersModal(eventId, title){
    const modal = document.getElementById('modal');
    const body = document.getElementById('modal-body');
    body.innerHTML = `
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
            <a class="map-back-arrow" onclick="closeModal()">‚Üê</a>
            <h3 style="margin:0;">Volunteers ‚Äì ${capitalizeWords(title)}</h3>
        </div>
        <div class="card">
            <div style="display:flex; flex-direction:column; gap:8px;">
                <input id="volAddReg" placeholder="RegNumber">
                <div style="display:flex; gap:8px; align-items:center;">
                    <button class="btn" onclick="verifyVolunteerReg('volAddReg','volAddStatus','volAddRoleRow', currentUser.regNumber)">Verify</button>
                    <button class="btn" onclick="(document.getElementById('volAddReg').value='',(document.getElementById('volAddStatus').textContent=''),(document.getElementById('volAddRoleRow').style.display='none'))">Clear</button>
                    <span id="volAddStatus" class="muted"></span>
                </div>
                <div id="volAddRoleRow" style="display:none;">
                    <select id="volAddRole">
                        ${VOL_ROLES.map(r=>`<option>${r}</option>`).join('')}
                    </select>
                </div>
                <div style="display:flex; gap:8px; align-items:center;">
                    <button class="btn primary" onclick="addVolunteer(${eventId})">Add</button>
                </div>
            </div>
        </div>
        <div id="volList" class="card" style="max-height:360px; overflow:auto; margin-top:10px"></div>
    `;
    modal.style.display = 'flex';
    loadVolunteersList(eventId);
    try{ if(__modalIntervals[`vol-${eventId}`]) clearInterval(__modalIntervals[`vol-${eventId}`]); __modalIntervals[`vol-${eventId}`] = setInterval(()=>{ try{ loadVolunteersList(eventId); }catch{} }, 5000); }catch{}
}
async function loadVolunteersList(eventId){
    try{
        const res = await fetch(`${API}/volunteers/${eventId}?organizerReg=${currentUser.regNumber}`);
        const data = await res.json();
        const el = document.getElementById('volList');
        if(!res.ok || !data.ok){ el.textContent = 'Failed to load volunteers.'; return; }
        const list = Array.isArray(data.volunteers) ? data.volunteers : [];
        if(list.length===0){ el.textContent = 'No volunteers yet.'; return; }
        // Group by regNumber; prefer accepted over pending/rejected to avoid duplicates
        const byReg = new Map();
        list.forEach(v => {
            const status = (v.status||'accepted').toLowerCase();
            const existing = byReg.get(v.regNumber);
            if(!existing) { byReg.set(v.regNumber, v); return; }
            // If any entry is accepted, keep accepted
            const existingAccepted = (existing.status||'accepted').toLowerCase()==='accepted';
            const currentAccepted = status==='accepted';
            if(currentAccepted && !existingAccepted) byReg.set(v.regNumber, v);
        });
        const deduped = Array.from(byReg.values());
        const accepted = deduped.filter(v => (v.status||'accepted').toLowerCase()==='accepted');
        const pending = deduped.filter(v => (v.status||'accepted').toLowerCase()==='pending');
        const rejected = deduped.filter(v => (v.status||'accepted').toLowerCase()==='rejected');

        const renderRow = (v) => {
            const status = (v.status || 'accepted').toLowerCase();
            const labelColor = status==='pending' ? '#60a5fa' : status==='rejected' ? '#ef4444' : '#10b981';
            const labelText = status==='accepted' ? `ID ${v.volunteerId||'-'}` : status.toUpperCase();
            const action = status==='accepted' ? `<button class=\"btn\" style=\"border-color: var(--red-accent); color: var(--red-accent);\" onclick=\"removeVolunteer(${eventId}, '${v.regNumber}')\">Cancel</button>` : '';
            return `
            <div class=\"kv\" style=\"display:flex; align-items:center; gap:12px; justify-content:space-between;\"> 
                <div style=\"display:flex; align-items:flex-start; gap:12px; flex:1;\">
                    <b style=\"min-width:72px; color:${labelColor};\">${labelText}</b>
                    <div style=\"display:flex; flex-direction:column; gap:2px;\">
                        <span style=\"color:#e5e7eb; font-weight:700;\">${v.name} (${v.regNumber})</span>
                        <span class=\"muted\" style=\"color:#cbd5e1;\">‚Äî ${v.role||''}</span>
                </div>
                </div>
                ${action}
            </div>`;
        };

        const sections = [];
        if(accepted.length>0){ sections.push(`<div style=\"margin-bottom:8px;\"><div class=\"muted\" style=\"margin:4px 0;\">Accepted</div>${accepted.map(renderRow).join('')}</div>`); }
        if(pending.length>0){ sections.push(`<div style=\"margin-bottom:8px;\"><div class=\"muted\" style=\"margin:4px 0;\">Pending</div>${pending.map(renderRow).join('')}</div>`); }
        if(rejected.length>0){ sections.push(`<div style=\"margin-bottom:8px;\"><div class=\"muted\" style=\"margin:4px 0;\">Rejected</div>${rejected.map(renderRow).join('')}</div>`); }
        el.innerHTML = sections.join('');

        // Update role dropdown to exclude used roles (accepted only)
        const used = new Set(accepted.map(v=> v.role));
        const roleSel = document.getElementById('volAddRole');
        if(roleSel){
            roleSel.innerHTML = VOL_ROLES.filter(r=> !used.has(r)).map(r=>`<option>${r}</option>`).join('') || '<option disabled selected>All roles used</option>';
        }
    }catch(err){ const el = document.getElementById('volList'); if(el) el.textContent='Failed to load volunteers.'; }
}
async function addVolunteer(eventId){
    const input = document.getElementById('volAddReg');
    const roleSel = document.getElementById('volAddRole');
    if(!input) return;
    const reg = String(input.value||'').trim();
    const role = String(roleSel?.value||'').trim();
    if(!reg) return alert('Enter reg number');
    if(!role) return alert('Select a role');
    const res = await fetch(`${API}/volunteers/add`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ eventId, organizerReg: currentUser.regNumber, regNumber: reg, role }) });
    const data = await res.json();
    if(res.ok && data.ok){ alert('Request sent. Awaiting user confirmation.'); loadVolunteersList(eventId); renderEvents(); }
    else { alert('Error: ' + (data.error || 'Failed to add volunteer.')); }
}
async function removeVolunteer(eventId, reg){
    if(!confirm('Cancel this volunteer?')) return;
    const res = await fetch(`${API}/volunteers/remove`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ eventId, organizerReg: currentUser.regNumber, regNumber: reg }) });
    const data = await res.json();
    if(res.ok && data.ok){ alert('Volunteer cancelled.'); loadVolunteersList(eventId); renderEvents(); }
    else { alert('Error: ' + (data.error || 'Failed to cancel volunteer.')); }
}

// Volunteer ID Card modal for current user (from Home)
async function openVolunteerIdCard(eventId){
    try{
        const res = await fetch(API + '/events');
        const data = await res.json();
        if(!res.ok || !data.ok) return alert('Failed to load');
        const e = (data.events||[]).find(x=> x.id === eventId);
        if(!e) return alert('Event not found');
        const v = (e.volunteers||[]).find(v=> v.regNumber === currentUser.regNumber) || {};
        const modal = document.getElementById('modal');
        const body = document.getElementById('modal-body');
        body.innerHTML = `
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                <a class="map-back-arrow" onclick="closeModal()">‚Üê</a>
                <h3 style="margin:0;">Volunteer ID</h3>
            </div>
            <div class="card" style="border-color:#10b981; background:#052e1c;">
                <div class="kv">
                    <b>Volunteer</b> <span class="value">${capitalizeWords(e.title)}</span>
                    <b>Organizer</b> <span class="value">${capitalizeWords(e.creatorName || '')}</span>
                    <b>Date</b> <span class="value">${e.date}</span>
                    <b>Time</b> <span class="value">${e.time}</span>
                    <b>Role</b> <span class="value">${v.role || ''}</span>
                    <b>Volunteer ID</b> <span class="value">${v.volunteerId || ''}</span>
                </div>
            </div>`;
        modal.style.display = 'flex';
    }catch(err){ alert('Failed to open ID'); }
}

// User: Join waitlist
async function joinWaitlist(eventId){
    try{
        const res = await fetch(API + '/waitlist', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ eventId, regNumber: currentUser.regNumber }) });
        const data = await res.json();
        if(res.ok && data.ok){ 
            alert('‚úÖ Added to waitlist. You will be auto-booked when a seat opens.'); 
            await renderTickets(true); // Refresh userTickets array
            // Clear events cache to force fresh data
            window.__eventsCache = null;
            renderEvents(); 
        }
        else { alert('‚ùå ' + (data.error || 'Failed to join waitlist')); }
    }catch(err){ alert('‚ùå Network error'); }
}

function openOrganizerMessages(eventId){
    const body = document.getElementById('modal-body');
    body.innerHTML = `<div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;"><a class="map-back-arrow" onclick="closeModal()">‚Üê</a><h3 style="margin:0;">üí¨ Messages</h3></div><div class="card"><div class="sub-nav"><button id="tabPrimary" class="sub-nav-btn active" onclick="setConvTab('primary')">Primary (Volunteers)</button><button id="tabGeneral" class="sub-nav-btn" onclick="setConvTab('general')">General</button><button id="tabFeedback" class="sub-nav-btn" onclick="setConvTab('feedback')">üìù Feedback</button></div><div id="convList" style="max-height:360px; overflow:auto; padding:8px;"></div></div>`;
    document.getElementById('modal').style.display = 'flex';
    loadOrganizerConversations(eventId);
}

async function loadOrganizerConversations(eventId){
    try{
        const res = await fetch(`${API}/messages/conversations?eventId=${eventId}&organizerReg=${currentUser.regNumber}`);
        const data = await res.json();
        window.__convCache = data.users || [];
        window.__convEventId = eventId;
        renderConvList('primary');
    }catch(err){ document.getElementById('convList').innerHTML = '<p class="muted">Error loading conversations.</p>'; }
}
function setConvTab(tab){
    document.getElementById('tabPrimary').classList.toggle('active', tab==='primary');
    document.getElementById('tabGeneral').classList.toggle('active', tab==='general');
    if(document.getElementById('tabFeedback')){
        document.getElementById('tabFeedback').classList.toggle('active', tab==='feedback');
    }
    if(tab === 'feedback'){
        loadOrganizerFeedbacks(window.__convEventId);
    } else {
        renderConvList(tab);
    }
}
function renderConvList(tab){
    const list = document.getElementById('convList');
    const users = (window.__convCache||[]).filter(u => tab==='primary' ? u.volunteer : !u.volunteer);
    if(users.length===0){ list.innerHTML = '<p class="muted">No messages.</p>'; return; }
    list.innerHTML = users.map(u => {
        const dot = u.unread > 0 ? `<span style='display:inline-block; width:8px; height:8px; background:#ef4444; border-radius:50%; margin-left:6px;'></span>` : '';
        return `<div class="detail-item" style="cursor:pointer" onclick="openOrganizerThread(${window.__convEventId}, '${u.regNumber}', '${(u.name||'').replace(/'/g, "&#39;")}')"><b>${capitalizeWords(u.name||u.regNumber)}</b>${dot}<div class="muted">${u.regNumber}</div></div>`;
    }).join('');
}
async function loadOrganizerFeedbacks(eventId){
    try{
        const list = document.getElementById('convList');
        const res = await fetch(`${API}/feedback/${eventId}?organizerReg=${currentUser.regNumber}`);
        const data = await res.json();
        if(!data.ok || !data.feedbacks || data.feedbacks.length === 0){
            list.innerHTML = '<p class="muted">No feedback received yet.</p>';
            return;
        }
        list.innerHTML = data.feedbacks.map(f => {
            return `<div class="detail-item" style="cursor:pointer" onclick="showStudentFeedback(${eventId}, '${f.userRegNumber}', '${(f.userName||'').replace(/'/g, "&#39;")}')"><b>${capitalizeWords(f.userName||f.userRegNumber)}</b><div class="muted">${f.userRegNumber}</div><div class="muted" style="font-size:0.85rem; margin-top:4px;">Rating: ${f.seatCapacityRating}/3</div></div>`;
        }).join('');
    }catch(err){
        document.getElementById('convList').innerHTML = '<p class="muted">Error loading feedbacks.</p>';
    }
}
async function showStudentFeedback(eventId, regNumber, studentName){
    try{
        const res = await fetch(`${API}/feedback/${eventId}/${regNumber}?organizerReg=${currentUser.regNumber}`);
        const data = await res.json();
        if(!data.ok || !data.feedback){
            alert('Feedback not found');
            return;
        }
        const f = data.feedback;
        const body = document.getElementById('modal-body');
        body.innerHTML = `
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                <a class="map-back-arrow" onclick="loadOrganizerFeedbacks(${eventId})">‚Üê</a>
                <h3 style="margin:0;">üìù Feedback ‚Äì ${capitalizeWords(studentName||regNumber)}</h3>
            </div>
            <div class="card">
                <div class="kv"><b>Student:</b> <span class="value">${capitalizeWords(f.userName||regNumber)}</span></div>
                <div class="kv"><b>Reg Number:</b> <span class="value">${f.userRegNumber}</span></div>
                <div class="kv"><b>Seat Capacity Rating:</b> <span class="value">${f.seatCapacityRating}/3</span></div>
                <div style="margin-top:12px;"><b>Review:</b></div>
                <div style="padding:12px; background:#1a1a1a; border-radius:8px; margin-top:8px; border:1px solid var(--border);">
                    <p style="margin:0; white-space:pre-wrap; line-height:1.6;">${escapeHtml(f.review)}</p>
                </div>
                <div class="muted" style="margin-top:8px; font-size:0.85rem;">Submitted: ${new Date(f.submittedAt).toLocaleString()}</div>
            </div>
        `;
    }catch(err){
        alert('Error loading feedback');
    }
}

function openOrganizerThread(eventId, studentReg, studentName){
    const body = document.getElementById('modal-body');
    body.innerHTML = `
        <div class="chat-container" style="height:75%; display:flex; flex-direction:column; overflow:hidden">
          <h3 style="margin-top:0">üí¨ Chat ‚Äì ${capitalizeWords(studentName||studentReg)}</h3>
          <div id="chatThread" style="flex:1; overflow-y:auto; overflow-x:hidden; background: #111; padding:10px; border-radius:8px; border:1px solid var(--border); margin-bottom:10px"></div>
          <div class="chat-composer">
              <input id="chatInput" class="chat-input" placeholder="Message" onkeydown="if(event.key==='Enter'){sendOrganizerReply(${eventId}, '${studentReg}')}" />
              <input type="file" id="orgChatFile" accept="image/*,video/*" style="display:none" onchange="sendOrganizerMedia(${eventId}, '${studentReg}')">
              <button class="chat-attach" title="Attach" onclick="document.getElementById('orgChatFile').click()">üìé</button>
              <button class="chat-send" title="Send" onclick="sendOrganizerReply(${eventId}, '${studentReg}')">‚û§</button>
          </div>
          <div id="chatMsg" class="muted" style="margin:6px 0;"></div>
          <div style="display:flex; justify-content:flex-end;"><button class="btn" style="width:auto" onclick="openOrganizerMessages(${eventId})">Back</button></div>
        </div>
    `;
    document.getElementById('modal').style.display = 'flex';
    loadChatThread(eventId, currentUser.regNumber, studentReg);
  try{ if(__modalIntervals[`org-chat-${eventId}-${currentUser.regNumber}-${studentReg}`]) clearInterval(__modalIntervals[`org-chat-${eventId}-${currentUser.regNumber}-${studentReg}`]); __modalIntervals[`org-chat-${eventId}-${currentUser.regNumber}-${studentReg}`] = setInterval(()=>{ try{ loadChatThread(eventId, currentUser.regNumber, studentReg); }catch{} }, 3000); }catch{}
}

async function sendOrganizerReply(eventId, studentReg){
    const input = document.getElementById('chatInput');
    const msgBar = document.getElementById('chatMsg');
    const text = (input.value||'').trim();
    if(!text){ msgBar.textContent = 'Type a message'; return; }
    const thread = document.getElementById('chatThread');
    thread.innerHTML += `<div style="text-align:right; margin:6px 0;"><span style="display:inline-block; padding:8px 10px; border-radius:10px; background:#2563eb; color:white; max-width:80%;">${text}</span><div class="muted" style="font-size:0.75rem;">sending‚Ä¶</div></div>`;
    thread.scrollTop = thread.scrollHeight;
    input.value = '';
    try{
        const res = await fetch(API + '/messages', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ eventId, fromReg: currentUser.regNumber, toReg: studentReg, text }) });
        const data = await res.json();
        if(res.ok && data.ok){ msgBar.textContent = '‚úÖ Message sent'; setTimeout(()=> msgBar.textContent = '', 1200); loadChatThread(eventId, currentUser.regNumber, studentReg); }
        else { msgBar.textContent = '‚ùå ' + (data.error || 'Failed to send'); }
    }catch(err){ msgBar.textContent = '‚ùå Network error'; }
}

async function sendOrganizerMedia(eventId, studentReg){
    const input = document.getElementById('orgChatFile');
    const msgBar = document.getElementById('chatMsg');
    if(!input.files || input.files.length===0){ msgBar.textContent = 'Select an image or video (max 10MB)'; return; }
    const file = input.files[0];
    if(file.size > 10*1024*1024){ msgBar.textContent = '‚ùå File too large (max 10MB)'; return; }
    try{
        const form = new FormData();
        form.append('file', file);
        form.append('eventId', String(eventId));
        form.append('fromReg', currentUser.regNumber);
        form.append('toReg', studentReg);
        const res = await fetch(API + '/messages/media', { method:'POST', body: form });
        const data = await res.json();
        if(res.ok && data.ok){ msgBar.textContent = '‚úÖ Media sent'; setTimeout(()=> msgBar.textContent='', 1200); loadChatThread(eventId, currentUser.regNumber, studentReg); }
        else { msgBar.textContent = '‚ùå ' + (data.error || 'Failed to send media'); }
    }catch(err){ msgBar.textContent = '‚ùå Network error'; }
}
async function deleteEvent(e,t){if(confirm(`Are you sure you want to permanently delete the event "${t}"? This will notify all booked users and delete all associated media.`)){const t=await fetch(API+"/events/"+e,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({regNumber:currentUser.regNumber})});if(t.ok)alert("Event deleted."),renderOrganizer(),renderEvents();else{const e=await t.json();alert("Error: "+e.error)}}}
async function showEventMediaModal(event) {
    const modalBody = document.getElementById("modal-body");
    
    // Show loading state immediately
    modalBody.innerHTML = `
        <h3>Media for ${event.title}</h3>
        <div style="text-align:center; padding:20px;">
            <div style="display:inline-block; width:30px; height:30px; border:3px solid #f3f3f3; border-top:3px solid #007bff; border-radius:50%; animation:spin 1s linear infinite;"></div>
            <br><br>Loading media files...
        </div>
    `;
    document.getElementById("modal").style.display = "flex";
    
    try {
        const eventsRes = await fetch(API + "/events");
        const eventsData = await eventsRes.json();
        const eventData = eventsData.events.find(e => e.id === event.id);
        
        let mediaHtml = '<div class="media-grid">';
        
        if (eventData.media && eventData.media.length > 0) {
            eventData.media.forEach(media => {
                mediaHtml += '<div class="media-item">';
                if (media.type === "photo") {
                    // Handle Cloudinary URLs (full HTTPS URLs), legacy GridFS (_id), and relative paths
                    let mediaUrl = media.url;
                    if (media.url && (media.url.startsWith('http://') || media.url.startsWith('https://'))) {
                        // Cloudinary URL - use directly
                        mediaUrl = media.url;
                    } else if (media._id) {
                        // Legacy GridFS
                        mediaUrl = `${API_BASE}/api/media/file/${media._id}`;
                    } else if (media.url) {
                        // Relative path
                        mediaUrl = media.url.startsWith('/') ? `${API_BASE}${media.url}` : `${API_BASE}/${media.url}`;
                    }
                    mediaHtml += `<img src="${mediaUrl}" onclick="showLightbox('${media.url || media._id}', 'photo')">`;
                } else if (media.type === "video") {
                    // Handle Cloudinary URLs (full HTTPS URLs), legacy GridFS (_id), and relative paths
                    let mediaUrl = media.url;
                    if (media.url && (media.url.startsWith('http://') || media.url.startsWith('https://'))) {
                        // Cloudinary URL - use directly
                        mediaUrl = media.url;
                    } else if (media._id) {
                        // Legacy GridFS
                        mediaUrl = `${API_BASE}/api/media/file/${media._id}`;
                    } else if (media.url) {
                        // Relative path
                        mediaUrl = media.url.startsWith('/') ? `${API_BASE}${media.url}` : `${API_BASE}/${media.url}`;
                    }
                    mediaHtml += `
                        <div class="video-container" style="position: relative;">
                            <video src="${mediaUrl}" 
                                   preload="metadata" 
                                   playsinline 
                                   webkit-playsinline 
                                   data-media-id="${media._id || media.url}"
                                   onloadstart="showVideoLoading(this)"
                                   onprogress="updateVideoProgress(this, event)"
                                   oncanplay="hideVideoLoading(this)"
                                   onerror="hideVideoLoading(this)"
                                   onloadedmetadata="this.currentTime=1;"
                                   style="cursor: pointer;">
                            </video>
                            <div class="video-loading-overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; flex-direction: column;">
                                <div class="loading-spinner" style="width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px;"></div>
                                <div class="loading-text" style="color: white; font-size: 12px; text-align: center;">Loading...</div>
                                <div class="progress-bar" style="width: 80%; height: 4px; background: #333; border-radius: 2px; margin-top: 5px;">
                                    <div class="progress-fill" style="height: 100%; background: #007bff; border-radius: 2px; width: 0%; transition: width 0.3s ease;"></div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                mediaHtml += `<span class="delete-media-btn" onclick="deleteMedia(${media.id}, ${event.id})">‚úñ</span></div>`;
            });
        } else {
            mediaHtml += '<p class="muted" style="grid-column: 1 / -1;">No media uploaded for this event yet.</p>';
        }
        
        mediaHtml += "</div>";
        
        // Add upload progress meter
        const uploadProgressHtml = `
            <div id="upload-progress" style="display: none; margin: 10px 0;">
                <div style="background: #f0f0f0; border-radius: 10px; padding: 3px;">
                    <div id="upload-progress-bar" style="background: #4CAF50; height: 20px; border-radius: 8px; width: 0%; transition: width 0.3s ease;"></div>
                </div>
                <div id="upload-progress-text" style="text-align: center; margin-top: 5px; font-size: 14px;">Uploading...</div>
            </div>
        `;
        
        // Update modal content with media
        modalBody.innerHTML = `
            <h3>Media for ${event.title}</h3>
            ${mediaHtml}
            ${uploadProgressHtml}
            <div style="display:flex; gap:10px; margin-top: 15px;">
                <button class="btn primary" onclick="triggerMediaUpload(${event.id})">Upload Image/Video (Max 30MB)</button>
                <input type="file" id="eventMediaFile" accept="image/*,video/*" style="display:none">
            </div>
        `;
        
    } catch (error) {
        console.error('Error loading media:', error);
        modalBody.innerHTML = `
            <h3>Media for ${event.title}</h3>
            <div style="text-align:center; padding:20px; color:red;">
                <p>Error loading media files.</p>
                <button class="btn primary" onclick="showEventMediaModal(${JSON.stringify(event).replace(/"/g, '&quot;')})">Retry</button>
            </div>
        `;
    }
}
async function deleteMedia(e,t){if(confirm("Are you sure you want to delete this media file? This action cannot be undone.")){const n=await fetch(`${API}/media/${e}`,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({regNumber:currentUser.regNumber})});if(n.ok){const e=await fetch(API+"/events"),n=await e.json(),a=n.events.find(e=>e.id===t);showEventMediaModal(a)}else{const e=await n.json();alert("Error: "+(e.error||"Failed to delete media."))}}}
function triggerMediaUpload(e){const t=document.getElementById('eventMediaFile')||(()=>{const f=document.createElement('input');f.type='file';f.accept='image/*,video/*';f.style.display='none';f.id='eventMediaFile';document.body.appendChild(f);return f;})();t.onchange=()=>{t.files&&t.files[0]&&uploadMediaForEvent(e,t.files[0])};t.click()}
async function uploadMediaForEvent(eventId, file) {
    try {
        // Check file size before upload (30MB limit)
        const maxSize = 30 * 1024 * 1024; // 30MB in bytes
        if (file.size > maxSize) {
            alert(`File is too large! Please upload a file less than 30MB.\n\nYour file: ${(file.size / (1024 * 1024)).toFixed(1)}MB\nMax allowed: 30MB`);
            return;
        }
        
        // Show progress meter
        const progressDiv = document.getElementById('upload-progress');
        const progressBar = document.getElementById('upload-progress-bar');
        const progressText = document.getElementById('upload-progress-text');
        
        if (progressDiv) {
            progressDiv.style.display = 'block';
            progressText.textContent = `Uploading ${file.name}...`;
        }
        
        const fd = new FormData();
        fd.append('file', file);
        fd.append('eventId', String(eventId));
        fd.append('regNumber', currentUser.regNumber);
        
        // Simulate progress for better UX
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += Math.random() * 10;
            if (progress > 90) progress = 90;
            if (progressBar) {
                progressBar.style.width = progress + '%';
                progressText.textContent = `Uploading ${file.name}... ${Math.round(progress)}%`;
            }
        }, 200);
        
        const res = await fetch(API + '/media', {
            method: 'POST',
            body: fd
        });
        
        clearInterval(progressInterval);
        
        if (progressBar) {
            progressBar.style.width = '100%';
            progressText.textContent = 'Processing...';
        }
        
        const data = await res.json();
        
        if (res.ok && data.ok) {
            if (progressText) {
                progressText.textContent = '‚úÖ Upload successful!';
            }
            setTimeout(() => {
                const evRes = fetch(API + "/events");
                evRes.then(async (response) => {
                    const evData = await response.json();
                    const ev = evData.events.find(e => e.id === eventId);
                    showEventMediaModal(ev);
                });
            }, 1000);
        } else {
            if (progressText) {
                progressText.textContent = '‚ùå Upload failed';
            }
            alert('‚ùå ' + (data.error || 'Upload failed'));
        }
    } catch (err) {
        const progressText = document.getElementById('upload-progress-text');
        if (progressText) {
            progressText.textContent = '‚ùå Network error';
        }
        alert('‚ùå Network error');
    }
}

// ---------- Notifications & Misc Helpers ----------
async function checkEventStates(){if(!currentUser)return;const res=await fetch(API+"/events");const data=await res.json();if(!data.ok)return;const eventDate=new Date;const upcomingCount=data.events.filter(e=>{const endTime=new Date(parseEventDateTime(e.date,e.time).getTime()+(e.duration||0)*6e4);return endTime>=eventDate}).length;if(-1===lastUpcomingCount)lastUpcomingCount=upcomingCount;else if(upcomingCount<lastUpcomingCount){lastUpcomingCount=upcomingCount;const currentScreen=document.querySelector('.content[style*="block"]').id.replace("screen-","");"home"===currentScreen&&renderEvents(),"media"===currentScreen&&renderMedia()}}

// Event start notifications with time gaps (15, 20, 20, 5 minutes) and live notifications
async function checkEventStartNotifications() {
    if (!currentUser) return;
    
    try {
        const res = await fetch(API + "/events");
        const data = await res.json();
        if (!data.ok) return;
        
        const notificationDate = new Date();
        const notificationGaps = [60, 45, 25, 5]; // Minutes before event start (60-45=15, 45-25=20, 25-5=20, 5-0=5)
        
        for (const event of data.events) {
            const eventStart = parseEventDateTime(event.date, event.time);
            const eventEnd = new Date(eventStart.getTime() + (event.duration || 0) * 60 * 1000);
            const timeUntilStart = eventStart.getTime() - notificationDate.getTime();
            const timeUntilEnd = eventEnd.getTime() - notificationDate.getTime();
            const minutesUntilStart = Math.floor(timeUntilStart / (1000 * 60));
            
            // Debug logging
            console.log(`Event: ${event.title}, Minutes until start: ${minutesUntilStart}`);
            
            // Check if event is starting within the next hour and matches our notification gaps
            if (timeUntilStart > 0 && timeUntilStart <= 60 * 60 * 1000) { // Within next hour
                for (const gap of notificationGaps) {
                    // Fix the logic: check if we're within 1 minute of the gap
                    if (minutesUntilStart <= gap && minutesUntilStart >= gap - 1) {
                        // Check if we already sent this notification
                        const notificationKey = `event_${event.id}_${gap}min`;
                        if (!localStorage.getItem(notificationKey)) {
                            // Send notification
                            const message = `‚è∞ "${event.title}" starts in ${minutesUntilStart} minute${minutesUntilStart !== 1 ? 's' : ''}!`;
                            
                            console.log(`Sending notification: ${message}`);
                            
                            // Show notification ticker
                            const notificationTicker = document.getElementById("notificationTicker");
                            if (notificationTicker) {
                                notificationTicker.innerHTML = message;
                                notificationTicker.style.display = "block";
                                setTimeout(() => {
                                    notificationTicker.style.display = "none";
                                }, 3000);
                            }
                            
                            // Mark as sent
                            localStorage.setItem(notificationKey, 'sent');
                            
                            // Clean up old notifications (older than 2 hours)
                            setTimeout(() => {
                                localStorage.removeItem(notificationKey);
                            }, 2 * 60 * 60 * 1000);
                            
                            break; // Only send one notification per check
                        }
                    }
                }
            }
            
            // Check if event is live (started but not ended)
            if (timeUntilStart <= 0 && timeUntilEnd > 0) {
                // Check if we already sent live notification
                const liveNotificationKey = `event_${event.id}_live`;
                if (!localStorage.getItem(liveNotificationKey)) {
                    // Send live notification
                    const message = `üî• "${event.title}" is LIVE now!`;
                    
                    console.log(`Sending live notification: ${message}`);
                    
                    // Show notification ticker
                    const notificationTicker = document.getElementById("notificationTicker");
                    if (notificationTicker) {
                        notificationTicker.innerHTML = message;
                        notificationTicker.style.display = "block";
                        setTimeout(() => {
                            notificationTicker.style.display = "none";
                        }, 4000); // Show live notifications a bit longer
                    }
                    
                    // Mark as sent
                    localStorage.setItem(liveNotificationKey, 'sent');
                    
                    // Clean up live notification after event ends (with some buffer)
                    setTimeout(() => {
                        localStorage.removeItem(liveNotificationKey);
                    }, timeUntilEnd + 5 * 60 * 1000); // 5 minutes after event ends
                }
            }
        }
    } catch (error) {
        console.error('Error checking event notifications:', error);
    }
}
function updateMinTime(e,t){const n=document.getElementById(e),a=document.getElementById(t),i=new Date,o=i.toISOString().split("T")[0];n.value===o?a.min=String(i.getHours()).padStart(2,"0")+":"+String(i.getMinutes()).padStart(2,"0"):a.min=null}
async function renderNotifications(){
    try{
        const res = await fetch(API+"/notifications/"+currentUser.regNumber);
        if(!res.ok){ throw new Error('http'); }
        const data = await res.json();
    const c = document.getElementById("screen-notifications");
    c.innerHTML = '';
    if(!data || data.ok === false){ c.innerHTML = '<p class="muted">Failed to load notifications.</p>'; return; }
    const list = Array.isArray(data.notifications) ? data.notifications : [];
    const header = document.createElement('div'); header.innerHTML = `<button class="btn" onclick="markAllAsRead()">Mark all as read</button>`; c.appendChild(header);
    if(list.length === 0){ const p=document.createElement('p'); p.className='muted'; p.textContent='No notifications yet.'; c.appendChild(p); return; }
    list.forEach(n => {
      const card = document.createElement('div'); card.className='card';
      const strongMsg = n.read ? escapeHtml(n.msg||'') : `<strong>${escapeHtml(n.msg||'')}</strong>`;
      card.innerHTML = `${strongMsg}<br><span class="muted">${new Date(n.time).toLocaleString()}</span>`;
      if(n.type==='volunteer_request' && n.eventId){
        const btnWrap = document.createElement('div'); btnWrap.style.marginTop='8px';
        const btn = document.createElement('button'); btn.className='btn primary'; btn.textContent='Respond';
        btn.onclick = (e)=>{ e.stopPropagation(); openVolunteerConfirm(n.eventId); };
        btnWrap.appendChild(btn); card.appendChild(btnWrap);
      }
      card.onclick = ()=> handleNotificationClick(n);
      c.appendChild(card);
    });
  }catch(err){
    const c = document.getElementById("screen-notifications"); c.innerHTML = '<p class="muted">Failed to load notifications.</p>';
  }
}

async function handleNotificationClick(notif){
    if(notif && notif.type === 'feedback' && notif.eventId){
        // Open feedback popup for feedback notifications
        showFeedbackPopup(notif.eventId, notif.eventTitle);
        return;
    }
    if(notif && notif.type === 'chat' && notif.eventId){
        try{
            const res = await fetch(API + '/events');
            const data = await res.json();
            if(!data.ok) return;
            const event = data.events.find(e => e.id === Number(notif.eventId));
            if(!event) return;
            const otherReg = currentUser.regNumber === notif.fromReg ? notif.toReg : notif.fromReg;
            // If current user is organizer, open organizer thread; otherwise open student chat
            if(currentUser.regNumber === event.creatorRegNumber){
                openOrganizerThread(event.id, otherReg, (event.bookings.find(b=>b.regNumber===otherReg)?.name)||otherReg);
            } else {
                openEventChat(event.id, event.title, event.creatorRegNumber);
            }
        }catch(err){}
    }
}
async function showFeedbackPopup(eventId, eventTitle){
    const modal = document.getElementById('modal');
    const body = document.getElementById('modal-body');
    
    // Check if feedback already submitted
    try{
        const checkRes = await fetch(`${API}/feedback/check/${eventId}/${currentUser.regNumber}`);
        const checkData = await checkRes.json();
        
        if(checkData.ok && checkData.submitted && checkData.feedback){
            // Show submitted feedback
            const f = checkData.feedback;
            body.innerHTML = `
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                    <a class="map-back-arrow" onclick="closeModal()">‚Üê</a>
                    <h3 style="margin:0;">üìù Feedback ‚Äì ${escapeHtml(eventTitle||'Event')}</h3>
                </div>
                <div class="card">
                    <div style="margin-bottom:16px; padding:12px; background:#1a3a1a; border-radius:8px; border:1px solid #10b981;">
                        <p style="margin:0; color:#10b981;">‚úÖ Your feedback has been submitted!</p>
                    </div>
                    <div class="kv"><b>Event:</b> <span class="value">${escapeHtml(eventTitle||'Event')}</span></div>
                    <div class="kv"><b>Seat Capacity Rating:</b> <span class="value">${f.seatCapacityRating}/3</span></div>
                    <div style="margin-top:12px;"><b>Your Review:</b></div>
                    <div style="padding:12px; background:#1a1a1a; border-radius:8px; margin-top:8px; border:1px solid var(--border);">
                        <p style="margin:0; white-space:pre-wrap; line-height:1.6;">${escapeHtml(f.review)}</p>
                    </div>
                    <div class="muted" style="margin-top:8px; font-size:0.85rem;">Submitted: ${new Date(f.submittedAt).toLocaleString()}</div>
                    <p class="muted" style="margin-top:12px; font-size:0.9rem;">‚ö†Ô∏è Feedback cannot be changed after submission.</p>
                </div>
            `;
        } else {
            // Show feedback form
            body.innerHTML = `
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                    <a class="map-back-arrow" onclick="closeModal()">‚Üê</a>
                    <h3 style="margin:0;">üìù Event Feedback ‚Äì ${escapeHtml(eventTitle||'Event')}</h3>
                </div>
                <div class="card">
                    <p class="muted" style="margin-bottom:16px;">Please share your feedback about the event. This cannot be changed after submission.</p>
                    
                    <div style="margin-bottom:16px;">
                        <b>Seat Capacity Rating:</b>
                        <div style="display:flex; gap:12px; margin-top:8px;">
                            <button id="rating2" class="btn" onclick="selectRating(2, ${eventId})" style="flex:1;">2/3</button>
                            <button id="rating3" class="btn" onclick="selectRating(3, ${eventId})" style="flex:1;">3/3</button>
                        </div>
                        <p class="muted" style="font-size:0.85rem; margin-top:4px;">Rate the seat capacity (2 = Below Expectation, 3 = Good)</p>
                    </div>
                    
                    <div style="margin-bottom:16px;">
                        <b>Your Review:</b>
                        <textarea id="feedbackReview" placeholder="Share your experience and suggestions..." style="width:100%; min-height:120px; background:var(--surface); color:var(--text-primary); border:1px solid var(--border); border-radius:12px; padding:14px; margin-top:8px; font-size:1rem; font-family:inherit; resize:vertical;"></textarea>
                    </div>
                    
                    <div id="feedbackMsg" class="muted" style="margin-bottom:12px;"></div>
                    
                    <button class="btn primary" onclick="submitFeedback(${eventId}, '${(eventTitle||'').replace(/'/g, "&#39;")}')" id="submitFeedbackBtn">Submit Feedback</button>
                </div>
            `;
        }
        modal.style.display = 'flex';
    }catch(err){
        alert('Error loading feedback form');
    }
}

let selectedRating = null;
function selectRating(rating, eventId){
    selectedRating = rating;
    document.getElementById('rating2').classList.toggle('active', rating === 2);
    document.getElementById('rating3').classList.toggle('active', rating === 3);
    // Update button styles
    document.getElementById('rating2').style.background = rating === 2 ? 'var(--primary-gradient)' : 'var(--surface)';
    document.getElementById('rating2').style.borderColor = rating === 2 ? 'transparent' : 'var(--border)';
    document.getElementById('rating3').style.background = rating === 3 ? 'var(--primary-gradient)' : 'var(--surface)';
    document.getElementById('rating3').style.borderColor = rating === 3 ? 'transparent' : 'var(--border)';
}

async function submitFeedback(eventId, eventTitle){
    const review = document.getElementById('feedbackReview').value.trim();
    const msgEl = document.getElementById('feedbackMsg');
    const btn = document.getElementById('submitFeedbackBtn');
    
    if(!selectedRating){
        msgEl.textContent = 'Please select a seat capacity rating.';
        msgEl.style.color = '#ef4444';
        return;
    }
    if(!review){
        msgEl.textContent = 'Please write a review.';
        msgEl.style.color = '#ef4444';
        return;
    }
    
    btn.disabled = true;
    btn.textContent = 'Submitting...';
    msgEl.textContent = '';
    
    try{
        const res = await fetch(`${API}/feedback`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                eventId: Number(eventId),
                regNumber: currentUser.regNumber,
                seatCapacityRating: selectedRating,
                review: review
            })
        });
        const data = await res.json();
        
        if(res.ok && data.ok){
            msgEl.textContent = '‚úÖ Feedback submitted successfully!';
            msgEl.style.color = '#10b981';
            setTimeout(() => {
                showFeedbackPopup(eventId, eventTitle);
            }, 500);
        } else {
            msgEl.textContent = '‚ùå ' + (data.error || 'Failed to submit feedback');
            msgEl.style.color = '#ef4444';
            btn.disabled = false;
            btn.textContent = 'Submit Feedback';
        }
    }catch(err){
        msgEl.textContent = '‚ùå Network error';
        msgEl.style.color = '#ef4444';
        btn.disabled = false;
        btn.textContent = 'Submit Feedback';
    }
}

async function markAllAsRead(){await fetch(API+"/notifications/mark-read",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({regNumber:currentUser.regNumber})}),renderNotifications(),pollNotifications()}
async function pollNotifications(){if(!currentUser)return;try{try{const u=await fetch(API+"/users/"+currentUser.regNumber);if(u.status===404){alert('Your account has been deleted. Logging out.');logout();return;}}catch(_){}const e=await fetch(API+"/notifications/"+currentUser.regNumber),t=await e.json();const n=document.getElementById("notificationTicker");const tickerTextEl=document.getElementById("notificationTickerText");const pollTime=Date.now();const bannerActive=pollTime<welcomeBannerUntil;if(t.ok&&t.notifications.length>0){const r=t.notifications.filter(e=>!e.read).length;if(r>0&&!bannerActive){tickerTextEl.textContent=`üîî You have ${r} unread notification(s)! Click to view.`;if(document.getElementById("screen-notifications").style.display!=="block"){n.style.display="block";tickerTextEl.style.animationPlayState='running';}}else if(!bannerActive){n.style.display="none";tickerTextEl.style.animationPlayState='paused';tickerTextEl.style.transform='translateX(0)';}}else if(!bannerActive){n.style.display="none"}}catch(e){}}
function parseEventDateTime(e,t){if(!t)return new Date(e);if(/am|pm/i.test(t)){let[n,a]=t.split(" ");let[i,o]=n.split(":").map(Number);"PM"===a.toUpperCase()&&i<12&&(i+=12),"AM"===a.toUpperCase()&&12===i&&(i=0);return new Date(`${e}T${String(i).padStart(2,"0")}:${o.toString().padStart(2,"0")}:00`)}return new Date(`${e}T${t}:00`)}
async function showEventBookings(e){
    const t=await fetch(API+"/events");
    const n=await t.json();
    const a=n.events.find(t=>t.id===e);
    window.__eventsCache=n.events;
    const i=document.getElementById("modal");
    const o=document.getElementById("modal-body");
    if(!a){return}
    
    // Check if event is live
    const eventStart = parseEventDateTime(a.date, a.time);
    const isEventLive = new Date() >= eventStart;
    
    o.innerHTML=`<h3>${a.title} ‚Äì Bookings</h3>`;
    if(0===a.bookings.length){
        o.innerHTML+='<p class="muted">No bookings yet.</p>';
    }else{
        let tHtml="<table style='width:100%; border-collapse: collapse;'>";
        tHtml+="<tr style='background:#111'><th style='border:1px solid #333; padding:8px; text-align:left'>Seat</th><th style='border:1px solid #333; padding:8px; text-align:left'>Name</th><th style='border:1px solid #333; padding:8px; text-align:left'>Reg</th><th style='border:1px solid #333; padding:8px; text-align:left'>Role</th><th style='border:1px solid #333; padding:8px; text-align:left'>Action</th></tr>";
        
        a.bookings.forEach(r=>{
            // Check if this user is the event creator (only protect the event creator)
            const isEventCreator = r.regNumber === a.creatorRegNumber;
            
            let cancelButton = '';
            if(isEventLive){
                cancelButton = `<button class='btn' disabled style='padding:6px 10px; width:auto; color: var(--red-accent); border-color: var(--red-accent); opacity: 0.5;'>Event Live</button>`;
            } else if(isEventCreator){
                cancelButton = `<button class='btn' disabled style='padding:6px 10px; width:auto; color: var(--red-accent); border-color: var(--red-accent); opacity: 0.5;'>Event Creator</button>`;
            } else {
                cancelButton = `<button class='btn' style='padding:6px 10px; width:auto; color: var(--red-accent); border-color: var(--red-accent);' onclick="organizerCancelBooking(${a.id}, '${r.regNumber}')">Cancel</button>`;
            }
            
            tHtml+=`<tr><td style='border:1px solid #333; padding:8px'>${r.seat}</td><td style='border:1px solid #333; padding:8px'>${r.name}</td><td style='border:1px solid #333; padding:8px'>${r.regNumber}</td><td style='border:1px solid #333; padding:8px'>${r.role}</td><td style='border:1px solid #333; padding:8px'>${cancelButton}</td></tr>`;
        });
        
        tHtml+="</table>";
        o.innerHTML+=tHtml;
        o.innerHTML+=`<div style="margin-top:16px; text-align:center;"><button class="btn primary" onclick="downloadBookingsReport(${a.id}, '${a.title.replace(/'/g, "&#39;")}', '${a.date}')">üìä Download Report</button></div>`;
    }
    i.style.display="flex";
    try{
        if(__modalIntervals[`bookings-${e}`]) clearInterval(__modalIntervals[`bookings-${e}`]);
        __modalIntervals[`bookings-${e}`] = setInterval(()=>{
            try{
                showEventBookings(e);
            }catch{}
        }, 5000);
    }catch{}
}
async function organizerCancelBooking(eventId,targetReg){if(!currentUser||currentUser.role!=="ORGANIZER")return; if(!confirm("Cancel this user's ticket?"))return;try{const e=await fetch(API+"/tickets/admin-cancel",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({eventId,targetRegNumber:targetReg,organizerRegNumber:currentUser.regNumber})}),t=await e.json();e.ok&&t.ok?(alert("Ticket cancelled. User will be notified."),showEventBookings(eventId),renderEvents()):alert("Error: "+(t.error||"Failed to cancel booking"))}catch(e){alert("Network error")}}
async function downloadBookingsReport(eventId, eventTitle, eventDate){
    try{
        let event = window.__eventsCache?.find(e => e.id === eventId);
        if(!event){
            const res = await fetch(API + '/events');
            const data = await res.json();
            event = data.events.find(e => e.id === eventId);
        }
        if(!event || !event.bookings || event.bookings.length === 0){
            alert('No bookings data available');
            return;
        }
        const reportHtml = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bookings Report - ${eventTitle}</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 20px; background: #f8fafc; color: #1a202c; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 24px; text-align: center; }
        .header h1 { margin: 0 0 8px 0; font-size: 28px; font-weight: 600; }
        .header p { margin: 0; opacity: 0.9; font-size: 16px; }
        .content { padding: 24px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; text-align: center; }
        .stat-number { font-size: 24px; font-weight: 700; color: #2d3748; margin-bottom: 4px; }
        .stat-label { font-size: 14px; color: #718096; text-transform: uppercase; letter-spacing: 0.5px; }
        table { width: 100%; border-collapse: collapse; margin-top: 16px; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        th { background: #4a5568; color: white; padding: 16px 12px; text-align: left; font-weight: 600; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; }
        td { padding: 16px 12px; border-bottom: 1px solid #e2e8f0; font-size: 14px; }
        tr:hover { background: #f7fafc; }
        tr:last-child td { border-bottom: none; }
        .ticket-id { font-family: 'Courier New', monospace; font-weight: 600; color: #2b6cb0; }
        .reg-number { font-family: 'Courier New', monospace; font-weight: 500; color: #4a5568; }
        .role-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; text-transform: uppercase; }
        .role-organizer { background: #fed7d7; color: #c53030; }
        .role-student { background: #c6f6d5; color: #2f855a; }
        .footer { background: #f7fafc; padding: 16px 24px; text-align: center; color: #718096; font-size: 14px; border-top: 1px solid #e2e8f0; }
        @media print { body { background: white; } .container { box-shadow: none; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Bookings Report</h1>
            <p>${eventTitle} ‚Ä¢ ${eventDate}</p>
        </div>
        <div class="content">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number">${event.bookings.length}</div>
                    <div class="stat-label">Total Bookings</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${event.capacity}</div>
                    <div class="stat-label">Total Capacity</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${Math.round((event.bookings.length / event.capacity) * 100)}%</div>
                    <div class="stat-label">Occupancy Rate</div>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Seat #</th>
                        <th>Ticket ID</th>
                        <th>Name</th>
                        <th>Registration #</th>
                        <th>Role</th>
                        <th>Event Date</th>
                        <th>Booking Date</th>
                        <th>Booking Time</th>
                    </tr>
                </thead>
                <tbody>
                    ${event.bookings.map(booking => {
                        const bookingDate = booking.bookedAt ? new Date(booking.bookedAt) : new Date();
                        const eventDateTime = new Date(`${eventDate}T${event.time}`);
                        return `
                            <tr>
                                <td><strong>${booking.seat}</strong></td>
                                <td><span class="ticket-id">T-${String(booking.seat).padStart(2, '0')}</span></td>
                                <td><strong>${booking.name || 'N/A'}</strong></td>
                                <td><span class="reg-number">${booking.regNumber}</span></td>
                                <td><span class="role-badge role-${booking.role === 'O' ? 'organizer' : 'student'}">${booking.role === 'O' ? 'Organizer' : 'Student'}</span></td>
                                <td>${eventDateTime.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</td>
                                <td>${bookingDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}</td>
                                <td>${bookingDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true })}</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
        <div class="footer">
            <p>Generated on ${new Date().toLocaleString('en-US', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</p>
        </div>
    </div>
</body>
</html>`;
        const newWindow = window.open('', '_blank');
        newWindow.document.write(reportHtml);
        newWindow.document.close();
    }catch(err){
        alert('Error generating report: ' + err.message);
    }
}
async function renderProfile(){
    if(!currentUser) return;
    const p = document.getElementById("screen-profile");
    p.innerHTML = `
        <h2>My Profile</h2>
        <div class="profile-details">
            <div class="detail-item"><label>Full Name</label><span>${capitalizeWords(currentUser.name || '')} ${capitalizeWords(currentUser.surname || '')}</span></div>
            <div class="detail-item"><label>Registration Number</label><span>${currentUser.regNumber}</span></div>
            <div class="detail-item"><label>Email</label><span>${currentUser.email}</span></div>
            <div class="detail-item"><label>Phone</label><span>${currentUser.phone}</span></div>
            <div class="detail-item"><label>Age</label><span>${currentUser.age}</span></div>
            <div class="detail-item"><label>Gender</label><span>${currentUser.gender}</span></div>
            <div class="detail-item"><label>Role</label><span>${currentUser.role}${currentUser.organizerStatus ? ` (${currentUser.organizerStatus})` : ''}</span></div>
            ${currentUser.department ? `<div class="detail-item"><label>Department</label><span>${currentUser.department}</span></div>` : ''}
            ${currentUser.bloodGroup ? `<div class="detail-item"><label>Blood Group</label><span>${currentUser.bloodGroup}</span></div>` : ''}
            ${currentUser.address ? `<div class="detail-item"><label>Address</label><span>${currentUser.address}</span></div>` : ''}
            ${currentUser.branch ? `<div class="detail-item"><label>Branch</label><span>${currentUser.branch}</span></div>` : ''}
            ${currentUser.pincode ? `<div class="detail-item"><label>Pincode</label><span>${currentUser.pincode}</span></div>` : ''}
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn primary" onclick="showEditProfile()">‚úèÔ∏è Edit Profile</button>
            <button class="btn" onclick="showIdCard()">üÜî View ID Card</button>
        </div>
        <div style="margin-top: 16px; border-top: 1px solid var(--border); padding-top: 12px;">
            <button class="btn" style="border-color:#ef4444; color:#ef4444; width:100%" onclick="openDeleteAccountModal()">üóëÔ∏è Delete Account</button>
        </div>
    `;
}

function showEditProfile() {
    const p = document.getElementById("screen-profile");
    
    // Department options for NITK
    const departments = [
        "Computer Science & Engineering",
        "Information Technology", 
        "Electronics & Communication Engineering",
        "Electrical & Electronics Engineering",
        "Mechanical Engineering",
        "Civil Engineering",
        "Chemical Engineering",
        "Metallurgical & Materials Engineering",
        "Mining Engineering",
        "Petroleum Engineering",
        "Aerospace Engineering",
        "Biotechnology",
        "Industrial & Production Engineering",
        "Manufacturing Science & Engineering",
        "Ocean Engineering & Naval Architecture",
        "Architecture",
        "Mathematics",
        "Physics",
        "Chemistry",
        "Humanities & Social Sciences",
        "Management Studies"
    ];
    
    const bloodGroups = ["A+", "A-", "B+", "B-", "AB+", "AB-", "O+", "O-"];
    
    let departmentOptions = departments.map(dept => 
        `<option value="${dept}" ${currentUser.department === dept ? 'selected' : ''}>${dept}</option>`
    ).join('');
    
    let bloodGroupOptions = bloodGroups.map(bg => 
        `<option value="${bg}" ${currentUser.bloodGroup === bg ? 'selected' : ''}>${bg}</option>`
    ).join('');
    
    p.innerHTML = `
        <h2>Edit Profile</h2>
        <div class="card">
            <h3>Additional Information</h3>
            
            <div style="margin-bottom: 16px;">
                <label for="editDepartment" style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-primary);">Department:</label>
                <select id="editDepartment" style="width: 100%; padding: 12px; border: 2px solid #4a5568; border-radius: 8px; font-size: 1rem; background: #f7fafc; color: #2d3748; cursor: pointer;">
                    <option value="" style="color: #718096;">Select Department</option>
                    ${departmentOptions}
                </select>
            </div>
            
            <div style="margin-bottom: 16px;">
                <label for="editBloodGroup" style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-primary);">Blood Group:</label>
                <select id="editBloodGroup" style="width: 100%; padding: 12px; border: 2px solid #4a5568; border-radius: 8px; font-size: 1rem; background: #f7fafc; color: #2d3748; cursor: pointer;">
                    <option value="" style="color: #718096;">Select Blood Group</option>
                    ${bloodGroupOptions}
                </select>
            </div>
            
            <div style="margin-bottom: 16px;">
                <label for="editAddress" style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-primary);">Address:</label>
                <textarea id="editAddress" placeholder="Enter your complete address" rows="3" style="width: 100%; padding: 12px; border: 2px solid #4a5568; border-radius: 8px; font-family: inherit; font-size: 1rem; resize: vertical; min-height: 80px; box-sizing: border-box; background: #f7fafc; color: #2d3748;">${currentUser.address || ''}</textarea>
            </div>
            
            <div style="margin-bottom: 16px;">
                <label for="editBranch" style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-primary);">Branch:</label>
                <input id="editBranch" type="text" placeholder="Enter your branch" value="${currentUser.branch || ''}" style="width: 100%; padding: 12px; border: 2px solid #4a5568; border-radius: 8px; font-size: 1rem; box-sizing: border-box; background: #f7fafc; color: #2d3748;">
            </div>
            
            <div style="margin-bottom: 16px;">
                <label for="editPincode" style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-primary);">Pincode:</label>
                <input id="editPincode" type="text" placeholder="Enter pincode" value="${currentUser.pincode || ''}" maxlength="6" style="width: 100%; padding: 12px; border: 2px solid #4a5568; border-radius: 8px; font-size: 1rem; box-sizing: border-box; background: #f7fafc; color: #2d3748;">
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn primary" onclick="saveProfile()" style="flex: 1;">üíæ Save Profile</button>
                <button class="btn" onclick="renderProfile()" style="flex: 1;">‚ùå Cancel</button>
            </div>
            
            <div id="profileMsg" class="muted" style="margin-top: 10px;"></div>
        </div>
    `;
}

async function saveProfile() {
    const department = document.getElementById("editDepartment").value;
    const bloodGroup = document.getElementById("editBloodGroup").value;
    const address = document.getElementById("editAddress").value;
    const branch = document.getElementById("editBranch").value;
    const pincode = document.getElementById("editPincode").value;
    const msg = document.getElementById("profileMsg");
    
    // Validate pincode
    if (pincode && (!/^\d{6}$/.test(pincode))) {
        msg.textContent = "‚ùå Pincode must be 6 digits";
        return;
    }
    
    msg.textContent = "‚è≥ Saving profile...";
    
    try {
        const res = await fetch(API + "/profile", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                regNumber: currentUser.regNumber,
                department,
                bloodGroup,
                address,
                branch,
                pincode
            })
        });
        
        const data = await res.json();
        
        if (res.ok && data.ok) {
            msg.textContent = "‚úÖ Profile saved successfully!";
            
            // Update current user data
            currentUser.department = department;
            currentUser.bloodGroup = bloodGroup;
            currentUser.address = address;
            currentUser.branch = branch;
            currentUser.pincode = pincode;
            
            // Update saved session
            saveUserSession(currentUser);
            
            // Show success message
            setTimeout(() => {
                const notificationTicker = document.getElementById("notificationTicker");
                if (notificationTicker) {
                    notificationTicker.innerHTML = "‚úÖ Profile updated successfully!";
                    notificationTicker.style.display = "block";
                    setTimeout(() => {
                        notificationTicker.style.display = "none";
                    }, 2000);
                }
            }, 500);
            
            // Return to profile view after 1.5 seconds
            setTimeout(() => {
                renderProfile();
            }, 1500);
        } else {
            msg.textContent = "‚ùå " + (data.error || "Failed to save profile");
        }
    } catch (error) {
        msg.textContent = "‚ùå Network error: " + error.message;
    }
}
function showTicketDetail(e){
    const t=document.getElementById("modal-body");
    const viaLine = e.via && e.via==='qr' ? '<div class="muted">Ticket booked using QR code</div>' : '';
    const bookedAtLine = e.bookedAt ? `<div class="muted">Booked at: ${new Date(e.bookedAt).toLocaleString()}</div>` : '';
    t.innerHTML=`<h3>üéüÔ∏è Ticket</h3><b>${e.eventTitle}</b><br>üìÖ ${e.date} üïí ${e.time}<br>üìç ${e.venue}<br>Seat: ${e.seat}<br>ID: ${e.ticketId}${viaLine}${bookedAtLine}`;
    document.getElementById("modal").style.display="flex"
}
function showIdCard(){if(!currentUser)return;const e="https://static.vecteezy.com/system/resources/previews/024/183/525/original/avatar-of-a-man-portrait-of-a-young-guy-illustration-of-male-character-in-modern-color-style-vector.jpg",t="https://static.vecteezy.com/system/resources/previews/024/183/500/original/female-avatar-brunette-woman-portrait-illustration-of-a-female-character-in-a-modern-color-style-vector.jpg";let n="https://i.imgur.com/KBOhEwI.png";if(currentUser.gender&&currentUser.gender.toLowerCase()==="male")n=e;else if(currentUser.gender&&currentUser.gender.toLowerCase()==="female")n=t;const a=document.getElementById("modal-body");let d = `<div class="id-card"><div class="id-card-header"><h3>${currentUser.role} ID CARD</h3></div><img src="${n}" alt="Avatar" class="id-card-avatar"><div class="id-card-details">`;
 d += `<p><strong>Name:</strong> ${capitalizeWords(currentUser.name||'')} ${capitalizeWords(currentUser.surname||'')}</p>`;
 d += `<p><strong>Reg. No:</strong> ${currentUser.regNumber||''}</p>`;
 if(currentUser.department) d += `<p><strong>Department:</strong> ${currentUser.department}</p>`;
 if(currentUser.branch) d += `<p><strong>Branch:</strong> ${currentUser.branch}</p>`;
 if(currentUser.bloodGroup) d += `<p><strong>Blood Group:</strong> ${currentUser.bloodGroup}</p>`;
 if(currentUser.address) d += `<p><strong>Address:</strong> ${currentUser.address}</p>`;
 if(currentUser.pincode) d += `<p><strong>Pincode:</strong> ${currentUser.pincode}</p>`;
 d += `</div></div>`;
 a.innerHTML = d,document.getElementById("modal").style.display="flex"}
function openDeleteAccountModal(){
    const body = document.getElementById('modal-body');
    body.innerHTML = `
      <h3>Delete Account</h3>
      <div class="muted">This action will permanently remove your account, bookings, events, media, and messages.</div>
      <div class="password-wrapper" style="margin-top:10px;">
         <input id="deletePass" type="password" placeholder="Enter your password to confirm">
         <span class="password-toggle" onclick="togglePasswordVisibility('deletePass')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path class="eye-open-path" d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle class="eye-open-path" cx="12" cy="12" r="3"></circle>
                <path class="eye-closed-path" d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line class="eye-closed-path" x1="1" y1="1" x2="23" y2="23"></line>
            </svg>
         </span>
      </div>
      <div style="display:flex; gap:8px; margin-top:12px;">
        <button class="btn" onclick="confirmDeleteAccount()" style="border-color:#ef4444; color:#ef4444; flex:1;">Confirm</button>
        <button class="btn" onclick="closeModal()" style="flex:1;">Cancel</button>
      </div>
    `;
    document.getElementById('modal').style.display='flex';
}
async function confirmDeleteAccount(){
    const pass = document.getElementById('deletePass').value;
    if(!pass){ alert('Please enter your password.'); return; }
    if(!confirm('Are you absolutely sure? This cannot be undone.')) return;
    try{
        const res = await fetch(API+'/account/delete', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ regNumber: currentUser.regNumber, password: pass })});
        const data = await res.json();
        if(res.ok && data.ok){
            alert('Your account has been deleted.');
            closeModal();
            // Clear session and reset UI
            clearUserSession();
            currentUser = null;
            renderTabs();
            showLogin();
        } else {
            alert('‚ùå '+(data.error||'Failed to delete account'));
        }
    }catch(err){ alert('Network error'); }
}
function showEventIdCard(e){const t="https://static.vecteezy.com/system/resources/previews/024/183/525/original/avatar-of-a-man-portrait-of-a-young-guy-illustration-of-male-character-in-modern-color-style-vector.jpg",n="https://static.vecteezy.com/system/resources/previews/024/183/500/original/female-avatar-brunette-woman-portrait-illustration-of-a-female-character-in-a-modern-color-style-vector.jpg";let a="https://i.imgur.com/KBOhEwI.png";if(e.creatorGender&&e.creatorGender.toLowerCase()==="male")a=t;else if(e.creatorGender&&e.creatorGender.toLowerCase()==="female")a=n;const i=document.getElementById("modal-body");i.innerHTML=`<div class="id-card"><div class="id-card-header"><h3>EVENT ID CARD</h3></div><img src="${a}" alt="Organizer Avatar" class="id-card-avatar"><div class="id-card-details"><p style="font-size: 1.2rem"><strong>${capitalizeWords(e.title)}</strong></p><p><strong>Cat:</strong> ${e.category}</p><p><strong>Location:</strong> ${capitalizeWords(e.venue)}</p><p><strong>Organizer:</strong> ${capitalizeWords(e.creatorName)}</p></div></div>`,document.getElementById("modal").style.display="flex"}
// Video loading progress functions
function showVideoLoading(video) {
    const container = video.closest('.video-container');
    if (!container) return;
    
    const overlay = container.querySelector('.video-loading-overlay');
    if (overlay) {
        overlay.style.display = 'flex';
        // Reset progress
        const progressFill = overlay.querySelector('.progress-fill');
        const loadingText = overlay.querySelector('.loading-text');
        if (progressFill) progressFill.style.width = '0%';
        if (loadingText) loadingText.textContent = 'Loading...';
    }
}

function updateVideoProgress(video, event) {
    const container = video.closest('.video-container');
    if (!container) return;
    
    const overlay = container.querySelector('.video-loading-overlay');
    if (!overlay) return;
    
    const progressFill = overlay.querySelector('.progress-fill');
    const loadingText = overlay.querySelector('.loading-text');
    
    if (video.buffered.length > 0 && video.duration > 0) {
        const bufferedEnd = video.buffered.end(video.buffered.length - 1);
        const progress = Math.min((bufferedEnd / video.duration) * 100, 100);
        
        if (progressFill) {
            progressFill.style.width = progress + '%';
        }
        
        if (loadingText) {
            loadingText.textContent = `Loading... ${Math.round(progress)}%`;
        }
        
        // Check if fully loaded
        if (progress >= 100) {
            setTimeout(() => hideVideoLoading(video), 500); // Small delay for smooth transition
        }
    }
}

function hideVideoLoading(video) {
    const container = video.closest('.video-container');
    if (!container) return;
    
    const overlay = container.querySelector('.video-loading-overlay');
    if (overlay) {
        overlay.style.display = 'none';
    }
    
    // Add click handler only after loading is complete
    video.style.cursor = 'pointer';
    video.onclick = function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        // Use data-media-id attribute for reliable media ID
        const mediaId = video.getAttribute('data-media-id');
        if (mediaId) {
            showLightbox(mediaId, 'video');
        }
    };
}

function showLightbox(e,t){
    const modal = document.getElementById("lightbox-modal");
    const content = document.getElementById("lightbox-content");
    // Handle Cloudinary URLs (full HTTPS), legacy GridFS (_id), and relative paths
    let fullUrl = e;
    if (e.startsWith('http://') || e.startsWith('https://')) {
        // Cloudinary URL - use directly
        fullUrl = e;
    } else if (e.startsWith('/')) {
        // Relative path
        fullUrl = `${API_BASE}${e}`;
    } else {
        // Legacy GridFS ID
        fullUrl = `${API_BASE}/api/media/file/${e}`;
    }
    const isOrganizer = currentUser && currentUser.role === 'ORGANIZER';
    let mediaHtml = '';
    if (t === 'photo') mediaHtml = `<img src="${fullUrl}">`;
    if (t === 'video') {
        // Optimize Cloudinary video URL for faster streaming
        let optimizedVideoUrl = fullUrl;
        if (fullUrl && fullUrl.includes('cloudinary.com')) {
            // Add streaming optimizations for faster playback
            if (!fullUrl.includes('/q_')) {
                // Add progressive streaming, auto quality, auto format
                optimizedVideoUrl = fullUrl.replace(/\.(mp4|webm|ogg)/, '/q_auto,f_auto,vc_auto,ac_auto,fl_progressive.$1');
            }
        }
        mediaHtml = `
            <div style="position: relative; text-align: center;">
                <video src="${optimizedVideoUrl}" 
                       controls 
                       preload="auto" 
                       playsinline 
                       webkit-playsinline 
                       muted
                       style="max-width: 100%; max-height: 80vh; background: #000;">
        <source src="${optimizedVideoUrl}" type="video/mp4">
        <source src="${optimizedVideoUrl.replace(/\.mp4/, '.webm')}" type="video/webm">
        Your browser does not support the video tag.
                </video>
            </div>
        `;
    }
    const header = `<a class="lightbox-back-arrow" onclick="closeLightbox(event)">‚Üê</a>`;
    const downloadBar = isOrganizer ? `<div style="text-align:center; margin-top:12px;"><a href="${fullUrl}" download class="btn" style="display:inline-block; width:auto">‚¨á Download</a></div>` : '';
    content.innerHTML = header + mediaHtml + downloadBar;
    modal.style.display = "flex";
}

function downloadMedia(url){
    const a = document.createElement('a');
    a.href = `${API_BASE}${url}`;
    a.download = '';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}
function closeLightbox(e){ if(e) e.stopPropagation(); const modal = document.getElementById("lightbox-modal"); modal.style.display = "none"; modal.querySelector("#lightbox-content").innerHTML = ""; }
let leafletMap = null;
let leafletUserMarker = null;
let leafletVenueMarker = null;
let leafletRoutingControl = null;

async function showMapModal(venue) {
    // Cleanup previous map instance
    if (leafletMap) {
        try {
            leafletMap.remove();
        } catch {}
    }
    leafletMap = null;
    leafletUserMarker = null;
    leafletVenueMarker = null;
    leafletRoutingControl = null;
    if (watchId && navigator.geolocation) {
        try {
            navigator.geolocation.clearWatch(watchId);
        } catch {}
    }
    watchId = null;

    const mapContainer = document.getElementById("map-container");
    document.getElementById("map-modal").style.display = "flex";
    mapContainer.innerHTML = `<div style="display:flex;flex-direction:column;width:100%;height:100%">
        <div style="padding: 12px 16px 12px 80px; background:#2a2a2a; border-bottom:1px solid #333; display:flex; align-items:center; justify-content:center; position:relative; z-index:2; text-align:center;">
            <div style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:80%">
                <div style="font-weight:bold; color:#7c3aed; font-size:1.05rem;">üìç ${venue}</div>
                <div class="muted" style="font-size:0.9rem; color:#a1a1aa;">NITK Surathkal ‚Ä¢ <span id="etaHeader"></span></div>
            </div>
        </div>
        <div id="leaflet-map" style="flex:1; background:#1a1a1a; position:relative;">
            <div id="map-loading" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:#7c3aed; font-size:1.1rem; z-index:1000;">üìç Loading map...</div>
        </div>
        <div style="padding:10px; background:#2a2a2a; border-top:1px solid #333; display:flex; gap:10px">
            <button id="routeBtn" class="btn" style="flex:1; opacity:0.6; pointer-events:none;" onclick="drawRouteOnLeafletMap()">üß≠ Show Route</button>
            <button class="btn" style="flex:1" onclick="openExternalNavFromMap()">üó∫Ô∏è Get Directions</button>
        </div>
    </div>`;
    
    // Pre-load Leaflet scripts in background (should already be preloaded)
    const leafletPromise = typeof L !== 'undefined' ? Promise.resolve() : loadLeafletScripts();
    
    try {
        // Wait for Leaflet to load (should be instant if preloaded)
        await leafletPromise;
        
        // Resolve venue location
        const target = await resolveVenueLatLng(venue);
        
        // Remove loading indicator and initialize map
        const loadingEl = document.getElementById('map-loading');
        if (loadingEl) loadingEl.remove();
        
        initLeafletMap(target, venue);
    } catch (err) {
        console.error('Map initialization error:', err);
        const mapDiv = document.getElementById('leaflet-map');
        const loadingEl = document.getElementById('map-loading');
        if (loadingEl) loadingEl.remove();
        
        const text = document.createElement('div');
        text.className = 'muted';
        text.style.cssText = 'padding:16px; color:#a1a1aa; text-align:center; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);';
        text.textContent = 'Map failed to load. Try reloading or use Get Directions.';
        if (mapDiv) {
            mapDiv.appendChild(text);
        }
    }
}

// Load Leaflet scripts dynamically
function loadLeafletScripts() {
    return new Promise((resolve, reject) => {
        if (typeof L !== 'undefined') {
            resolve();
            return;
        }
        
        // Check if script is already being loaded
        if (window.__leafletLoading) {
            window.__leafletLoading.then(resolve).catch(reject);
            return;
        }
        
        // Create loading promise
        window.__leafletLoading = new Promise((loadResolve, loadReject) => {
            // Load Leaflet JS
            const leafletScript = document.createElement('script');
            leafletScript.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
            leafletScript.integrity = 'sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=';
            leafletScript.crossOrigin = '';
            
            leafletScript.onload = () => {
                // Load Leaflet Routing Machine
                const routingScript = document.createElement('script');
                routingScript.src = 'https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js';
                routingScript.onload = () => {
                    window.__leafletLoading = null;
                    loadResolve();
                };
                routingScript.onerror = () => {
                    console.warn('Leaflet Routing Machine failed to load, continuing without routing');
                    window.__leafletLoading = null;
                    loadResolve(); // Continue without routing
                };
                document.head.appendChild(routingScript);
            };
            leafletScript.onerror = (err) => {
                window.__leafletLoading = null;
                loadReject(err);
            };
            document.head.appendChild(leafletScript);
        });
        
        window.__leafletLoading.then(resolve).catch(reject);
    });
}

// Preload Leaflet scripts on page load for faster map display
(function preloadLeaflet() {
    if (typeof L === 'undefined') {
        loadLeafletScripts().catch(() => {
            console.warn('Failed to preload Leaflet, will load on demand');
        });
    }
})();

let lastVenueLatLng = null, lastVenueName = '', lastUserLatLng = null;
let watchId = null;

function initLeafletMap(targetLatLng, venueName) {
    // Safety check - ensure Leaflet is loaded
    if (typeof L === 'undefined') {
        console.error('Leaflet library not loaded');
        return;
    }
    
    lastVenueLatLng = targetLatLng;
    lastVenueName = venueName;
    
    // Initialize Leaflet map
    leafletMap = L.map('leaflet-map', {
        zoomControl: true,
        attributionControl: true
    }).setView([targetLatLng.lat, targetLatLng.lng], 16);
    
    // Add OpenStreetMap tile layer with dark theme
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(leafletMap);
    
    // Add venue marker
    const venueIcon = L.divIcon({
        html: '<div style="font-size:24px;">üìç</div>',
        className: 'venue-marker',
        iconSize: [30, 30],
        iconAnchor: [15, 30]
    });
    
    leafletVenueMarker = L.marker([targetLatLng.lat, targetLatLng.lng], {
        icon: venueIcon
    }).addTo(leafletMap).bindPopup(venueName);
    
    // If we have last known user position, show it immediately
    if (lastUserLatLng) {
        addUserMarker(lastUserLatLng);
        const bounds = L.latLngBounds(
            [targetLatLng.lat, targetLatLng.lng],
            [lastUserLatLng.lat, lastUserLatLng.lng]
        );
        leafletMap.fitBounds(bounds);
        const routeBtn = document.getElementById('routeBtn');
        if (routeBtn) {
            routeBtn.style.opacity = '1';
            routeBtn.style.pointerEvents = 'auto';
        }
    }
    
    // Get user's current location
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            pos => {
                const p = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                lastUserLatLng = p;
                addUserMarker(p);
                const bounds = L.latLngBounds(
                    [targetLatLng.lat, targetLatLng.lng],
                    [p.lat, p.lng]
                );
                leafletMap.fitBounds(bounds);
                const routeBtn = document.getElementById('routeBtn');
                if (routeBtn) {
                    routeBtn.style.opacity = '1';
                    routeBtn.style.pointerEvents = 'auto';
                }
            },
            () => {},
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 15000 }
        );
        
        // Watch position for real-time updates
        watchId = navigator.geolocation.watchPosition(
            pos => {
                const p = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                lastUserLatLng = p;
                addUserMarker(p);
                const bounds = L.latLngBounds(
                    [targetLatLng.lat, targetLatLng.lng],
                    [p.lat, p.lng]
                );
                leafletMap.fitBounds(bounds);
            },
            () => {},
            { enableHighAccuracy: true, timeout: 15000, maximumAge: 15000 }
        );
    }
    
    // Invalidate size after a short delay to ensure proper rendering
    setTimeout(() => {
        if (leafletMap) {
            leafletMap.invalidateSize();
        }
    }, 100);
}

function addUserMarker(position) {
    // Safety check - ensure Leaflet is loaded
    if (typeof L === 'undefined' || !leafletMap) {
        console.error('Leaflet library not loaded or map not initialized');
        return;
    }
    
    const userIcon = L.divIcon({
        html: '<div style="font-size:24px;">üßç</div>',
        className: 'user-marker',
        iconSize: [30, 30],
        iconAnchor: [15, 30]
    });
    
    if (!leafletUserMarker) {
        leafletUserMarker = L.marker([position.lat, position.lng], {
            icon: userIcon
        }).addTo(leafletMap).bindPopup('You');
    } else {
        leafletUserMarker.setLatLng([position.lat, position.lng]);
    }
}

function recenterMap() {
    if (typeof L !== 'undefined' && leafletMap && leafletUserMarker) {
        leafletMap.setView(leafletUserMarker.getLatLng(), leafletMap.getZoom());
    }
}
async function drawRouteOnLeafletMap(){
    try {
        // Safety check - ensure Leaflet is loaded
        if (typeof L === 'undefined') {
            console.error('Leaflet library not loaded');
            return;
        }
        if (!leafletMap || !lastVenueLatLng) { return; }
        if (!lastUserLatLng) {
            await new Promise((resolve) => {
                if (!navigator.geolocation) return resolve();
                navigator.geolocation.getCurrentPosition(
                    pos => {
                        lastUserLatLng = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                        resolve();
                    },
                    () => resolve(),
                    { enableHighAccuracy: true, timeout: 8000, maximumAge: 15000 }
                );
            });
        }
        if (!lastUserLatLng) { return; }
        
        if (leafletRoutingControl) {
            leafletMap.removeControl(leafletRoutingControl);
            leafletRoutingControl = null;
        }
        
        if (typeof L.Routing !== 'undefined') {
            leafletRoutingControl = L.Routing.control({
                waypoints: [
                    L.latLng(lastUserLatLng.lat, lastUserLatLng.lng),
                    L.latLng(lastVenueLatLng.lat, lastVenueLatLng.lng)
                ],
                router: L.Routing.osrmv1({
                    serviceUrl: 'https://routing.openstreetmap.de/routed-bike/route/v1',
                    profile: 'bike',
                    timeout: 30000
                }),
                lineOptions: {
                    styles: [{ color: '#ef4444', opacity: 0.8, weight: 5 }]
                },
                show: false,
                addWaypoints: false,
                routeWhileDragging: false,
                fitSelectedRoutes: true
            }).addTo(leafletMap);
            
            leafletRoutingControl.on('routesfound', function(e) {
                const routes = e.routes;
                if (routes && routes.length > 0) {
                    const route = routes[0];
                    const summary = route.summary;
                    const distance = (summary.totalDistance / 1000).toFixed(2) + ' km';
                    const time = Math.round(summary.totalTime / 60) + ' min';
                    const header = document.getElementById('etaHeader');
                    if (header) {
                        header.textContent = `Distance: ${distance} ‚Ä¢ Time: ${time}`;
                    }
                }
            });
        } else {
            // Fallback: draw straight line if routing machine not available
            const routeLine = L.polyline(
                [
                    [lastUserLatLng.lat, lastUserLatLng.lng],
                    [lastVenueLatLng.lat, lastVenueLatLng.lng]
                ],
                { color: '#ef4444', weight: 5, opacity: 0.8 }
            ).addTo(leafletMap);
            
            // Calculate distance using Haversine formula
            const R = 6371; // Earth's radius in km
            const dLat = (lastVenueLatLng.lat - lastUserLatLng.lat) * Math.PI / 180;
            const dLon = (lastVenueLatLng.lng - lastUserLatLng.lng) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lastUserLatLng.lat * Math.PI / 180) * Math.cos(lastVenueLatLng.lat * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const distance = R * c; // Distance in km
            
            const distText = distance.toFixed(2) + ' km';
            const approxTime = Math.round(distance * 5) + ' min'; // Approximate bike time (5 min/km)
            
            const header = document.getElementById('etaHeader');
            if (header) {
                header.textContent = `Distance: ${distText} ‚Ä¢ Approx Time: ${approxTime}`;
            }
        }
        
        const bounds = L.latLngBounds(
            [lastUserLatLng.lat, lastUserLatLng.lng],
            [lastVenueLatLng.lat, lastVenueLatLng.lng]
        );
        leafletMap.fitBounds(bounds);
    } catch (err) {
        console.error('Routing error:', err);
    }
}
function toLatLngLiteral(p){ if (!p) return null; if (typeof p.lat === 'function') { return { lat: p.lat(), lng: p.lng() }; } if ('lat' in p && 'lng' in p) return p; return null; }
function drawPolylineRoute(){ /* removed */ }

// computeETAs removed per request
async function openExternalNavFromMap(){
    if (!lastVenueLatLng) return;
    const {lat: dlat, lng: dlng} = lastVenueLatLng;
    let originParam = '';
    try{
        if(lastUserLatLng && typeof lastUserLatLng.lat === 'number' && typeof lastUserLatLng.lng === 'number'){
            originParam = `&origin=${lastUserLatLng.lat},${lastUserLatLng.lng}`;
        } else if (navigator.geolocation) {
            await new Promise((resolve)=>{
                navigator.geolocation.getCurrentPosition(pos=>{ lastUserLatLng = { lat: pos.coords.latitude, lng: pos.coords.longitude }; resolve(); }, ()=>resolve(), { enableHighAccuracy:true, timeout:5000, maximumAge:15000 });
            });
            if(lastUserLatLng) originParam = `&origin=${lastUserLatLng.lat},${lastUserLatLng.lng}`;
        }
    }catch{}
    const url = `https://www.google.com/maps/dir/?api=1&destination=${dlat},${dlng}${originParam}`;
    window.open(url, '_blank', 'noopener');
}

// Removed showIframeFallback - using Leaflet instead

// Resolve venue to precise coordinates using dictionary, fallback to OpenStreetMap Nominatim geocoding
async function resolveVenueLatLng(venue){
    const dict = {
        'LH-C': {lat:13.00898,lng:74.79397}, 'LH-D': {lat:13.00970,lng:74.79346},
        'LH-A': {lat:13.00949,lng:74.79397}, 'LHB (MB)': {lat:13.01112,lng:74.79442},
        'SJA': {lat:13.00939,lng:74.79506}, 'MAIN BUILDING': {lat:13.01112,lng:74.79442},
        'SEMINAR HALL A (MB)': {lat:13.01113,lng:74.79428}, 'SEMINAR HALL B (MB)': {lat:13.01113,lng:74.79428},
        'SEMINAR HALL C (MB)': {lat:13.01113,lng:74.79428}, 'OPEN THEATER': {lat:13.01083,lng:74.79695},
        'NEW SPORTS COMPLEX': {lat:13.01006,lng:74.79830}, 'MAIN GROUND': {lat:13.01015,lng:74.79755},
        'NITK BEACH': {lat:13.00981,lng:74.78811}, 'CRF': {lat:13.00933,lng:74.79539}, 'GYM': {lat:13.00720,lng:74.79482}
    };
    if (dict[venue]) return dict[venue];
    
    // Fallback to OpenStreetMap Nominatim geocoding (free, no API key)
    try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(venue + ', NITK Surathkal, Karnataka')}&limit=1`);
        const data = await response.json();
        if (data && data.length > 0) {
            return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
        }
    } catch (err) {
        console.warn('Geocoding failed, using default location:', err);
    }
    
    // Default to NITK main building if geocoding fails
    return {lat:13.01112,lng:74.79442};
}

function closeMap() {
    // Stop geolocation and clear map state so reopening works without refresh
    try {
        if (watchId && navigator.geolocation) {
            navigator.geolocation.clearWatch(watchId);
        }
    } catch {}
    watchId = null;
    
    // Remove routing control if exists
    if (leafletRoutingControl && leafletMap) {
        try {
            leafletMap.removeControl(leafletRoutingControl);
        } catch {}
    }
    
    // Remove map instance
    if (leafletMap) {
        try {
            leafletMap.remove();
        } catch {}
    }
    
    leafletUserMarker = null;
    leafletVenueMarker = null;
    leafletRoutingControl = null;
    // Preserve lastUserLatLng so we can show immediately on next open
    lastVenueLatLng = null;
    lastVenueName = '';
    document.getElementById("map-modal").style.display = "none";
    document.getElementById("map-container").innerHTML = "";
}
function showDirections(venue, coordinates) {
    // Get user's current location and open directions in Google Maps
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
        const { latitude, longitude } = position.coords;
        const origin = `${latitude},${longitude}`;
                
                // Open Google Maps directions with user's location
                const directionsUrl = `https://www.google.com/maps/dir/${origin}/${coordinates}/@${coordinates},18z/data=!3m1!1e3`;
                window.location.href = directionsUrl;
            },
            (error) => {
                // Fallback: Open directions without user location
                console.log('Geolocation error:', error);
                const destinationName = encodeURIComponent(`${venue}, NITK Surathkal`);
                const directionsUrl = `https://www.google.com/maps/dir/?api=1&destination=${destinationName}`;
                window.location.href = directionsUrl;
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            }
        );
    } else {
        // Fallback if geolocation is not supported
        const destinationName = encodeURIComponent(`${venue}, NITK Surathkal`);
        const directionsUrl = `https://www.google.com/maps/dir/?api=1&destination=${destinationName}`;
        window.location.href = directionsUrl;
    }
}

function openInGoogleMaps(venue, coordinates) {
    // Open Google Maps with the venue location
    const mapUrl = `https://www.google.com/maps/@${coordinates},18z/data=!3m1!1e3`;
    window.location.href = mapUrl;
}

function getDirections(venue, coordinates) {
    // Alias for showDirections
    showDirections(venue, coordinates);
}
function refreshEvents(){document.getElementById("screen-home").innerHTML='<p class="muted">üîÑ Refreshing...</p>',setTimeout(renderEvents,1e3)}
async function refreshTickets(){document.getElementById("screen-tickets").innerHTML='<p class="muted">üîÑ Refreshing...</p>',await renderTickets(!0),setTimeout(renderTickets,1e3)}
function capitalizeWords(str) { if (!str) return ''; return str.replace(/\b\w/g, char => char.toUpperCase()); }
function startCountdownTimers() {
    if (countdownInterval) clearInterval(countdownInterval);
    countdownInterval = setInterval(() => {
        document.querySelectorAll('[id^="countdown-"]').forEach(el => {
            const startTime = new Date(el.dataset.startTime);
            const countdownTime = new Date();
            const diff = startTime - countdownTime;
            if (diff > 0) {
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                
                if (days > 0) {
                    el.innerHTML = `‚è± <strong style="color:#ff0000; font-weight: bold;">Starts in ${days}d ${String(hours).padStart(2,'0')}h ${String(minutes).padStart(2,'0')}m</strong>`;
                } else if (hours > 0) {
                    el.innerHTML = `‚è± <strong style="color:#ff0000; font-weight: bold;">Starts in ${String(hours).padStart(2,'0')}h ${String(minutes).padStart(2,'0')}m</strong>`;
                } else if (minutes > 0) {
                    el.innerHTML = `‚è± <strong style="color:#ff0000; font-weight: bold;">Starts in ${String(minutes).padStart(2,'0')}m ${String(seconds).padStart(2,'0')}s</strong>`;
                } else {
                    el.innerHTML = `‚è± <strong style="color:#ff0000; font-weight: bold;">Starts in ${String(seconds).padStart(2,'0')}s</strong>`;
                }
            } else {
                el.innerHTML = `<strong style="color:#ff0000; font-weight: bold;">üî• LIVE NOW</strong>`;
            }
        });
    }, 1000);
}

// Test function for notifications (can be called from browser console)
function testNotifications() {
    console.log("Testing notifications...");
    checkEventStartNotifications();
}

// Utility to show a temporary welcome banner using the existing ticker area (non-scrolling)
function showWelcomeBanner(message){
    const bar = document.getElementById('notificationTicker');
    const text = document.getElementById('notificationTickerText');
    if(!bar || !text) return;
    text.textContent = message;
    text.style.animationPlayState = 'paused';
    text.style.transform = 'translateX(0)';
    text.style.paddingLeft = '0';
    bar.style.display = 'block';
    welcomeBannerUntil = Date.now() + 2500;
    setTimeout(()=>{
        const screenNotifVisible = document.getElementById('screen-notifications').style.display === 'block';
        if(!screenNotifVisible){ bar.style.display = 'none'; }
    }, 2500);
}

// Initialize app - check for saved login or show auth
checkSavedLogin();

// Show admin login CTA on welcome screen
function renderWelcome() {
    const c = document.getElementById("screen-home");
    c.innerHTML = `
      <div style="text-align:center; padding:30px;">
        <h2>Welcome to Pulse</h2>
        <div style="display:flex; gap:10px; justify-content:center; margin-top:10px;">
          <button class="btn primary" onclick="showLogin()">Login</button>
          <button class="btn" onclick="showSignup()">Signup</button>
        </div>
      </div>`;
}

function showAdminLogin(){
    const s = document.getElementById("screen-login");
    s.innerHTML = `
      <h2>Admin Login</h2>
      <input id="adminUser" placeholder="Username" value="">
      <div class="password-wrapper"><input id="adminPass" type="password" placeholder="Password">
        <span class="password-toggle" onclick="togglePasswordVisibility('adminPass')">üëÅÔ∏è</span>
      </div>
      <button class="btn primary" onclick="doAdminLogin()">Login</button>
      <button class="btn" onclick="showLogin()">Cancel</button>
      <div id="adminMsg" class="muted"></div>`;
    showTab('login');
}

async function doAdminLogin(){
    const username = document.getElementById('adminUser').value;
    const password = document.getElementById('adminPass').value;
    const msg = document.getElementById('adminMsg'); 
    msg.textContent='‚è≥ Logging in...';
    try{
        const res = await fetch(API+"/admin/login", { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ username, password })});
        const data = await res.json();
        if(res.ok && data.ok){ window.__isAdmin = true; currentUser = null; try{ saveUserSession(null); }catch{} msg.textContent='‚úÖ Admin logged in'; renderTabs(); showTab('admin'); }
        else { msg.textContent='‚ùå '+(data.error||'Login failed'); }
    }catch{ msg.textContent='‚ùå Network error'; }
}

function renderAdmin(){
    const c = document.getElementById('screen-admin');
    if(!c){ const root=document.createElement('div'); root.id='screen-admin'; root.className='content'; document.getElementById('app').appendChild(root); }
    const el = document.getElementById('screen-admin');
    el.innerHTML = `
      <h2 style="display:flex;justify-content:space-between;align-items:center;">
        <span>Admin</span>
        <button class="btn" onclick="adminLogout()">Logout</button>
      </h2>
      <div class="sub-nav">
        <button class="sub-nav-btn" id="tab-users" onclick="setAdminTab('users')">Users</button>
        <button class="sub-nav-btn" id="tab-media" onclick="setAdminTab('media')">Media</button>
        <button class="sub-nav-btn" id="tab-events" onclick="setAdminTab('events')">Events</button>
        <button class="sub-nav-btn" id="tab-verify" onclick="setAdminTab('verify')">Verify</button>
        <button class="sub-nav-btn" id="tab-you" onclick="setAdminTab('you')">You</button>
        <button class="sub-nav-btn" id="tab-debug" onclick="setAdminTab('debug')">üîß Debug</button>
      </div>
      <div id="admin-content"></div>`;
    setAdminTab('users');
}
function setAdminTab(which){
  console.log(`üîç setAdminTab called with: ${which}`);
  document.querySelectorAll('.sub-nav-btn').forEach(b=>b.classList.remove('active'));
  if(which==='users'){ 
    console.log(`üîç Setting users tab active`);
    document.getElementById('tab-users').classList.add('active'); 
    renderAdminUsers('students'); 
  }
  if(which==='media'){ document.getElementById('tab-media').classList.add('active'); renderAdminMedia(); }
  if(which==='events'){ document.getElementById('tab-events').classList.add('active'); renderAdminEvents(); }
  if(which==='verify'){ document.getElementById('tab-verify').classList.add('active'); renderAdminVerify(); }
  if(which==='you'){ document.getElementById('tab-you').classList.add('active'); renderAdminYou(); }
  if(which==='debug'){ document.getElementById('tab-debug').classList.add('active'); renderAdminDebug(); }
}
function adminLogout(){
  try{ window.__isAdmin = false; }catch{}
  try{ renderTabs(); }catch{}
  try{ showLogin(); }catch{}
}
async function renderAdminUsers(which){
    console.log(`üîç renderAdminUsers called with: ${which}`);
    const pane = document.getElementById('admin-content');
    console.log(`üîç admin-content pane found: ${!!pane}`);
    
    const isStudents = which==='students';
    const url = isStudents ? '/admin/users' : '/admin/organizers';
    console.log(`üîç Fetching from: ${API+url}`);
    
    const res = await fetch(API+url);
    const data = await res.json();
    console.log(`üîç API response:`, data);
    
    const list = (data.users||[]);
    console.log(`üîç Users list length: ${list.length}`);
  
  // Sort by last seen (most recent first)
  list.sort((a, b) => {
    const aLastSeen = a.lastSeen ? new Date(a.lastSeen).getTime() : 0;
    const bLastSeen = b.lastSeen ? new Date(b.lastSeen).getTime() : 0;
    return bLastSeen - aLastSeen;
  });
  
    pane.innerHTML = `<div class="sub-nav" style="margin-bottom:10px;">
       <button class="sub-nav-btn ${isStudents?'active':''}" onclick="renderAdminUsers('students')">Students</button>
       <button class="sub-nav-btn ${!isStudents?'active':''}" onclick="renderAdminUsers('organizers')">Organizers</button>
     </div>
     <div style="margin-bottom: 16px;">
       <p class="muted">Total ${isStudents ? 'Students' : 'Organizers'}: ${list.length}</p>
     </div>
     <div>${list.map(u=>{
       const lastSeen = u.lastSeen ? new Date(u.lastSeen) : null;
       const lastSeenTime = new Date();
       let lastSeenText = 'Never';
       let lastSeenColor = '#6b7280';
       
       if (lastSeen) {
         const diffMs = lastSeenTime.getTime() - lastSeen.getTime();
         const diffMins = Math.floor(diffMs / (1000 * 60));
         const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
         const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
         
         if (diffMins < 5) {
           lastSeenText = 'Just now';
           lastSeenColor = '#10b981';
         } else if (diffMins < 60) {
           lastSeenText = `${diffMins}m ago`;
           lastSeenColor = '#10b981';
         } else if (diffHours < 24) {
           lastSeenText = `${diffHours}h ago`;
           lastSeenColor = '#f59e0b';
         } else if (diffDays < 7) {
           lastSeenText = `${diffDays}d ago`;
           lastSeenColor = '#f59e0b';
         } else {
           lastSeenText = lastSeen.toLocaleDateString();
           lastSeenColor = '#6b7280';
         }
       }
       
       return `<div class="card" style="display:flex;justify-content:space-between;align-items:center;cursor:pointer; margin-bottom: 8px;" onclick="adminOpenUser('${u.regNumber}')">
        <div style="flex: 1;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
            <b>${capitalizeWords(u.name||'')} ${capitalizeWords(u.surname||'')}</b>
            <span class="category-badge" style="font-size: 0.8rem; padding: 2px 6px;">${u.role}</span>
          </div>
          <div class="muted" style="font-size: 0.9rem; margin-bottom: 4px;">${u.regNumber}</div>
          <div style="font-size: 0.85rem;">
            <span style="color: ${lastSeenColor}; font-weight: 500;">üïí Last seen: ${lastSeenText}</span>
            ${u.email ? `<br><span class="muted">üìß ${u.email}</span>` : ''}
            ${u.phone ? `<br><span class="muted">üì± ${u.phone}</span>` : ''}
          </div>
        </div>
        <div style="display:flex; gap:8px;">
          ${isStudents? `<button class="btn" onclick="event.stopPropagation(); adminDeleteStudent('${u.regNumber}')" style="background: #ef4444; border-color: #ef4444; font-size: 0.9rem; padding: 6px 12px;">Delete</button>`: `<button class="btn" onclick="event.stopPropagation(); adminRemoveOrganizer('${u.regNumber}')" style="background: #f59e0b; border-color: #f59e0b; font-size: 0.9rem; padding: 6px 12px;">Remove Ownership</button>`}
        </div>
     </div>`;
     }).join('')||'<p class="muted">No records.</p>'}</div>`;
}
async function adminOpenUser(regNumber){
    try{
        const res = await fetch(API + '/users/' + regNumber);
        const data = await res.json();
        const body = document.getElementById('modal-body');
        if(!res.ok || !data.ok){ body.innerHTML = '<p class="muted">Failed to load user.</p>'; document.getElementById('modal').style.display='flex'; return; }
        const u = data.user||{};
        body.innerHTML = `
          <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;"><a class="map-back-arrow" onclick="closeModal()">‚Üê</a><h3 style="margin:0;">User Details</h3></div>
          <div class="kv"><b>Name:</b> <span class="value">${escapeHtml((u.name||'') + ' ' + (u.surname||''))}</span><b>Reg:</b> <span class="value">${escapeHtml(u.regNumber||'')}</span><b>Role:</b> <span class="value">${escapeHtml(u.role||'')}</span></div>
          <div class="kv"><b>Email:</b> <span class="value">${escapeHtml(u.email||'')}</span><b>Phone:</b> <span class="value">${escapeHtml(u.phone||'')}</span><b>Gender:</b> <span class="value">${escapeHtml(u.gender||'')}</span></div>
          <div class="kv"><b>Age:</b> <span class="value">${escapeHtml(u.age||'')}</span><b>Department:</b> <span class="value">${escapeHtml(u.department||'-')}</span><b>Branch:</b> <span class="value">${escapeHtml(u.branch||'-')}</span></div>
          <div class="kv"><b>Address:</b> <span class="value">${escapeHtml(u.address||'-')}</span><b>Pincode:</b> <span class="value">${escapeHtml(u.pincode||'-')}</span><b>Blood:</b> <span class="value">${escapeHtml(u.bloodGroup||'-')}</span></div>`;
        document.getElementById('modal').style.display='flex';
    }catch{ const body=document.getElementById('modal-body'); body.innerHTML='<p class="muted">Failed to load user.</p>'; document.getElementById('modal').style.display='flex'; }
}
async function adminRemoveOrganizer(reg){ if(!confirm('Remove organizer ownership?')) return; const r=await fetch(API+'/admin/organizers/remove',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({regNumber:reg})}); const d=await r.json(); if(r.ok&&d.ok){ alert('Removed'); renderAdminUsers('organizers'); renderAdminUsers('students'); } else alert('Error: '+(d.error||'Failed')); }
async function adminDeleteStudent(reg){ if(!confirm('Delete this student account?')) return; const r=await fetch(API+'/admin/users/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({regNumber:reg})}); const d=await r.json(); if(r.ok&&d.ok){ alert('Deleted'); renderAdminUsers('students'); } else alert('Error: '+(d.error||'Failed')); }

let __adminMediaFilter = 'upcoming';
async function renderAdminMedia(){
    const pane = document.getElementById('admin-content');
    const evRes = await fetch(API+'/admin/events'); const evData = await evRes.json(); let events = evData.events||[];
    const today = new Date().toISOString().slice(0,10);
    const isPast = (d)=> String(d.date) < today;
    const isUpcoming = (d)=> String(d.date) >= today;
    events = events.filter(e => __adminMediaFilter==='past' ? isPast(e) : isUpcoming(e));
    pane.innerHTML = `<h3>Media (by Event)</h3>
      <div class="sub-nav">
        <button class="sub-nav-btn ${__adminMediaFilter==='upcoming'?'active':''}" onclick="__adminMediaFilter='upcoming'; renderAdminMedia()">Upcoming</button>
        <button class="sub-nav-btn ${__adminMediaFilter==='past'?'active':''}" onclick="__adminMediaFilter='past'; renderAdminMedia()">Past</button>
      </div>
      ${events.map(e=>`<div class="card"><b>${capitalizeWords(e.title)}</b> ‚Ä¢ ${e.date}
        <div style="margin-top:8px;"><button class="btn" onclick="adminOpenEventMedia(${e.id})">Open Media</button></div></div>`).join('')||'<p class="muted">No events.</p>'}`;
}
async function adminOpenEventMedia(eventId){
    const r = await fetch(API+'/admin/media/'+eventId); const d = await r.json();
    const body = document.getElementById('modal-body');
    const items = (d.media||[]);
    
    if (items.length === 0) {
        body.innerHTML = `<div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;"><a class="map-back-arrow" onclick="closeModal()">‚Üê</a><h3 style="margin:0;">Event Media</h3></div><p class="muted">No media uploaded for this event.</p>`;
        document.getElementById('modal').style.display='flex';
        return;
    }
    
    const grid = `<div class="media-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; margin-top: 16px;">
        ${items.map(m=>{
            // Handle Cloudinary URLs (full HTTPS URLs), legacy GridFS, and relative paths
            let src = m.url;
            if (m.url && (m.url.startsWith('http://') || m.url.startsWith('https://'))) {
                // Cloudinary URL - use directly
                src = m.url;
            } else if (m._id) {
                // Legacy GridFS
                src = `${API_BASE}/api/media/file/${m._id}`;
            } else if (m.url) {
                // Relative path
                src = m.url.startsWith('/') ? `${API_BASE}${m.url}` : `${API_BASE}/${m.url}`;
            }
            const fileName = m.name || m.url?.split('/').pop() || 'Unknown';
            const fileSize = m.size ? `(${Math.round(m.size/1024)}KB)` : '';
            
            if(m.type==='photo') {
                return `<div class="media-item" style="position: relative; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; background: var(--card-bg);">
                    <img src="${src}" style="width: 100%; height: 150px; object-fit: cover; cursor: pointer;" 
                         onclick="showLightbox('${m.url}','photo')" 
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIgdmlld0JveD0iMCAwIDIwMCAxNTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMTUwIiBmaWxsPSIjZjNmNGY2Ii8+CjxwYXRoIGQ9Ik04MCA2MEwxMjAgNjBMMTAwIDgwTDgwIDYwWiIgZmlsbD0iIzk5YTNhZiIvPgo8Y2lyY2xlIGN4PSIxMDAiIGN5PSIxMDAiIHI9IjE1IiBmaWxsPSIjOTlhM2FmIi8+Cjx0ZXh0IHg9IjEwMCIgeT0iMTMwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjNmI3MjgwIiBmb250LXNpemU9IjEyIj5JbWFnZSBub3QgZm91bmQ8L3RleHQ+Cjwvc3ZnPg==';">
                    <div style="position: absolute; top: 8px; right: 8px;">
                        <button class="delete-media-btn" onclick="adminDeleteMedia(${m.id})" style="background: rgba(239,68,68,0.9); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 12px;">‚úñ</button>
                    </div>
                    <div style="padding: 8px; font-size: 12px; color: var(--text-muted);">
                        <div style="font-weight: 500;">${fileName}</div>
                        <div>${fileSize} ‚Ä¢ Photo</div>
                    </div>
                </div>`;
            } else {
                return `<div class="media-item" style="position: relative; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; background: var(--card-bg);">
                    <div class="video-container" style="position: relative;">
                        <video src="${src}" 
                               style="width: 100%; height: 150px; object-fit: cover; cursor: pointer;" 
                               preload="metadata" 
                               playsinline 
                               webkit-playsinline
                               data-media-id="${m._id || m.url}"
                               onloadstart="showVideoLoading(this)"
                               onprogress="updateVideoProgress(this, event)"
                               oncanplay="hideVideoLoading(this)"
                               onerror="hideVideoLoading(this)"
                               onloadedmetadata="this.currentTime=1;">
                    </video>
                        <div class="video-loading-overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; flex-direction: column;">
                            <div class="loading-spinner" style="width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px;"></div>
                            <div class="loading-text" style="color: white; font-size: 12px; text-align: center;">Loading...</div>
                            <div class="progress-bar" style="width: 80%; height: 4px; background: #333; border-radius: 2px; margin-top: 5px;">
                                <div class="progress-fill" style="height: 100%; background: #007bff; border-radius: 2px; width: 0%; transition: width 0.3s ease;"></div>
                            </div>
                        </div>
                    </div>
                    <div style="position: absolute; top: 8px; right: 8px;">
                        <button class="delete-media-btn" onclick="adminDeleteMedia(${m.id})" style="background: rgba(239,68,68,0.9); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 12px;">‚úñ</button>
                    </div>
                    <div style="padding: 8px; font-size: 12px; color: var(--text-muted);">
                        <div style="font-weight: 500;">${fileName}</div>
                        <div>${fileSize} ‚Ä¢ Video</div>
                    </div>
                </div>`;
            }
        }).join('')}
    </div>`;
    
    body.innerHTML = `<div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
        <a class="map-back-arrow" onclick="closeModal()">‚Üê</a>
        <h3 style="margin:0;">Event Media (${items.length} items)</h3>
    </div>${grid}`;
    document.getElementById('modal').style.display='flex';
}
async function adminDeleteMedia(id){ if(!confirm('Delete this media?')) return; const r=await fetch(API+'/admin/media/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mediaId:id})}); const d=await r.json(); if(r.ok&&d.ok){ alert('Deleted'); closeModal(); renderAdminMedia(); } else alert('Error: '+(d.error||'Failed')); }

let __adminEventsFilter = 'upcoming';
async function renderAdminEvents(){
    const pane = document.getElementById('admin-content'); 
    const r=await fetch(API+'/admin/events'); 
    const d=await r.json(); 
    let list=d.events||[];
    const today = new Date().toISOString().slice(0,10);
    const isPast = (e)=> String(e.date) < today;
    const isUpcoming = (e)=> String(e.date) >= today;
    list = list.filter(e => __adminEventsFilter==='past' ? isPast(e) : isUpcoming(e));
    
    pane.innerHTML = `<h3>Events Management</h3>
      <div class="sub-nav">
        <button class="sub-nav-btn ${__adminEventsFilter==='upcoming'?'active':''}" onclick="__adminEventsFilter='upcoming'; renderAdminEvents()">Upcoming</button>
        <button class="sub-nav-btn ${__adminEventsFilter==='past'?'active':''}" onclick="__adminEventsFilter='past'; renderAdminEvents()">Past</button>
      </div>
      <div style="margin-bottom: 16px;">
        <p class="muted">Total Events: ${list.length} | Showing: ${__adminEventsFilter}</p>
      </div>
      ${list.length === 0 ? '<p class="muted">No events found.</p>' : list.map(e=>{
        const startTime = new Date(`${e.date}T${e.time}`);
        const endTime = new Date(startTime.getTime() + (e.duration || 0) * 60000);
        const eventTime = new Date();
        let status = "upcoming";
        if (eventTime >= startTime && eventTime < endTime) status = "live";
        else if (eventTime >= endTime) status = "past";
        
        const statusColor = status === 'live' ? '#10b981' : status === 'past' ? '#6b7280' : '#3b82f6';
        const statusText = status === 'live' ? 'üî¥ LIVE' : status === 'past' ? '‚úÖ ENDED' : '‚è≥ UPCOMING';
        
        return `<div class="card" style="margin-bottom: 16px; padding: 16px;">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
            <div style="flex: 1; min-width: 0; margin-right: 16px;">
              <div class="category-badge" style="margin-bottom: 8px; display: inline-block;">${e.category || 'General'}</div>
              <h4 style="margin: 0 0 12px 0; color: #93c5fd; font-size: 1.1rem; word-wrap: break-word;">${capitalizeWords(e.title)}</h4>
              <div class="kv" style="margin: 0; display: grid; grid-template-columns: 80px 1fr; gap: 6px 12px;">
                <b>Date:</b> <span class="value">${e.date}</span>
                <b>Time:</b> <span class="value">${e.time}</span>
                <b>Venue:</b> <span class="value">${capitalizeWords(e.venue)}</span>
                <b>Capacity:</b> <span class="value">${e.taken || 0}/${e.capacity}</span>
                <b>Duration:</b> <span class="value">${e.duration || 0} min</span>
                <b>Status:</b> <span class="value" style="color: ${statusColor}; font-weight: bold;">${statusText}</span>
              </div>
            </div>
            <div style="display: flex; flex-direction: column; gap: 8px; min-width: 120px;">
              <button class="btn" onclick="adminOpenEventBookings(${e.id}, '${e.creatorRegNumber}')" style="font-size: 0.9rem; padding: 8px 12px; width: 100%;">üìã Bookings</button>
              <button class="btn" onclick="adminOpenVolunteers(${e.id}, '${e.title.replace(/'/g,"&#39;")}', '${e.creatorRegNumber}')" style="font-size: 0.9rem; padding: 8px 12px; width: 100%;">ü§ù Volunteers</button>
              <button class="btn" onclick="adminOpenWaitlist(${e.id}, '${e.creatorRegNumber}', '${e.title.replace(/'/g,"&#39;")}')" style="font-size: 0.9rem; padding: 8px 12px; width: 100%;">üïí Waitlist</button>
              <button class="btn" onclick="adminDeleteEventPrompt(${e.id}, '${e.title.replace(/'/g,"\'")}')" style="font-size: 0.9rem; padding: 8px 12px; width: 100%; background: #ef4444; border-color: #ef4444;">üóëÔ∏è Delete</button>
            </div>
          </div>
          <div style="border-top: 1px solid var(--border); padding-top: 12px; margin-top: 12px;">
            <div class="muted" style="font-size: 0.9rem; line-height: 1.4;">
              <div><strong>Created by:</strong> ${e.creatorRegNumber} | <strong>Event ID:</strong> ${e.id}</div>
              ${e.resources && e.resources.length > 0 ? `<div style="margin-top: 4px;"><strong>Resources:</strong> ${e.resources.join(', ')}</div>` : ''}
            </div>
          </div>
        </div>`;
      }).join('')}`;
}
async function adminOpenEvent(eventId){ const events=(await (await fetch(API+'/admin/events')).json()).events||[]; const ev=events.find(x=>x.id===Number(eventId)); const body=document.getElementById('modal-body'); if(!ev){return} body.innerHTML=`<h3>${capitalizeWords(ev.title)}</h3><div class="kv"><b>Organizer:</b> <span class="value">${ev.creatorRegNumber||'-'}</span><b>Date:</b><span class="value">${ev.date}</span><b>Time:</b><span class="value">${ev.time}</span><b>Venue:</b><span class="value">${capitalizeWords(ev.venue)}</span><b>Capacity:</b><span class="value">${ev.capacity}</span><b>Taken:</b><span class="value">${ev.taken}</span></div><div class="card-buttons" style="margin-top:8px;"><button class="btn" onclick="adminOpenEventBookings(${ev.id}, '${ev.creatorRegNumber}')">View Bookings</button><button class="btn" onclick="adminOpenVolunteers(${ev.id}, '${ev.title.replace(/'/g,"&#39;")}', '${ev.creatorRegNumber}')">ü§ù Volunteers</button><button class="btn" onclick="adminOpenWaitlist(${ev.id}, '${ev.creatorRegNumber}', '${ev.title.replace(/'/g,"&#39;")}')">üïí Waitlist</button></div>`; document.getElementById('modal').style.display='flex'; }

async function adminOpenEventBookings(eventId, creatorReg){ try{ const res = await fetch(API + '/events'); const data = await res.json(); const ev = (data.events||[]).find(e=>e.id===Number(eventId)); const modal=document.getElementById('modal'); const body=document.getElementById('modal-body'); if(!ev){ return; } let html = `<div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;"><a class="map-back-arrow" onclick="closeModal()">‚Üê</a><h3 style="margin:0;">Bookings ‚Äì ${escapeHtml(ev.title)}</h3></div>`; if(!ev.bookings || ev.bookings.length===0){ html += '<p class="muted">No bookings yet.</p>'; } else { html += "<table style='width:100%; border-collapse: collapse;'>"; html += "<tr style='background:#111'><th style='border:1px solid #333; padding:8px; text-align:left'>Seat</th><th style='border:1px solid #333; padding:8px; text-align:left'>Name</th><th style='border:1px solid #333; padding:8px; text-align:left'>Reg</th><th style='border:1px solid #333; padding:8px; text-align:left'>Role</th><th style='border:1px solid #333; padding:8px; text-align:left'>Action</th></tr>"; ev.bookings.forEach(b=>{ html += `<tr><td style='border:1px solid #333; padding:8px'>${b.seat}</td><td style='border:1px solid #333; padding:8px'>${escapeHtml(b.name||'')}</td><td style='border:1px solid #333; padding:8px'>${escapeHtml(b.regNumber)}</td><td style='border:1px solid #333; padding:8px'>${escapeHtml(b.role)}</td><td style='border:1px solid #333; padding:8px'><button class='btn' style='padding:6px 10px; width:auto; color: var(--red-accent); border-color: var(--red-accent);' onclick="adminCancelBooking(${ev.id}, '${b.regNumber}', '${creatorReg}')">Cancel</button></td></tr>`; }); html += "</table>"; } body.innerHTML = html; modal.style.display='flex'; }catch{}}
async function adminCancelBooking(eventId, targetReg, creatorReg){ if(!confirm('Cancel this ticket?')) return; try{ const r = await fetch(API + '/tickets/admin-cancel', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ eventId, targetRegNumber: targetReg, organizerRegNumber: creatorReg }) }); const d = await r.json(); if(r.ok && d.ok){ alert('Ticket cancelled.'); adminOpenEventBookings(eventId, creatorReg); renderEvents(); } else { alert('Error: ' + (d.error||'Failed')); } }catch{ alert('Network error'); } }

async function adminOpenVolunteers(eventId, title, creatorReg){ try{ const res = await fetch(`${API}/volunteers/${eventId}?organizerReg=${creatorReg}`); const data = await res.json(); const modal=document.getElementById('modal'); const body=document.getElementById('modal-body'); if(!res.ok || !data.ok){ body.innerHTML = '<p class="muted">Failed to load volunteers.</p>'; modal.style.display='flex'; return; } const list = data.volunteers||[]; const accepted = list.filter(v=>v.status==='accepted'); const pending = list.filter(v=>v.status!=='accepted'); body.innerHTML = `<div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;"><a class="map-back-arrow" onclick="closeModal()">‚Üê</a><h3 style="margin:0;">ü§ù Volunteers ‚Äì ${escapeHtml(title)}</h3></div><div class="card"><div class="kv"><b>Add Volunteer</b></div><div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;"><input id="admVolReg" placeholder="Reg Number" style="flex:1; min-width:160px;"><input id="admVolRole" placeholder="Role (e.g., Security)" style="flex:1; min-width:160px;"><button class="btn" onclick="adminAddVolunteer(${eventId}, '${creatorReg}')">Invite</button></div><div id="admVolMsg" class="muted" style="margin-top:6px;"></div></div><div class="card"><div class="muted" style="margin:4px 0;">Accepted</div>${accepted.length? accepted.map(v=>`<div class='detail-item' style='display:flex; justify-content:space-between;'><div><b>${escapeHtml(v.name||v.regNumber)}</b><div class='muted'>${escapeHtml(v.regNumber)} ‚Ä¢ ${escapeHtml(v.role||'')}</div></div><button class='btn' onclick="adminRemoveVolunteer(${eventId}, '${v.regNumber}', '${creatorReg}')">Remove</button></div>`).join('') : '<p class="muted">None</p>'}</div><div class="card"><div class="muted" style="margin:4px 0;">Pending</div>${pending.length? pending.map(v=>`<div class='detail-item'><b>${escapeHtml(v.name||v.regNumber)}</b><div class='muted'>${escapeHtml(v.regNumber)} ‚Ä¢ ${escapeHtml(v.role||'')} ‚Ä¢ ${escapeHtml(v.status)}</div></div>`).join('') : '<p class="muted">None</p>'}</div>`; modal.style.display='flex'; }catch{}}
async function adminAddVolunteer(eventId, creatorReg){ const reg = String(document.getElementById('admVolReg').value||'').trim(); const role = String(document.getElementById('admVolRole').value||'').trim(); const msg=document.getElementById('admVolMsg'); if(!reg || !role){ msg.textContent='Enter reg and role'; return; } try{ const r = await fetch(API + '/volunteers/add', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ eventId, organizerReg: creatorReg, regNumber: reg, role }) }); const d = await r.json(); if(r.ok && d.ok){ msg.textContent='Invite sent'; adminOpenVolunteers(eventId, '', creatorReg); renderEvents(); } else { msg.textContent='Error: ' + (d.error||'Failed'); } }catch{ msg.textContent='Network error'; } }
async function adminRemoveVolunteer(eventId, regNumber, creatorReg){ if(!confirm('Remove volunteer?')) return; try{ const r = await fetch(API + '/volunteers/remove', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ eventId, organizerReg: creatorReg, regNumber }) }); const d = await r.json(); if(r.ok && d.ok){ alert('Removed'); adminOpenVolunteers(eventId, '', creatorReg); renderEvents(); } else { alert('Error: ' + (d.error||'Failed')); } }catch{ alert('Network error'); } }

async function adminOpenWaitlist(eventId, creatorReg, title){ try{ const r = await fetch(`${API}/waitlist/${eventId}?organizerReg=${creatorReg}`); const d = await r.json(); const modal=document.getElementById('modal'); const body=document.getElementById('modal-body'); if(!r.ok || !d.ok){ body.innerHTML='<p class="muted">Failed to load waitlist.</p>'; modal.style.display='flex'; return; } const list = d.waitlist||[]; body.innerHTML = `<div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;"><a class="map-back-arrow" onclick="closeModal()">‚Üê</a><h3 style="margin:0;">üïí Waitlist ‚Äì ${escapeHtml(title||'')}</h3></div>${list.length? list.map(w=>`<div class='detail-item'><b>${escapeHtml(w.name||w.regNumber)}</b><div class='muted'>${escapeHtml(w.regNumber)}</div></div>`).join('') : '<p class="muted">Empty waitlist</p>'}`; modal.style.display='flex'; }catch{}}
function adminDeleteEventPrompt(id, title){ const body=document.getElementById('modal-body'); body.innerHTML=`<h3>Delete Event</h3><div class="muted">${title}</div><textarea id="adminReason" placeholder="Reason (optional)" style="width:100%;height:90px;margin-top:8px;"></textarea><div style="display:flex;gap:8px;margin-top:10px;"><button class="btn" onclick="adminDeleteEvent(${id})">Send</button><button class="btn" onclick="closeModal()">Cancel</button></div>`; document.getElementById('modal').style.display='flex'; }
async function adminDeleteEvent(id){ const reason=document.getElementById('adminReason').value||''; const r=await fetch(API+'/admin/events/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({eventId:id, reason})}); const d=await r.json(); if(r.ok&&d.ok){ alert('Event deleted'); closeModal(); renderAdminEvents(); } else alert('Error: '+(d.error||'Failed')); }

async function renderAdminVerify(){
  const pane = document.getElementById('admin-content');
  try {
    const res = await fetch(API + '/admin/organizers/pending');
    const data = await res.json();
    if (res.ok && data.ok) {
      const users = data.users || [];
      pane.innerHTML = `
        <h3>Pending Organizer Requests</h3>
        ${users.length === 0 ? '<p class="muted">No pending requests</p>' : ''}
        ${users.map(u => `
          <div class="card" onclick="showPendingUserDetails('${u.regNumber}')">
            <div class="kv">
              <b>Name:</b> <span class="value">${u.name} ${u.surname || ''}</span>
            </div>
            <div class="kv">
              <b>Reg:</b> <span class="value">${u.regNumber}</span>
            </div>
            <div class="kv">
              <b>Email:</b> <span class="value">${u.email}</span>
            </div>
            <div class="kv">
              <b>Phone:</b> <span class="value">${u.phone}</span>
            </div>
            <div class="card-buttons">
              <button class="btn primary" onclick="event.stopPropagation(); adminApproveOrganizer('${u.regNumber}')">Approve</button>
              <button class="btn" onclick="event.stopPropagation(); adminRejectOrganizer('${u.regNumber}')">Reject</button>
            </div>
          </div>
        `).join('')}
      `;
    } else {
      pane.innerHTML = '<p class="muted">Error loading pending requests</p>';
    }
  } catch (e) {
    pane.innerHTML = '<p class="muted">Error loading pending requests</p>';
  }
}

function showPendingUserDetails(regNumber) {
  (async()=>{
    try{
      const res = await fetch(API + '/users/' + regNumber);
      const data = await res.json();
      const body = document.getElementById('modal-body');
      if(!res.ok || !data.ok){ body.innerHTML = '<p class="muted">Failed to load details.</p>'; document.getElementById('modal').style.display='flex'; return; }
      const u = data.user||{};
      body.innerHTML = `
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;"><a class="map-back-arrow" onclick="closeModal()">‚Üê</a><h3 style="margin:0;">User Details</h3></div>
        <div class="kv"><b>Name:</b> <span class="value">${escapeHtml((u.name||'') + ' ' + (u.surname||''))}</span><b>Reg:</b> <span class="value">${escapeHtml(u.regNumber||'')}</span><b>Role:</b> <span class="value">${escapeHtml(u.role||'')}</span></div>
        <div class="kv"><b>Email:</b> <span class="value">${escapeHtml(u.email||'')}</span><b>Phone:</b> <span class="value">${escapeHtml(u.phone||'')}</span><b>Gender:</b> <span class="value">${escapeHtml(u.gender||'')}</span></div>
        <div class="kv"><b>Age:</b> <span class="value">${escapeHtml(u.age||'')}</span><b>Department:</b> <span class="value">${escapeHtml(u.department||'-')}</span><b>Branch:</b> <span class="value">${escapeHtml(u.branch||'-')}</span></div>
        <div class="kv"><b>Address:</b> <span class="value">${escapeHtml(u.address||'-')}</span><b>Pincode:</b> <span class="value">${escapeHtml(u.pincode||'-')}</span><b>Blood:</b> <span class="value">${escapeHtml(u.bloodGroup||'-')}</span></div>
        <div style="display:flex; gap:8px; margin-top:12px;">
          <button class="btn primary" onclick="adminApproveOrganizer('${regNumber}')">Approve</button>
          <button class="btn" onclick="adminRejectOrganizer('${regNumber}')">Reject</button>
        </div>`;
      document.getElementById('modal').style.display='flex';
    }catch{ const body=document.getElementById('modal-body'); body.innerHTML='<p class="muted">Failed to load details.</p>'; document.getElementById('modal').style.display='flex'; }
  })();
}

async function adminApproveOrganizer(regNumber) {
  if (!confirm('Approve this organizer request?')) return;
  try {
    const res = await fetch(API + '/admin/organizers/verify', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ regNumber, decision: 'approve' })
    });
    const data = await res.json();
    if (res.ok && data.ok) {
      alert('Organizer approved');
      renderAdminVerify();
    } else {
      alert('Error: ' + (data.error || 'Failed'));
    }
  } catch (e) {
    alert('Network error');
  }
}

async function adminRejectOrganizer(regNumber) {
  const reason = prompt('Reason for rejection (optional):');
  if (reason === null) return; // User cancelled
  try {
    const res = await fetch(API + '/admin/organizers/verify', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ regNumber, decision: 'reject', reason })
    });
    const data = await res.json();
    if (res.ok && data.ok) {
      alert('Organizer rejected');
      renderAdminVerify();
    } else {
      alert('Error: ' + (data.error || 'Failed'));
    }
  } catch (e) {
    alert('Network error');
  }
}

function renderAdminYou(){ 
    const pane=document.getElementById('admin-content'); 
    pane.innerHTML=`<h3>üîß Admin Settings & Analysis</h3>
    
    <div class="card" style="margin-bottom: 20px;">
        <h4>üîê Change Admin Credentials</h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
            <div>
                <label style="display: block; margin-bottom: 4px; font-weight: 500;">New Username</label>
                <input id="admUser" placeholder="Enter new username" style="width: 100%;">
      </div>
            <div>
                <label style="display: block; margin-bottom: 4px; font-weight: 500;">New Password</label>
                <div class="password-wrapper" style="position: relative;">
                    <input id="admPass" type="password" placeholder="Enter new password" style="width: 100%; padding-right: 40px;">
                    <span class="password-toggle" onclick="togglePasswordVisibility('admPass')" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); cursor: pointer;">üëÅÔ∏è</span>
      </div>
    </div>
        </div>
        <div style="display: flex; gap: 12px;">
            <button class="btn" onclick="adminSaveCreds()" style="background: #10b981; border-color: #10b981;">üíæ Save Credentials</button>
            <button class="btn" onclick="adminClearFields()" style="background: #6b7280; border-color: #6b7280;">üóëÔ∏è Clear Fields</button>
        </div>
        <div class="muted" style="margin-top: 8px; font-size: 0.9rem;">
            ‚ö†Ô∏è Changing credentials will require you to log in again with the new details.
        </div>
    </div>
    
    <div class="card" style="margin-bottom: 20px;">
        <h4>üìä System Analysis</h4>
        <div style="display: flex; gap: 12px; margin-bottom: 16px;">
            <button class="btn" onclick="adminLoadStats()" style="background: #3b82f6; border-color: #3b82f6;">üìà Load Analysis</button>
        </div>
        <div id="adminStats" class="muted" style="margin-top: 8px; padding: 12px; background: var(--card-bg); border-radius: 6px; border: 1px solid var(--border);">
            Click "Load Analysis" to see system statistics
        </div>
    </div>
    
    <div class="card" style="border-color: #ef4444;">
        <h4 style="color: #ef4444;">‚ö†Ô∏è Danger Zone</h4>
        <div style="margin-bottom: 12px;">
            <p class="muted" style="margin-bottom: 8px;">This will permanently delete ALL data including:</p>
            <ul style="margin: 0; padding-left: 20px; color: var(--text-muted);">
                <li>All user accounts (students & organizers)</li>
                <li>All events and bookings</li>
                <li>All media files</li>
                <li>All notifications and messages</li>
            </ul>
        </div>
        <button class="btn" onclick="adminClearAll()" style="background: #ef4444; border-color: #ef4444;">üóëÔ∏è Clear All Data</button>
    </div>`; 
}
async function adminSaveCreds(){ 
    const username = document.getElementById('admUser').value.trim();
    const password = document.getElementById('admPass').value.trim();
    
    if (!username || !password) {
        alert('‚ùå Please enter both username and password');
        return;
    }
    
    if (username.length < 3) {
        alert('‚ùå Username must be at least 3 characters long');
        return;
    }
    
    if (password.length < 6) {
        alert('‚ùå Password must be at least 6 characters long');
        return;
    }
    
    const confirmMsg = `Are you sure you want to change admin credentials?\n\nNew Username: ${username}\n\n‚ö†Ô∏è You will need to log in again with these new credentials.`;
    if (!confirm(confirmMsg)) return;
    
    try {
        const r = await fetch(API+'/admin/credentials', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({username, password})
        });
        const d = await r.json();
        
        if (r.ok && d.ok) {
            alert('‚úÖ Admin credentials updated successfully!\n\nYou will be logged out and need to log in again.');
            adminClearFields();
            adminLogout();
        } else {
            alert('‚ùå Error: ' + (d.error || 'Failed to update credentials'));
        }
    } catch (err) {
        alert('‚ùå Network error: ' + err.message);
    }
}

function adminClearFields() {
    document.getElementById('admUser').value = '';
    document.getElementById('admPass').value = '';
}

async function adminClearAll(){ 
    const confirmMsg = `‚ö†Ô∏è DANGER: This will PERMANENTLY DELETE ALL DATA!\n\nThis includes:\n‚Ä¢ All user accounts (students & organizers)\n‚Ä¢ All events and bookings\n‚Ä¢ All media files\n‚Ä¢ All notifications and messages\n\nThis action CANNOT be undone!\n\nType "DELETE ALL" to confirm:`;
    
    const userInput = prompt(confirmMsg);
    if (userInput !== "DELETE ALL") {
        alert('‚ùå Operation cancelled. You must type "DELETE ALL" exactly to confirm.');
        return;
    }
    
    const finalConfirm = confirm('üö® FINAL CONFIRMATION üö®\n\nYou are about to PERMANENTLY DELETE ALL DATA!\n\nThis will:\n‚Ä¢ Delete ALL users, events, media, bookings\n‚Ä¢ Cannot be undone\n‚Ä¢ Will require manual data restoration\n\nAre you absolutely sure?');
    if (!finalConfirm) return;
    
    try {
        const r = await fetch(API+'/admin/clear-all', {method: 'POST'});
        const d = await r.json();
        
        if (r.ok && d.ok) {
            alert('‚úÖ All data has been cleared successfully!');
            setAdminTab('users');
            renderAdminUsers('students');
        } else {
            alert('‚ùå Error: ' + (d.error || 'Failed to clear data'));
        }
    } catch (err) {
        alert('‚ùå Network error: ' + err.message);
    }
}

async function adminLoadStats(){ 
    try {
        document.getElementById('adminStats').innerHTML = '<div style="text-align: center; padding: 20px;">üîÑ Loading analysis...</div>';
        
        const r = await fetch(API+'/admin/stats');
        const d = await r.json();
        
        if (r.ok && d.ok) {
            const statsHtml = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                    <div style="text-align: center; padding: 12px; background: var(--card-bg); border-radius: 6px; border: 1px solid var(--border);">
                        <div style="font-size: 24px; font-weight: bold; color: #3b82f6;">${d.totalUsers}</div>
                        <div style="font-size: 12px; color: var(--text-muted);">Total Users</div>
                    </div>
                    <div style="text-align: center; padding: 12px; background: var(--card-bg); border-radius: 6px; border: 1px solid var(--border);">
                        <div style="font-size: 24px; font-weight: bold; color: #10b981;">${d.totalOrganizers}</div>
                        <div style="font-size: 12px; color: var(--text-muted);">Organizers</div>
                    </div>
                    <div style="text-align: center; padding: 12px; background: var(--card-bg); border-radius: 6px; border: 1px solid var(--border);">
                        <div style="font-size: 24px; font-weight: bold; color: #f59e0b;">${d.totalEvents}</div>
                        <div style="font-size: 12px; color: var(--text-muted);">Events</div>
                    </div>
                    <div style="text-align: center; padding: 12px; background: var(--card-bg); border-radius: 6px; border: 1px solid var(--border);">
                        <div style="font-size: 24px; font-weight: bold; color: #8b5cf6;">${d.activeUsers}</div>
                        <div style="font-size: 12px; color: var(--text-muted);">Active (5m)</div>
                    </div>
                </div>
                <div style="margin-top: 12px; padding: 8px; background: var(--card-bg); border-radius: 4px; font-size: 12px; color: var(--text-muted);">
                    üìä Last updated: ${new Date().toLocaleString()}
                </div>
            `;
            document.getElementById('adminStats').innerHTML = statsHtml;
        } else {
            document.getElementById('adminStats').innerHTML = '<div style="color: #ef4444;">‚ùå Failed to load statistics</div>';
        }
    } catch (err) {
        document.getElementById('adminStats').innerHTML = '<div style="color: #ef4444;">‚ùå Network error: ' + err.message + '</div>';
    }
}

// Removed: adminExportData function - export data feature removed from admin panel

// ---------- Debug & Data Management ----------
async function checkBackendStatus() {
    try {
        const res = await fetch(API + '/data/status');
        const data = await res.json();
        if (data.ok) {
            console.log('üìä Backend Status:', data.stats);
            return data.stats;
        }
    } catch (err) {
        console.error('‚ùå Backend status check failed:', err);
    }
    return null;
}

async function checkDataIntegrity() {
    try {
        const res = await fetch(API + '/data/integrity');
        const data = await res.json();
        if (data.ok) {
            console.log('üîç Data Integrity:', data.integrity);
            return data.integrity;
        }
    } catch (err) {
        console.error('‚ùå Data integrity check failed:', err);
    }
    return null;
}

// Removed: exportData function - export data feature removed

async function importData() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        try {
            const text = await file.text();
            const data = JSON.parse(text);
            const res = await fetch(API + '/data/import', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: text
            });
            const result = await res.json();
            if (result.ok) {
                alert('‚úÖ Data imported successfully! ' + result.message);
                location.reload();
            } else {
                alert('‚ùå Import failed: ' + result.error);
            }
        } catch (err) {
            alert('‚ùå Invalid file: ' + err.message);
        }
    };
    input.click();
}

async function renderAdminDebug() {
    const pane = document.getElementById('admin-content');
    
    // Fetch live backend stats
    let backendStats = null;
    let dataIntegrity = null;
    let persistenceInfo = null;
    
    try {
        const statsRes = await fetch(API + '/data/status');
        const statsData = await statsRes.json();
        if (statsData.ok) backendStats = statsData.stats;
        
        const integrityRes = await fetch(API + '/data/integrity');
        const integrityData = await integrityRes.json();
        if (integrityData.ok) dataIntegrity = integrityData.integrity;
        
        const persistenceRes = await fetch(API + '/data/persistence');
        const persistenceData = await persistenceRes.json();
        if (persistenceData.ok) persistenceInfo = persistenceData.persistence;
    } catch (err) {
        console.error('Failed to fetch debug data:', err);
    }
    
    pane.innerHTML = `
        <h3>üîß Debug & Data Management</h3>
        
        <div class="card" style="margin-bottom: 20px;">
            <h4>üìä Live Backend Statistics</h4>
            <div class="kv">
                <b>API Base:</b> <span class="value">${API_BASE}</span>
                <b>Current User:</b> <span class="value">${currentUser ? currentUser.regNumber : 'Not logged in'}</span>
            </div>
            ${backendStats ? `
            <div class="kv">
                <b>Total Users:</b> <span class="value">${backendStats.users}</span>
                <b>Total Events:</b> <span class="value">${backendStats.events}</span>
                <b>Total Media:</b> <span class="value">${backendStats.media}</span>
                <b>Total Messages:</b> <span class="value">${backendStats.messages}</span>
                <b>Notifications:</b> <span class="value">${backendStats.notifications}</span>
            </div>
            <div class="kv">
                <b>Data File:</b> <span class="value">${backendStats.dataFileExists ? '‚úÖ Exists' : '‚ùå Missing'}</span>
                <b>Backups:</b> <span class="value">${backendStats.backupCount}</span>
                <b>Last Modified:</b> <span class="value">${backendStats.lastModified ? new Date(backendStats.lastModified).toLocaleString() : 'Unknown'}</span>
            </div>
            ` : '<p class="muted">‚ùå Unable to fetch backend stats</p>'}
        </div>
        
        ${dataIntegrity ? `
        <div class="card" style="margin-bottom: 20px;">
            <h4>üîç Data Integrity Check</h4>
            <div style="color: ${dataIntegrity.isHealthy ? '#10b981' : '#ef4444'}; font-weight: bold; margin-bottom: 10px;">
                ${dataIntegrity.isHealthy ? '‚úÖ Data is healthy' : '‚ùå Data issues detected'}
            </div>
            ${dataIntegrity.issues.length > 0 ? `
            <div style="margin-bottom: 10px;">
                <b>Issues Found:</b>
                <ul style="margin: 5px 0; padding-left: 20px;">
                    ${dataIntegrity.issues.map(issue => `<li style="color: #ef4444;">${issue}</li>`).join('')}
                </ul>
            </div>
            ` : ''}
            <div class="kv">
                <b>Users:</b> <span class="value">${dataIntegrity.stats.users}</span>
                <b>Events:</b> <span class="value">${dataIntegrity.stats.events}</span>
                <b>Media:</b> <span class="value">${dataIntegrity.stats.media}</span>
                <b>Messages:</b> <span class="value">${dataIntegrity.stats.messages}</span>
                <b>Notifications:</b> <span class="value">${dataIntegrity.stats.notifications}</span>
            </div>
        </div>
        ` : ''}
        
        ${persistenceInfo ? `
        <div class="card" style="margin-bottom: 20px;">
            <h4>üíæ MongoDB Atlas Storage</h4>
            <div style="color: #10b981; font-weight: bold; margin-bottom: 10px;">
                ‚úÖ Data stored in MongoDB Atlas (permanent)
            </div>
            <div class="kv">
                <b>Storage Type:</b> <span class="value">MongoDB Atlas + Cloudinary</span>
                <b>Data Persistence:</b> <span class="value">‚úÖ Permanent (survives restarts)</span>
                <b>Media Storage:</b> <span class="value">‚úÖ Cloudinary (cloud CDN)</span>
            </div>
            <div class="kv">
                <b>Live Data Counts:</b>
                <span class="value">Users: ${persistenceInfo.dataCounts.users} | Events: ${persistenceInfo.dataCounts.events} | Media: ${persistenceInfo.dataCounts.media} | Messages: ${persistenceInfo.dataCounts.messages}</span>
            </div>
            <div class="muted" style="font-size: 0.9rem; margin-top: 8px;">
                Last checked: ${new Date(persistenceInfo.timestamp).toLocaleString()}
            </div>
        </div>
        ` : ''}
        
        <div class="card" style="margin-bottom: 20px;">
            <h4>üõ†Ô∏è Debug Actions</h4>
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                <button class="btn" onclick="checkBackendStatus().then(s => alert('Status: ' + JSON.stringify(s, null, 2)))">üìä Refresh Status</button>
                <button class="btn" onclick="checkDataIntegrity().then(i => alert('Integrity: ' + JSON.stringify(i, null, 2)))">üîç Check Integrity</button>
            </div>
        </div>
    `;
}
</script>
<script>
function escapeHtml(s){
    s = String(s == null ? '' : s);
    return s
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
}
</script>
<script>
// Initialize app when page loads
function initializeApp() {
    try {
        console.log("üöÄ Initializing Campus Event Hub...");
        
        // Start keep-alive immediately on page load
        startKeepAlive();
        
        // Ensure API_BASE is defined
        if (typeof API_BASE === 'undefined') {
            console.error("‚ùå API_BASE not defined, retrying in 100ms...");
            setTimeout(initializeApp, 100);
            return;
        }
        
        // Ensure required functions are defined
        if (typeof showLogin === 'undefined' || typeof loadUserSession === 'undefined' || typeof renderTabs === 'undefined') {
            console.error("‚ùå Required functions not defined, retrying in 100ms...");
            setTimeout(initializeApp, 100);
            return;
        }
        
        // Check if user is already logged in
        const savedUser = loadUserSession();
        if (savedUser) {
            console.log("üë§ Found saved user session:", savedUser.regNumber);
            currentUser = savedUser;
            renderTabs();
            showTab("home");
            // Start background processes
            try { pollNotifications(); } catch {}
            try { notificationInterval = setInterval(pollNotifications, 5000); } catch {}
            try { eventStateInterval = setInterval(checkEventStates, 30000); } catch {}
            try { startLiveUpdates(); } catch {}
        } else {
            console.log("üîê No saved session, showing login");
            showLogin();
        }
    } catch (error) {
        console.error("‚ùå App initialization failed:", error);
        // Fallback to showing login screen
        try {
            showLogin();
        } catch (fallbackError) {
            console.error("‚ùå Even fallback failed:", fallbackError);
            // Last resort - show basic message
            document.body.innerHTML = '<div style="padding: 20px; text-align: center;"><h2>App Loading Error</h2><p>Please refresh the page or check console for details.</p></div>';
        }
    }
}

// Run initialization when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeApp);
} else {
    initializeApp();
}

// Center toast for short messages
function showCenterToast(text){
    try{
        const phone = document.querySelector('.phone') || document.body;
        let toast = document.getElementById('centerToast');
        if(!toast){
            toast = document.createElement('div'); toast.id='centerToast';
            toast.style.position='absolute'; toast.style.top='50%'; toast.style.left='50%'; toast.style.transform='translate(-50%, -50%)';
            toast.style.background='rgba(0,0,0,0.85)'; toast.style.color='#fff'; toast.style.padding='12px 16px'; toast.style.borderRadius='10px'; toast.style.zIndex='200'; toast.style.maxWidth='80%'; toast.style.textAlign='center';
            phone.appendChild(toast);
        }
        toast.textContent = text;
        toast.style.display='block';
        setTimeout(()=>{ toast.style.display='none'; }, 2000);
    }catch{}
}
</script>
</body>
</html>